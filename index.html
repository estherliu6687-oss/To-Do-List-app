<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS - 混合云同步版 (Pro)</title>
    
    <!-- iOS Web App 适配 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LifeOS">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: 加载 React 和 Firebase -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <style>
        /* 全局样式修正 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* 动画关键帧 */
        @keyframes grow { from { stroke-dasharray: 0 100; } to { stroke-dasharray: 100 0; } }
        @keyframes drop { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(60px); opacity: 0; } }
        /* 移动端优化 */
        input, textarea { font-size: 16px !important; } /* 防止iOS缩放 */
    </style>
</head>
<body class="bg-[#F5F7FA]">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "firebase/firestore";
        import { 
            ChevronLeft, ChevronRight, Bell, PenLine, LayoutGrid, CheckCircle2, Circle,
            Plus, RefreshCcw, Zap, Coffee, Moon, X, Trash2, Save, Sun, Briefcase,
            BookOpen, Dumbbell, Music, Settings2, Edit3, Clock, Repeat, RotateCcw,
            StickyNote, Play, Pause, Timer, PieChart, BarChart3, Calendar as CalendarIcon,
            Target, Heart, TrendingUp, ListTodo, Sparkles, Check, Download, Palette,
            Layout, PanelTop, Shuffle, Cloud, Loader2, LogIn, LogOut, User, Lock, Mail, AlertCircle, HardDrive, Upload, MoreHorizontal
        } from 'lucide-react';

        // --- Utilities ---
        const generateDateString = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };
        const getDayName = (dayIndex) => ['日', '一', '二', '三', '四', '五', '六'][dayIndex];
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };
        const getWeekRange = (date) => {
            const day = date.getDay(); 
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const start = new Date(date);
            start.setDate(diff);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            return { start, end };
        };
        const getReviewId = (period, date) => {
            if (period === 'daily') return generateDateString(date);
            if (period === 'weekly') { const { start } = getWeekRange(date); return `W_${start.getFullYear()}_${getWeekNumber(start)}`; }
            if (period === 'monthly') return `M_${date.getFullYear()}_${date.getMonth() + 1}`;
            if (period === 'yearly') return `Y_${date.getFullYear()}`;
            return '';
        };
        const getPeriodLabel = (period, date) => {
            if (period === 'daily') return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
            if (period === 'weekly') { const { start, end } = getWeekRange(date); return `${start.getFullYear()}年 第${getWeekNumber(start)}周 (${start.getMonth()+1}.${start.getDate()}-${end.getMonth()+1}.${end.getDate()})`; }
            if (period === 'monthly') return `${date.getFullYear()}年 ${date.getMonth()+1}月`;
            if (period === 'yearly') return `${date.getFullYear()}年`;
            return '';
        };
        const generateCalendarDates = (baseDate = new Date()) => {
            const { start } = getWeekRange(baseDate);
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                dates.push({ fullDate: generateDateString(d), dayName: getDayName(d.getDay()), dateNum: d.getDate(), obj: d });
            }
            return dates;
        };
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };
        const parseDurationFromTimeStr = (timeStr) => {
            if (!timeStr || typeof timeStr !== 'string') return 30; 
            const matches = timeStr.match(/(\d{1,2})[:：](\d{2})/g);
            if (matches && matches.length >= 2) {
                const [h1, m1] = matches[0].split(/[:：]/).map(Number);
                const [h2, m2] = matches[1].split(/[:：]/).map(Number);
                let startMins = h1 * 60 + m1;
                let endMins = h2 * 60 + m2;
                if (endMins < startMins) endMins += 24 * 60; 
                return Math.max(15, endMins - startMins); 
            }
            return 30; 
        };
        const downloadICS = (tasks, dateStr, title) => {
            if (!tasks || tasks.length === 0) { alert("没有可导出的任务"); return; }
            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//LifeOS//Task Manager//CN\n";
            tasks.forEach(task => {
                if (!task.time) return; 
                const matches = task.time.match(/(\d{1,2})[:：](\d{2})/g);
                if (!matches || matches.length < 2) return;
                const [sH, sM] = matches[0].split(/[:：]/).map(s => s.padStart(2, '0'));
                const [eH, eM] = matches[1].split(/[:：]/).map(s => s.padStart(2, '0'));
                const dateClean = dateStr.replace(/-/g, '');
                icsContent += `BEGIN:VEVENT\nSUMMARY:${task.title}\nDTSTART:${dateClean}T${sH}${sM}00\nDTEND:${dateClean}T${eH}${eM}00\nDESCRIPTION:${task.note || ''}\nEND:VEVENT\n`;
            });
            icsContent += "END:VCALENDAR";
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a'); link.href = window.URL.createObjectURL(blob); link.setAttribute('download', `${title}_${dateStr}.ics`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        
        // 时间解析辅助函数
        const getMinutes = (timeStr) => {
            if (!timeStr) return -1;
            const startStr = timeStr.split('-')[0]; 
            const [h, m] = startStr.split(/[:：]/).map(Number);
            if (isNaN(h) || isNaN(m)) return -1;
            return h * 60 + m;
        };

        const getEndMinutes = (timeStr) => {
            if (!timeStr || !timeStr.includes('-')) return -1;
            const endStr = timeStr.split('-')[1];
            const [h, m] = endStr.split(/[:：]/).map(Number);
            if (isNaN(h) || isNaN(m)) return -1;
            return h * 60 + m;
        };

        const timeToMins = (timeStr) => {
            if (!timeStr) return -1;
            const [h, m] = timeStr.trim().split(/[:：]/).map(Number);
            if (isNaN(h) || isNaN(m)) return -1;
            return h * 60 + m;
        };

        const confirmActionTime = (plannedTime, actionLabel) => {
            const now = new Date();
            const currentHHMM = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const displayPlan = plannedTime ? plannedTime.trim() : '未设置';
            
            const promptText = `确认${actionLabel}时间：
1 - 按原计划（${displayPlan}）
2 - 按现在时间（${currentHHMM}）
3 - 手动输入（如 14:30）

请输入选项数字或具体时间：`;

            const input = window.prompt(promptText, "2"); 
            
            if (input === null) return null; 
            
            const val = input.trim();
            if (val === '1') return plannedTime || currentHHMM; 
            if (val === '2') return currentHHMM;
            return val; 
        };

        // --- Constants ---
        const GROWTH_QUOTES = ["每一次相遇，都可以用5天时间慢慢认识对方。", "星光不问赶路人，时光不负有心人。", "不是‘我不行’，而是‘我暂时还不行’。", "拥抱挑战，那是成长的信号。", "天赋决定下限，努力决定上限。", "允许自己休息，但别忘了重新出发。", "今天比昨天进步一点点，就是胜利。", "把困难当作打怪升级，经验值正在疯涨。", "专注当下，未来自会呈现。"];
        const INITIAL_SECTIONS = [{ id: 'main', title: '今日日程', icon: 'ListTodo', color: 'blue' }];
        const TODAY_STR = generateDateString(new Date());
        const INITIAL_TASKS_BY_DATE = { [TODAY_STR]: { main: [{ id: 1, time: '08:00-08:30', title: '晨间习惯 (喝水/拉伸)', completed: false, important: true, urgent: true, tag: '生活', note: '' }, { id: 3, time: '14:00-16:00', title: '核心任务处理', completed: false, important: true, urgent: false, tag: '工作', note: '' }, { id: 5, time: '20:00-21:00', title: '复盘与明日计划', completed: false, important: true, urgent: true, tag: '生活', note: '' }], fragmentary: [] } };
        const ICON_MAP = { Sun, Coffee, Moon, Zap, Briefcase, BookOpen, Dumbbell, Music, ListTodo };
        const PALETTE = { white: { label: '纯净白', bg: 'bg-white', text: 'text-slate-800' }, gray: { label: '极简灰', bg: 'bg-slate-50', text: 'text-slate-800' }, rose: { label: '玫瑰', bg: 'bg-rose-50', text: 'text-rose-900' }, butter: { label: '黄油', bg: 'bg-amber-50', text: 'text-amber-900' }, latte: { label: '拿铁', bg: 'bg-stone-50', text: 'text-stone-800' }, elf: { label: '精灵', bg: 'bg-lime-50', text: 'text-lime-900' }, ocean: { label: '海盐', bg: 'bg-sky-50', text: 'text-sky-900' }, taro: { label: '香芋', bg: 'bg-purple-50', text: 'text-purple-900' }, morandi: { label: '莫兰迪', bg: 'bg-slate-100', text: 'text-slate-800' }, wheat: { label: '小麦', bg: 'bg-yellow-50', text: 'text-yellow-900' }, mint: { label: '薄荷', bg: 'bg-green-50', text: 'text-green-900' }, };
        const COLOR_THEMES = { orange: { label: '活力橙', bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-200', icon: 'text-orange-500', preview: 'bg-orange-400', cardBg: 'bg-orange-50' }, yellow: { label: '明亮黄', bg: 'bg-yellow-50', text: 'text-yellow-600', border: 'border-yellow-200', icon: 'text-yellow-500', preview: 'bg-yellow-400', cardBg: 'bg-yellow-50' }, indigo: { label: '深邃靛', bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-200', icon: 'text-indigo-500', preview: 'bg-indigo-400', cardBg: 'bg-indigo-50' }, blue: { label: '天空蓝', bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-200', icon: 'text-blue-500', preview: 'bg-blue-400', cardBg: 'bg-blue-50' }, green: { label: '自然绿', bg: 'bg-green-50', text: 'text-green-600', border: 'border-green-200', icon: 'text-green-500', preview: 'bg-green-400', cardBg: 'bg-green-50' }, purple: { label: '神秘紫', bg: 'bg-purple-50', text: 'text-purple-600', border: 'border-purple-200', icon: 'text-purple-500', preview: 'bg-purple-400', cardBg: 'bg-purple-50' }, red: { label: '热情红', bg: 'bg-red-50', text: 'text-red-600', border: 'border-red-200', icon: 'text-red-500', preview: 'bg-red-400', cardBg: 'bg-red-50' }, rose: { label: '玫瑰', bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-200', icon: 'text-rose-500', preview: 'bg-rose-400', cardBg: 'bg-rose-50' }, butter: { label: '黄油', bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-200', icon: 'text-amber-500', preview: 'bg-amber-400', cardBg: 'bg-amber-50' }, latte: { label: '拿铁', bg: 'bg-stone-50', text: 'text-stone-600', border: 'border-stone-200', icon: 'text-stone-500', preview: 'bg-stone-400', cardBg: 'bg-stone-50' }, elf: { label: '精灵', bg: 'bg-lime-50', text: 'text-lime-600', border: 'border-lime-200', icon: 'text-lime-500', preview: 'bg-lime-400', cardBg: 'bg-lime-50' }, ocean: { label: '海盐', bg: 'bg-sky-50', text: 'text-sky-600', border: 'border-sky-200', icon: 'text-sky-500', preview: 'bg-sky-400', cardBg: 'bg-sky-50' }, taro: { label: '香芋', bg: 'bg-fuchsia-50', text: 'text-fuchsia-600', border: 'border-fuchsia-200', icon: 'text-fuchsia-500', preview: 'bg-fuchsia-400', cardBg: 'bg-fuchsia-50' }, morandi: { label: '莫兰迪', bg: 'bg-slate-100', text: 'text-slate-600', border: 'border-slate-300', icon: 'text-slate-500', preview: 'bg-slate-400', cardBg: 'bg-slate-100' }, };

        // --- Components ---
        const Modal = ({ isOpen, onClose, title, children, fullScreen = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] flex items-center justify-center p-4" onClick={(e) => e.stopPropagation()}>
                    <div className={`bg-white rounded-2xl shadow-xl w-full ${fullScreen ? 'max-w-2xl h-[85vh]' : 'max-w-md max-h-[85vh]'} overflow-hidden animate-in fade-in zoom-in duration-200 flex flex-col`}>
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 flex-shrink-0">
                            <h3 className="font-bold text-gray-800 flex items-center gap-2">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full transition"><X className="w-5 h-5 text-gray-500" /></button>
                        </div>
                        <div className={`p-0 overflow-y-auto custom-scrollbar flex-1 bg-[#F9FAFB]`}>{children}</div>
                    </div>
                </div>
            );
        };

        const TimeRangePicker = ({ value, onChange }) => {
            const parseInitial = useMemo(() => {
                const matches = (value || '').match(/(\d{1,2})[:：](\d{2})/g);
                let sH = '09', sM = '00', eH = '10', eM = '00';
                if (matches && matches.length > 0) {
                    [sH, sM] = matches[0].split(/[:：]/).map(s => s.padStart(2,'0'));
                    if (matches.length > 1) { [eH, eM] = matches[1].split(/[:：]/).map(s => s.padStart(2,'0')); } 
                    else { let h = parseInt(sH), m = parseInt(sM) + 30; if (m >= 60) { h = (h + 1) % 24; m -= 60; } eH = String(h).padStart(2,'0'); eM = String(m).padStart(2,'0'); }
                }
                return { start: `${sH}:${sM}`, end: `${eH}:${eM}` };
            }, [value]); 
            const [times, setTimes] = useState(parseInitial);
            useEffect(() => { const newVal = `${times.start}-${times.end}`; if (newVal !== value) onChange(newVal); }, [times]);
            return (<div className="flex items-center gap-2"><div className="flex-1 bg-white border border-gray-200 rounded-xl px-2 py-2 shadow-sm focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all"><input type="time" value={times.start} onChange={(e) => setTimes(p => ({ ...p, start: e.target.value || p.start }))} className="w-full bg-transparent text-center font-bold text-gray-700 outline-none text-sm" required /></div><span className="text-gray-400 font-bold">-</span><div className="flex-1 bg-white border border-gray-200 rounded-xl px-2 py-2 shadow-sm focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all"><input type="time" value={times.end} onChange={(e) => setTimes(p => ({ ...p, end: e.target.value || p.end }))} className="w-full bg-transparent text-center font-bold text-gray-700 outline-none text-sm" required /></div></div>);
        };

        const WateringAnimation = () => (<div className="relative w-full h-64 flex items-center justify-center bg-white/50 rounded-xl"><svg viewBox="0 0 300 200" className="w-full h-full max-w-sm"><path d="M40 160 L260 160" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><g transform="translate(180, 115)"><path d="M10 45 L15 15 L45 15 L50 45 Q30 50 10 45 Z" fill="none" stroke="#334155" strokeWidth="2" strokeLinejoin="round" /><path d="M15 15 Q30 10 45 15" fill="none" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><g className="origin-bottom animate-[grow_2s_ease-out_forwards]" style={{transformBox: 'fill-box', transformOrigin: 'bottom center'}}><path d="M30 15 Q30 5 30 -5" stroke="#a3e635" strokeWidth="3" strokeLinecap="round" /><path d="M30 -5 Q20 -15 15 -5 Q25 5 30 -5" fill="#a3e635" /><path d="M30 -5 Q40 -15 45 -5 Q35 5 30 -5" fill="#a3e635" /></g></g><g transform="translate(60, 50) rotate(-10)"><path d="M20 40 C-10 30 -10 90 20 80" fill="none" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M80 50 L130 40 L135 60 L80 80" fill="#fca5a5" stroke="none" /><path d="M80 50 L130 40" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M80 80 L135 60" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M20 30 L80 30 L85 100 L15 100 Q10 65 20 30 Z" fill="#fca5a5" stroke="#334155" strokeWidth="2" strokeLinejoin="round" /><path d="M30 40 Q40 30 50 50 T70 60 T40 80" fill="none" stroke="#f472b6" strokeWidth="2" opacity="0.6" /><path d="M35 60 Q50 70 65 50" fill="none" stroke="#f472b6" strokeWidth="2" opacity="0.6" /><g transform="translate(135, 50)"><line x1="5" y1="0" x2="20" y2="-5" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><line x1="5" y1="10" x2="20" y2="15" stroke="#334155" strokeWidth="2" strokeLinecap="round" /></g></g><g><circle cx="200" cy="90" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite]" /><circle cx="210" cy="100" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite_0.3s]" /><circle cx="190" cy="105" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite_0.6s]" /></g></svg></div>);
        const CircularProgress = ({ percentage, label, subLabel, colorClass, trackClass, onClick }) => {const radius = 18; const circumference = 2 * Math.PI * radius; const strokeDashoffset = circumference - (percentage / 100) * circumference; return (<div className="flex flex-col items-center justify-center group cursor-pointer relative z-10" onClick={onClick} style={{ pointerEvents: 'auto' }}><div className="relative w-12 h-12 flex items-center justify-center transition-transform group-hover:scale-105"><svg className="w-full h-full transform -rotate-90"><circle cx="24" cy="24" r={radius} stroke="currentColor" strokeWidth="4" fill="transparent" className={trackClass} /><circle cx="24" cy="24" r={radius} stroke="currentColor" strokeWidth="4" fill="transparent" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round" className={colorClass} /></svg><span className="absolute text-[10px] font-bold text-gray-600">{percentage}%</span></div><div className="mt-1 text-center"><div className="text-[10px] text-gray-400 group-hover:text-blue-500 transition-colors">{label}</div><div className="text-xs font-bold text-gray-800">{subLabel}</div></div></div>);};
        const AdvancedPieChart = ({ data, totalMins }) => {if (!data || data.length === 0) return null; let cumulativePercent = 0; const getCoordinates = (percent, radius = 1) => { const rad = 2 * Math.PI * (percent - 0.25); const x = Math.cos(rad) * radius; const y = Math.sin(rad) * radius; return [x, y]; }; const formatDuration = (mins) => { const h = Math.floor(mins / 60); const m = mins % 60; if (h > 0 && m > 0) return `${h}小时${m}分`; if (h > 0) return `${h}小时`; return `${m}分`; }; return (<div className="relative w-full aspect-square max-w-sm mx-auto my-4"><svg viewBox="-2 -2 4 4" className="w-full h-full overflow-visible">{data.map((item, index) => { const percent = item.value / totalMins; const [startX, startY] = getCoordinates(cumulativePercent); const midPercent = cumulativePercent + percent / 2; cumulativePercent += percent; const [endX, endY] = getCoordinates(cumulativePercent); const largeArcFlag = percent > 0.5 ? 1 : 0; const pathData = `M 0 0 L ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} Z`; const [midX, midY] = getCoordinates(midPercent); const isRight = midX > 0; const elbowX = midX * 1.15; const elbowY = midY * 1.15; const textStartX = isRight ? elbowX + 0.2 : elbowX - 0.2; return (<g key={index}><path d={pathData} fill={item.color} stroke="white" strokeWidth="0.02" className="hover:opacity-90 transition-opacity cursor-pointer" />{percent > 0.03 && (<React.Fragment><polyline points={`${midX},${midY} ${elbowX},${elbowY} ${textStartX},${elbowY}`} fill="none" stroke="#9ca3af" strokeWidth="0.015" /><text x={isRight ? textStartX + 0.05 : textStartX - 0.05} y={elbowY - 0.06} fill="#4b5563" fontSize="0.16" textAnchor={isRight ? 'start' : 'end'} alignmentBaseline="baseline" className="font-bold">{item.tag}</text><text x={isRight ? textStartX + 0.05 : textStartX - 0.05} y={elbowY + 0.14} fill="#6b7280" fontSize="0.12" textAnchor={isRight ? 'start' : 'end'} alignmentBaseline="baseline">{formatDuration(item.value)}</text></React.Fragment>)}</g>);})}</svg></div>);};
        
        // 极简扁平化统计卡片 - 极致压缩版
        const StatCard = ({ number, title, subText, colorTheme }) => {
            const themes = {
                red: { bg: 'bg-red-50', text: 'text-red-600', border: 'border-red-100' },
                orange: { bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-100' },
                blue: { bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-100' },
                green: { bg: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-100' },
            };
            const theme = themes[colorTheme] || themes.blue;
            return (
                <div className={`${theme.bg} rounded-lg p-1 flex flex-col items-center justify-center border ${theme.border} h-full`}>
                    <span className="text-[9px] font-bold text-gray-500 leading-none scale-75 origin-bottom">{title}</span>
                    <span className={`text-base font-black ${theme.text} leading-none my-0.5`}>{number}</span>
                    <span className={`text-[9px] font-bold ${theme.text} opacity-80 leading-none scale-75 origin-top`}>{subText}</span>
                </div>
            );
        };

        const TaskCard = ({ task, onToggle, onEdit, onDelete, onNote, onRemind, onStart, cardStyle, sectionColor, isOverlap }) => {
            // [新增] 1. 滑动状态管理
            const [translateX, setTranslateX] = useState(0);
            const [isDragging, setIsDragging] = useState(false);
            const startX = useRef(0);
            const currentTranslate = useRef(0);

            // [新增] 2. 触摸事件处理
            const handleTouchStart = (e) => {
                startX.current = e.touches[0].clientX;
                setIsDragging(true);
            };

            const handleTouchMove = (e) => {
                if (!isDragging) return;
                const currentX = e.touches[0].clientX;
                const diff = currentX - startX.current;
                
                // 只允许向左滑动 (负值)，最大滑动距离 120px
                let newTranslate = currentTranslate.current + diff;
                if (newTranslate > 0) newTranslate = 0;
                if (newTranslate < -120) newTranslate = -120;
                
                setTranslateX(newTranslate);
            };

            const handleTouchEnd = () => {
                setIsDragging(false);
                // 滑动超过 60px 则自动展开，否则回弹
                if (translateX < -60) {
                    setTranslateX(-120);
                    currentTranslate.current = -120;
                } else {
                    setTranslateX(0);
                    currentTranslate.current = 0;
                }
            };

            // [新增] 3. 点击处理：如果是打开状态则关闭，否则触发正常的 toggle
            const handleCardClick = (e) => {
                if (translateX !== 0) {
                    setTranslateX(0);
                    currentTranslate.current = 0;
                    return;
                }
                onToggle(task);
            };

            const getMatrixTag = () => {
                if (task.important && task.urgent) return { text: '重要紧急', color: 'indigo' };
                if (task.important && !task.urgent) return { text: '重要不急', color: 'blue' };
                if (!task.important && task.urgent) return { text: '紧急不重', color: 'red' };
                return { text: '不急不重', color: 'green' };
            };
            const matrixTag = getMatrixTag();
            const tagColors = { indigo: 'bg-indigo-100 text-indigo-700', blue: 'bg-blue-100 text-blue-700', red: 'bg-red-100 text-red-700', green: 'bg-emerald-100 text-emerald-700', gray: 'bg-gray-100 text-gray-600' };
            const userTag = typeof task.tag === 'string' ? task.tag : '';
            const theme = sectionColor && COLOR_THEMES[sectionColor] ? COLOR_THEMES[sectionColor] : COLOR_THEMES.butter; 
            // 注意：bgClass 现在只应用在内部内容层，而不是外层容器
            const bgClass = task.completed ? 'bg-white border-gray-100' : cardStyle === 'colored' && theme ? `${theme.cardBg} border-transparent` : 'bg-white border-gray-100 hover:shadow-md'; 
            
            return (
                // [修改] 外层容器负责裁剪和定位
                <div className="relative overflow-hidden rounded-xl mb-2 shadow-sm select-none">
                    
                    {/* [新增] 底层操作按钮层 (右侧) */}
                    <div className="absolute inset-y-0 right-0 flex w-[120px]">
                        <button 
                            onClick={(e) => {
                                e.stopPropagation();
                                onEdit(task);
                                setTranslateX(0); // 操作后关闭
                                currentTranslate.current = 0;
                            }} 
                            className="w-1/2 h-full bg-gray-200 text-gray-600 flex flex-col items-center justify-center text-xs font-bold active:bg-gray-300 transition-colors"
                        >
                            <Edit3 className="w-4 h-4 mb-1" />
                            编辑
                        </button>
                        <button 
                            onClick={(e) => {
                                e.stopPropagation();
                                if(confirm("确认删除任务?")) onDelete(task.id);
                                setTranslateX(0);
                                currentTranslate.current = 0;
                            }} 
                            className="w-1/2 h-full bg-red-500 text-white flex flex-col items-center justify-center text-xs font-bold active:bg-red-600 transition-colors"
                        >
                            <Trash2 className="w-4 h-4 mb-1" />
                            删除
                        </button>
                    </div>

                    {/* [修改] 上层内容层 (可滑动) */}
                    <div 
                        className={`relative z-10 p-2.5 flex items-start gap-3 border transition-transform duration-200 ease-out ${bgClass}`}
                        style={{ 
                            transform: `translateX(${translateX}px)`,
                            transition: isDragging ? 'none' : 'transform 0.2s ease-out'
                        }}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                        onClick={handleCardClick}
                    >
                        
                        {/* 时间冲突视觉警示 (跟随内容移动) */}
                        {isOverlap && !task.completed && (
                            <div className="absolute left-0 top-0 bottom-0 w-1 bg-red-400 z-10 rounded-l-xl" title="时间冲突"></div>
                        )}

                        {/* 时间列 - 动态显示 */}
                        <div className={`flex flex-col items-end justify-center min-w-[4rem] border-r-2 border-gray-100 pr-3 py-1 self-stretch ${isOverlap && !task.completed ? 'pl-2' : ''}`}>
                            {(() => {
                                const plannedStart = task.time ? task.time.split('-')[0] : '';
                                const plannedEnd = task.time ? (task.time.split('-')[1] || '') : '';
                                
                                let displayStart = plannedStart;
                                let displayEnd = plannedEnd;
                                let timeStyle = "text-slate-700"; 
                                
                                if (task.completed) {
                                    displayStart = task.actualStart || plannedStart;
                                    displayEnd = task.actualEnd || plannedEnd;
                                    timeStyle = "text-gray-400 line-through decoration-gray-300";
                                } else if (task.actualStart) {
                                    displayStart = task.actualStart;
                                    displayEnd = plannedEnd;
                                    timeStyle = "text-blue-600 font-bold animate-pulse";
                                }
                                if (isOverlap && !task.completed) {
                                    timeStyle = "text-red-500 font-bold";
                                }

                                return displayStart ? (
                                    <>
                                        <span className={`text-sm font-black font-mono leading-none ${timeStyle}`}>{displayStart}</span>
                                        <span className={`text-[10px] font-bold leading-none mt-1 ${task.completed ? 'text-gray-300 line-through' : 'text-gray-400'}`}>{displayEnd ? '-' + displayEnd : ''}</span>
                                    </>
                                ) : (
                                    <span className="text-xs font-bold text-gray-300">--:--</span>
                                );
                            })()}
                        </div>

                        {/* 任务内容主体 */}
                        <div className={`flex-1 transition-opacity duration-300 min-w-0 py-0.5 ${task.completed ? 'opacity-40' : 'opacity-100'}`}>
                            <div className="flex items-center gap-2 mb-1.5">
                                <h3 className={`font-bold text-sm truncate transition-colors duration-300 ${task.completed ? 'line-through text-gray-300 decoration-gray-300' : 'text-gray-800'}`}>
                                    {String(task.title)}
                                    {task.recurring && <RotateCcw className="inline-block w-3 h-3 ml-2 text-blue-400" />}
                                </h3>
                            </div>
                            <div className="flex flex-wrap items-center gap-2">
                                {userTag && <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${task.completed ? 'bg-gray-100 text-gray-400' : 'bg-gray-100 text-gray-600'}`}>{String(userTag)}</span>}
                                <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${task.completed ? 'bg-gray-100 text-gray-400' : tagColors[matrixTag.color]}`}>{matrixTag.text}</span>
                                
                                <div className={`flex items-center gap-2 ${task.completed ? 'hidden' : 'flex'}`}>
                                    {!task.actualStart ? (
                                        <button className="flex items-center gap-0.5 text-[10px] px-1.5 py-0.5 rounded hover:bg-green-50 hover:text-green-600 text-gray-400 transition-all font-bold group/play" onClick={(e) => { e.stopPropagation(); onStart && onStart(task); }}>
                                            <Play className="w-3 h-3 group-hover/play:fill-green-600" /><span>执行</span>
                                        </button>
                                    ) : (
                                        <span className="text-[10px] text-green-600 font-bold flex items-center gap-0.5 bg-green-50 px-1.5 py-0.5 rounded border border-green-100" title="实际开始时间">
                                            <Zap className="w-3 h-3 fill-green-500"/> 执行中
                                        </span>
                                    )}
                                    <button className="flex items-center gap-0.5 text-[10px] px-1.5 py-0.5 rounded hover:bg-pink-50 hover:text-pink-600 text-gray-400 transition-all" onClick={(e) => { e.stopPropagation(); onNote(task); }}>
                                        <PenLine className="w-3 h-3" /><span>备注</span>
                                    </button>
                                    <button className="flex items-center gap-0.5 text-[10px] px-1.5 py-0.5 rounded hover:bg-yellow-50 hover:text-yellow-600 text-gray-400 transition-all" onClick={(e) => { e.stopPropagation(); onRemind(task); }}>
                                        <Bell className="w-3 h-3" /><span>提醒</span>
                                    </button>
                                </div>
                            </div>
                            {task.note && (<div className={`mt-2 px-2 py-1.5 rounded-lg text-xs flex gap-2 items-start border transition-colors ${task.completed ? 'bg-gray-50 border-gray-100 text-gray-300' : 'bg-yellow-50 border-yellow-100/50 text-gray-600'}`}><StickyNote className={`w-3 h-3 mt-0.5 flex-shrink-0 ${task.completed ? 'text-gray-300' : 'text-yellow-400'}`} /><span className="line-clamp-1">{String(task.note)}</span></div>)}
                        </div>
                        
                        {/* 完成勾选框 */}
                        <div className="flex-shrink-0 ml-1 self-center">
                            <div className={`w-6 h-6 rounded-full flex items-center justify-center transition-all duration-300 ${task.completed ? 'bg-green-400 shadow-sm scale-110' : 'border-2 border-gray-200 hover:border-indigo-300 bg-white'}`}>
                                {task.completed && <Check className="w-4 h-4 text-white stroke-[3]" />}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DailyReviewContent = ({ reviewDate, reviews, setReviews }) => {
            const reviewId = getReviewId('daily', reviewDate);
            const data = reviews[reviewId] || { gratitude: '', facts: '', insight: '', adjustment: '' };
            const [gratitudeSaved, setGratitudeSaved] = useState(false);
            const [threeLineSaved, setThreeLineSaved] = useState(false);
            const gratitudeRef = useRef(null); const factsRef = useRef(null); const insightRef = useRef(null); const adjustmentRef = useRef(null);
            const adjustHeight = (ref) => { if (ref.current) { ref.current.style.height = 'auto'; ref.current.style.height = ref.current.scrollHeight + 'px'; } };
            useEffect(() => { adjustHeight(gratitudeRef); }, [data.gratitude]);
            useEffect(() => { adjustHeight(factsRef); adjustHeight(insightRef); adjustHeight(adjustmentRef); }, [data.facts, data.insight, data.adjustment]);
            const updateReview = (field, value) => { setReviews(prev => ({ ...prev, [reviewId]: { ...(prev[reviewId] || {}), [field]: value } })); if (field === 'gratitude') setGratitudeSaved(false); else setThreeLineSaved(false); };
            const handleSaveGratitude = () => { setGratitudeSaved(true); setTimeout(() => setGratitudeSaved(false), 2000); };
            const handleSaveThreeLine = () => { setThreeLineSaved(true); setTimeout(() => setThreeLineSaved(false), 2000); };
            return (<div className="space-y-6 p-4"><div className="bg-white p-4 rounded-xl shadow-sm border border-pink-50"><div className="flex items-center justify-between mb-3"><div className="flex items-center gap-2"><Heart className="w-5 h-5 text-pink-400 fill-pink-400" /><h4 className="font-bold text-gray-800">感恩笔记</h4></div><button onClick={handleSaveGratitude} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${gratitudeSaved ? 'bg-green-100 text-green-600' : 'bg-pink-50 text-pink-600 hover:bg-pink-100'}`}>{gratitudeSaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> 已保存</span> : '保存'}</button></div><textarea ref={gratitudeRef} className="w-full min-h-[96px] bg-pink-50/30 rounded-lg p-3 text-sm focus:outline-none focus:ring-1 focus:ring-pink-200 resize-none placeholder:text-gray-300 overflow-hidden transition-all" placeholder="记录今天值得感激的小确幸..." value={String(data.gratitude || '')} onChange={(e) => updateReview('gratitude', e.target.value)} /></div><div className="bg-white p-4 rounded-xl shadow-sm border border-blue-50"><div className="flex items-center justify-between mb-3"><div className="flex items-center gap-2"><Sparkles className="w-5 h-5 text-orange-400 fill-orange-400" /><h4 className="font-bold text-gray-800">3行极简复盘</h4></div><button onClick={handleSaveThreeLine} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${threeLineSaved ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>{threeLineSaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> 已保存</span> : '保存'}</button></div><div className="space-y-3"><div><label className="text-xs font-bold text-blue-500 mb-1 block flex items-center gap-1"><LayoutGrid className="w-3 h-3"/> 事实</label><textarea ref={factsRef} rows={1} className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-blue-200 transition-all resize-none overflow-hidden" placeholder="完成..." value={String(data.facts || '')} onChange={(e) => updateReview('facts', e.target.value)} /></div><div><label className="text-xs font-bold text-pink-500 mb-1 block flex items-center gap-1"><Zap className="w-3 h-3"/> 洞察</label><textarea ref={insightRef} rows={1} className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-pink-200 transition-all resize-none overflow-hidden" placeholder="心得..." value={String(data.insight || '')} onChange={(e) => updateReview('insight', e.target.value)} /></div><div><label className="text-xs font-bold text-green-500 mb-1 block flex items-center gap-1"><CheckCircle2 className="w-3 h-3"/> 调整</label><textarea ref={adjustmentRef} rows={1} className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-green-200 transition-all resize-none overflow-hidden" placeholder="下一步..." value={String(data.adjustment || '')} onChange={(e) => updateReview('adjustment', e.target.value)} /></div></div></div></div>);
        };

        const PeriodReviewContent = ({ period, reviewDate, reviews, setReviews, tasksByDate, sections }) => {
            const reviewId = getReviewId(period, reviewDate);
            const data = reviews[reviewId] || {};
            const goals = Array.isArray(data.goals) ? data.goals : [];
            const [summarySaved, setSummarySaved] = useState(false);
            const [kptSaved, setKptSaved] = useState({ keep: false, problem: false, try: false });
            const [graiSaved, setGraiSaved] = useState({ goal: false, result: false, analysis: false, insight: false });
            const [pdcaSaved, setPdcaSaved] = useState({ plan: false, do: false, check: false, action: false });
            const summaryRef = useRef(null); const keepRef = useRef(null); const problemRef = useRef(null); const tryRef = useRef(null); const goalRef = useRef(null); const resultRef = useRef(null); const analysisRef = useRef(null); const insightRef = useRef(null); const planRef = useRef(null); const doRef = useRef(null); const checkRef = useRef(null); const actionRef = useRef(null);
            const adjustHeight = (ref) => { if (ref.current) { ref.current.style.height = 'auto'; ref.current.style.height = ref.current.scrollHeight + 'px'; } };
            useEffect(() => { adjustHeight(summaryRef); }, [data.summary]);
            useEffect(() => { if(period === 'yearly') { adjustHeight(keepRef); adjustHeight(problemRef); adjustHeight(tryRef); } }, [data.kpt_keep, data.kpt_problem, data.kpt_try, period]);
            useEffect(() => { if(period === 'monthly') { adjustHeight(goalRef); adjustHeight(resultRef); adjustHeight(analysisRef); adjustHeight(insightRef); } }, [data.grai_goal, data.grai_result, data.grai_analysis, data.grai_insight, period]);
            useEffect(() => { if(period === 'weekly') { adjustHeight(planRef); adjustHeight(doRef); adjustHeight(checkRef); adjustHeight(actionRef); } }, [data.pdca_plan, data.pdca_do, data.pdca_check, data.pdca_action, period]);
            const statsData = useMemo(() => { let targetDates = []; const y = reviewDate.getFullYear(); const m = reviewDate.getMonth(); if (period === 'weekly') { const { start } = getWeekRange(reviewDate); for(let i=0; i<7; i++) { const temp = new Date(start); temp.setDate(start.getDate() + i); targetDates.push(generateDateString(temp)); } } else if (period === 'monthly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy, dm] = dateStr.split('-').map(Number); if (dy === y && dm === m + 1) targetDates.push(dateStr); }); } else if (period === 'yearly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy] = dateStr.split('-').map(Number); if (dy === y) targetDates.push(dateStr); }); } let tagMap = {}; let totalMins = 0; let activeDays = new Set(); let completedCount = 0; targetDates.forEach(dateStr => { const dayTasks = tasksByDate[dateStr]; if (!dayTasks) return; let hasCompleted = false; [...sections.map(s => s.id), 'fragmentary'].forEach(sec => { (dayTasks[sec] || []).forEach(task => { if (task.completed) { hasCompleted = true; completedCount++; const tag = task.tag || '未分类'; const mins = task.time ? parseDurationFromTimeStr(task.time) : 30; tagMap[tag] = (tagMap[tag] || 0) + mins; totalMins += mins; } }); }); if (hasCompleted) activeDays.add(dateStr); }); const colors = ['#fca5a5', '#93c5fd', '#6ee7b7', '#fcd34d', '#c4b5fd', '#f9a8d4', '#818cf8', '#34d399', '#fbbf24', '#f87171']; const chartData = Object.keys(tagMap).map((k, i) => ({ tag: k, value: tagMap[k], color: colors[i % colors.length] })).sort((a,b) => b.value - a.value); return { data: chartData, totalMins, completedCount, activeDays: activeDays.size }; }, [period, reviewDate, tasksByDate, sections]);
            const [newGoal, setNewGoal] = useState('');
            const updateReview = (field, value) => { setReviews(prev => ({ ...prev, [reviewId]: { ...(prev[reviewId] || {}), [field]: value } })); if (field === 'summary') setSummarySaved(false); if (field.startsWith('kpt_')) setKptSaved(prev => ({ ...prev, [field.split('_')[1]]: false })); if (field.startsWith('grai_')) setGraiSaved(prev => ({ ...prev, [field.split('_')[1]]: false })); if (field.startsWith('pdca_')) setPdcaSaved(prev => ({ ...prev, [field.split('_')[1]]: false })); };
            const addGoal = () => { if (!newGoal.trim()) return; const newGoalObj = { id: Date.now(), text: newGoal, completed: false }; updateReview('goals', [...goals, newGoalObj]); setNewGoal(''); };
            const toggleGoal = (goalId) => { const newGoals = goals.map(g => g.id === goalId ? { ...g, completed: !g.completed } : g); updateReview('goals', newGoals); };
            const handleSaveSummary = () => { setSummarySaved(true); setTimeout(() => setSummarySaved(false), 2000); };
            const handleSaveKpt = (type) => { setKptSaved(prev => ({ ...prev, [type]: true })); setTimeout(() => setKptSaved(prev => ({ ...prev, [type]: false })), 2000); };
            const handleSaveGrai = (type) => { setGraiSaved(prev => ({ ...prev, [type]: true })); setTimeout(() => setGraiSaved(prev => ({ ...prev, [type]: false })), 2000); };
            const handleSavePdca = (type) => { setPdcaSaved(prev => ({ ...prev, [type]: true })); setTimeout(() => setPdcaSaved(prev => ({ ...prev, [type]: false })), 2000); };

            return (
                <div className="space-y-4 p-4">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex items-center gap-2 mb-2"><PieChart className="w-5 h-5 text-indigo-500" /><h4 className="font-bold text-gray-800 text-sm">时间分配与数据回顾</h4></div>
                        {statsData.data.length > 0 ? (<div className="flex flex-col items-center"><AdvancedPieChart data={statsData.data} totalMins={statsData.totalMins} /><div className="mt-4 text-center w-full pt-4 border-t border-gray-100"><p className="text-gray-800 font-bold text-sm mb-1">总计 {Math.floor(statsData.totalMins / 60)} 小时 {statsData.totalMins % 60} 分钟</p><p className="text-gray-400 text-xs mt-1">打卡完成 {statsData.completedCount} 个任务 · 周期内活跃 {statsData.activeDays} 天</p></div></div>) : (<div className="text-center py-6 text-gray-400 text-xs">该周期暂无已完成的任务数据</div>)}
                    </div>
                     <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex items-center gap-2 mb-3"><Target className="w-5 h-5 text-red-500" /><h4 className="font-bold text-gray-800 text-sm">核心目标</h4></div>
                        <div className="space-y-2 mb-3">{goals.map(goal => (<div key={goal.id} className="flex items-center gap-2 group p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"><button onClick={() => toggleGoal(goal.id)} className={`flex-shrink-0 transition-colors ${goal.completed ? 'text-green-500' : 'text-gray-300 hover:text-gray-400'}`}>{goal.completed ? <CheckCircle2 className="w-5 h-5" /> : <Circle className="w-5 h-5" />}</button><span className={`flex-1 text-sm ${goal.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{String(goal.text)}</span></div>))}</div>
                        <div className="flex gap-2 w-full mt-2"><input className="flex-1 bg-white border border-gray-200 rounded px-3 py-1.5 text-sm outline-none" placeholder="添加新目标..." value={newGoal} onChange={(e) => setNewGoal(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addGoal()} /><button onClick={addGoal} className="bg-[#1E293B] text-white px-4 py-1.5 rounded text-xs font-bold">添加</button></div>
                    </div>
                    {period === 'yearly' ? (
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2"><TrendingUp className="w-5 h-5 text-purple-600" /><h4 className="font-black text-gray-800 text-lg">KPT 年复盘法</h4></div>
                            <div className="space-y-5">
                                <div className="bg-green-50/50 p-4 rounded-xl border border-green-100"><div className="flex items-center justify-between mb-2"><label className="text-green-700 font-bold flex items-center gap-2"><CheckCircle2 className="w-4 h-4"/> Keep 保持</label><button onClick={() => handleSaveKpt('keep')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${kptSaved.keep ? 'bg-green-200 text-green-700' : 'bg-white text-green-600 border border-green-200 hover:bg-green-50'}`}>{kptSaved.keep ? '已保存' : '保存'}</button></div><p className="text-xs text-green-600/70 mb-2">哪些行为是可以保持的？有哪些亮点？</p><textarea ref={keepRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-green-200 resize-none overflow-hidden transition-all text-gray-700" placeholder="记录值得延续的成功经验..." value={String(data.kpt_keep || '')} onChange={(e) => updateReview('kpt_keep', e.target.value)} /></div>
                                <div className="bg-orange-50/50 p-4 rounded-xl border border-orange-100"><div className="flex items-center justify-between mb-2"><label className="text-orange-700 font-bold flex items-center gap-2"><AlertCircle className="w-4 h-4"/> Problem 问题</label><button onClick={() => handleSaveKpt('problem')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${kptSaved.problem ? 'bg-orange-200 text-orange-700' : 'bg-white text-orange-600 border border-orange-200 hover:bg-orange-50'}`}>{kptSaved.problem ? '已保存' : '保存'}</button></div><p className="text-xs text-orange-600/70 mb-2">曾遇到了哪些问题？有哪些不足？</p><textarea ref={problemRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-orange-200 resize-none overflow-hidden transition-all text-gray-700" placeholder="诚实地记录遇到的困难和挑战..." value={String(data.kpt_problem || '')} onChange={(e) => updateReview('kpt_problem', e.target.value)} /></div>
                                <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100"><div className="flex items-center justify-between mb-2"><label className="text-blue-700 font-bold flex items-center gap-2"><Sparkles className="w-4 h-4"/> Try 尝试</label><button onClick={() => handleSaveKpt('try')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${kptSaved.try ? 'bg-blue-200 text-blue-700' : 'bg-white text-blue-600 border border-blue-200 hover:bg-blue-50'}`}>{kptSaved.try ? '已保存' : '保存'}</button></div><p className="text-xs text-blue-600/70 mb-2">可以尝试去做什么？有什么新的解决方案？</p><textarea ref={tryRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 resize-none overflow-hidden transition-all text-gray-700" placeholder="写下明年的行动计划和改进方案..." value={String(data.kpt_try || '')} onChange={(e) => updateReview('kpt_try', e.target.value)} /></div>
                            </div>
                            <div className="mt-6 pt-4 border-t border-gray-100"><span className="text-xs font-bold text-gray-400 block mb-2">💡 复盘思考维度参考：</span><div className="flex flex-wrap gap-2"><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">🌱 内在：个人成长</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">💼 内在：职业发展</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">💰 内在：财务状况</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">🌟 内在：自我实现</span></div><div className="flex flex-wrap gap-2 mt-2"><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">🤝 外在：朋友/人脉</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">🎮 外在：娱乐休闲</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">🏠 外在：家庭</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">💪 外在：健康</span></div></div>
                        </div>
                    ) : period === 'monthly' ? (
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2"><TrendingUp className="w-5 h-5 text-indigo-600" /><h4 className="font-black text-gray-800 text-lg">GRAI 月复盘法</h4></div>
                            <div className="space-y-5">
                                <div className="bg-teal-50/50 p-4 rounded-xl border border-teal-100"><div className="flex items-center justify-between mb-2"><label className="text-teal-700 font-bold flex items-center gap-2"><Target className="w-4 h-4"/> Goal 回顾目标</label><button onClick={() => handleSaveGrai('goal')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${graiSaved.goal ? 'bg-teal-200 text-teal-700' : 'bg-white text-teal-600 border border-teal-200 hover:bg-teal-50'}`}>{graiSaved.goal ? '已保存' : '保存'}</button></div><p className="text-xs text-teal-600/70 mb-2">当初的目标是什么？核心阶段性目标是什么？</p><textarea ref={goalRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.grai_goal || '')} onChange={(e) => updateReview('grai_goal', e.target.value)} /></div>
                                <div className="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100"><div className="flex items-center justify-between mb-2"><label className="text-indigo-700 font-bold flex items-center gap-2"><PieChart className="w-4 h-4"/> Result 评估结果</label><button onClick={() => handleSaveGrai('result')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${graiSaved.result ? 'bg-indigo-200 text-indigo-700' : 'bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50'}`}>{graiSaved.result ? '已保存' : '保存'}</button></div><p className="text-xs text-indigo-600/70 mb-2">目标是否完成？差距多少？相比原定目标有哪些优劣势？</p><textarea ref={resultRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.grai_result || '')} onChange={(e) => updateReview('grai_result', e.target.value)} /></div>
                                <div className="bg-amber-50/50 p-4 rounded-xl border border-amber-100"><div className="flex items-center justify-between mb-2"><label className="text-amber-700 font-bold flex items-center gap-2"><LayoutGrid className="w-4 h-4"/> Analysis 分析原因</label><button onClick={() => handleSaveGrai('analysis')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${graiSaved.analysis ? 'bg-amber-200 text-amber-700' : 'bg-white text-amber-600 border border-amber-200 hover:bg-amber-50'}`}>{graiSaved.analysis ? '已保存' : '保存'}</button></div><p className="text-xs text-amber-600/70 mb-2">经历了什么？产生该结果的原因（主观/客观）有哪些？</p><textarea ref={analysisRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.grai_analysis || '')} onChange={(e) => updateReview('grai_analysis', e.target.value)} /></div>
                                <div className="bg-violet-50/50 p-4 rounded-xl border border-violet-100"><div className="flex items-center justify-between mb-2"><label className="text-violet-700 font-bold flex items-center gap-2"><Zap className="w-4 h-4"/> Insight 归类总结</label><button onClick={() => handleSaveGrai('insight')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${graiSaved.insight ? 'bg-violet-200 text-violet-700' : 'bg-white text-violet-600 border border-violet-200 hover:bg-violet-50'}`}>{graiSaved.insight ? '已保存' : '保存'}</button></div><p className="text-xs text-violet-600/70 mb-2">得出的对应措施是什么？得到了什么经验？规律是什么？</p><textarea ref={insightRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-violet-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.grai_insight || '')} onChange={(e) => updateReview('grai_insight', e.target.value)} /></div>
                            </div>
                        </div>
                    ) : period === 'weekly' ? (
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2"><TrendingUp className="w-5 h-5 text-emerald-600" /><h4 className="font-black text-gray-800 text-lg">PDCA 周复盘法</h4></div>
                            <div className="space-y-5">
                                <div className="bg-sky-50/50 p-4 rounded-xl border border-sky-100"><div className="flex items-center justify-between mb-2"><label className="text-sky-700 font-bold flex items-center gap-2"><Settings2 className="w-4 h-4"/> Plan 计划</label><button onClick={() => handleSavePdca('plan')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${pdcaSaved.plan ? 'bg-sky-200 text-sky-700' : 'bg-white text-sky-600 border border-sky-200 hover:bg-sky-50'}`}>{pdcaSaved.plan ? '已保存' : '保存'}</button></div><p className="text-xs text-sky-600/70 mb-2">制定计划：写下本周计划，计划做哪些事。</p><textarea ref={planRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.pdca_plan || '')} onChange={(e) => updateReview('pdca_plan', e.target.value)} /></div>
                                <div className="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100"><div className="flex items-center justify-between mb-2"><label className="text-emerald-700 font-bold flex items-center gap-2"><Play className="w-4 h-4"/> Do 执行</label><button onClick={() => handleSavePdca('do')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${pdcaSaved.do ? 'bg-emerald-200 text-emerald-700' : 'bg-white text-emerald-600 border border-emerald-200 hover:bg-emerald-50'}`}>{pdcaSaved.do ? '已保存' : '保存'}</button></div><p className="text-xs text-emerald-600/70 mb-2">实施、执行：写下具体完成了哪些事。</p><textarea ref={doRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.pdca_do || '')} onChange={(e) => updateReview('pdca_do', e.target.value)} /></div>
                                <div className="bg-amber-50/50 p-4 rounded-xl border border-amber-100"><div className="flex items-center justify-between mb-2"><label className="text-amber-700 font-bold flex items-center gap-2"><CheckCircle2 className="w-4 h-4"/> Check 检查</label><button onClick={() => handleSavePdca('check')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${pdcaSaved.check ? 'bg-amber-200 text-amber-700' : 'bg-white text-amber-600 border border-amber-200 hover:bg-amber-50'}`}>{pdcaSaved.check ? '已保存' : '保存'}</button></div><p className="text-xs text-amber-600/70 mb-2">检查、复盘：核对计划中哪些事没有完成，分析原因。</p><textarea ref={checkRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.pdca_check || '')} onChange={(e) => updateReview('pdca_check', e.target.value)} /></div>
                                <div className="bg-rose-50/50 p-4 rounded-xl border border-rose-100"><div className="flex items-center justify-between mb-2"><label className="text-rose-700 font-bold flex items-center gap-2"><RotateCcw className="w-4 h-4"/> Action 处理</label><button onClick={() => handleSavePdca('action')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${pdcaSaved.action ? 'bg-rose-200 text-rose-700' : 'bg-white text-rose-600 border border-rose-200 hover:bg-rose-50'}`}>{pdcaSaved.action ? '已保存' : '保存'}</button></div><p className="text-xs text-rose-600/70 mb-2">采取措施：针对没有完成的计划，后续有什么改善的措施。</p><textarea ref={actionRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-rose-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.pdca_action || '')} onChange={(e) => updateReview('pdca_action', e.target.value)} /></div>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex items-center justify-between mb-3"><div className="flex items-center gap-2"><PenLine className="w-5 h-5 text-emerald-500" /><h4 className="font-bold text-gray-800 text-sm">周期心得总结</h4></div><button onClick={handleSaveSummary} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${summarySaved ? 'bg-green-100 text-green-600' : 'bg-emerald-50 text-emerald-600 hover:bg-emerald-100'}`}>{summarySaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> 已保存</span> : '保存'}</button></div>
                            <textarea ref={summaryRef} className="w-full min-h-[96px] bg-gray-50 rounded-lg p-3 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-200 resize-none placeholder:text-gray-400 overflow-hidden transition-all" placeholder={`写下这${period === 'weekly' ? '一周' : '一段时间'}的心得体会或下一步计划...`} value={String(data.summary || '')} onChange={(e) => updateReview('summary', e.target.value)} />
                        </div>
                    )}
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, onSave }) => {
            if (!isOpen) return null;
            const [configStr, setConfigStr] = useState('');
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="云端同步设置">
                    <div className="p-6">
                        <div className="bg-blue-50 p-4 rounded-xl mb-4 text-sm text-blue-800">
                            <p className="font-bold mb-2 flex items-center gap-2"><Cloud className="w-4 h-4"/> 开启多设备同步</p>
                            <p className="mb-2">1. 访问 <a href="https://console.firebase.google.com/" target="_blank" className="underline font-bold">Firebase Console</a> 创建项目。</p>
                            <p className="mb-2">2. 创建 Web 应用，复制 <code>firebaseConfig</code> 对象 (包含 apiKey, authDomain 等)。</p>
                            <p>3. 粘贴到下方框中，开启 Auth (Email/Pass) 和 Firestore 数据库。</p>
                        </div>
                        <textarea 
                            className="w-full h-40 bg-gray-100 p-3 rounded-xl text-xs font-mono mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder='{ "apiKey": "AIzaSy...", "authDomain": "...", ... }'
                            value={configStr}
                            onChange={(e) => setConfigStr(e.target.value)}
                        />
                        <button onClick={() => onSave(configStr)} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">保存配置并重启</button>
                    </div>
                </Modal>
            );
        };

        const AuthModal = ({ isOpen, onClose, auth }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                try {
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                    onClose();
                } catch (err) {
                    setError(err.code === 'auth/invalid-email' ? "邮箱格式不正确" : err.code === 'auth/wrong-password' ? "密码错误" : "操作失败，请检查网络或配置");
                } finally { setLoading(false); }
            };

            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={isRegister ? "注册云端账户" : "登录云端账户"}>
                    <div className="p-6">
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">邮箱</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 focus:border-blue-500 outline-none" required /></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">密码</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 focus:border-blue-500 outline-none" required /></div>
                            {error && <div className="text-xs text-red-500 bg-red-50 p-2 rounded">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition flex justify-center">{loading ? <Loader2 className="animate-spin"/> : (isRegister ? "注册" : "登录")}</button>
                        </form>
                        <div className="mt-4 text-center"><button onClick={() => setIsRegister(!isRegister)} className="text-xs text-gray-400 underline">{isRegister ? "已有账号？去登录" : "去注册"}</button></div>
                    </div>
                </Modal>
            );
        };

        const getStorageKey = (key, uid) => `${key}_${uid}`;

        const migrateLegacyData = (uid) => {
            const keys = ['lifeos_sections_v2', 'lifeos_tasks', 'lifeos_reviews', 'lifeos_theme'];
            let hasMigrated = false;
            
            keys.forEach(baseKey => {
                const legacyData = localStorage.getItem(baseKey);
                const userKey = getStorageKey(baseKey, uid);
                const userData = localStorage.getItem(userKey);
                
                // If legacy data exists AND user data does NOT exist, migrate
                if (legacyData && !userData) {
                    localStorage.setItem(userKey, legacyData);
                    hasMigrated = true;
                    console.log(`Migrated ${baseKey} to ${userKey}`);
                }
            });
            return hasMigrated;
        };

        function App() {
            const [currentDate, setCurrentDate] = useState(new Date()); 
            const [selectedDateStr, setSelectedDateStr] = useState(generateDateString(new Date())); 
            
            // --- State Initialization (Empty) ---
            const [sections, setSections] = useState(INITIAL_SECTIONS);
            const [tasksByDate, setTasksByDate] = useState(INITIAL_TASKS_BY_DATE);
            const [reviews, setReviews] = useState({});
            const [globalTheme, setGlobalTheme] = useState({ pageBg: 'gray', headerBg: 'white', cardStyle: 'default' });
            
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            
            // Firebase Refs
            const [firebaseConfig, setFirebaseConfig] = useState(() => JSON.parse(localStorage.getItem('lifeos_fb_config') || 'null'));
            const [firebaseAuth, setFirebaseAuth] = useState(null);
            const [firebaseDb, setFirebaseDb] = useState(null);
            const [user, setUser] = useState(null);
            const isRemoteUpdate = useRef(false);

            // 1. Initialize Firebase if Config Present
            useEffect(() => {
                if (firebaseConfig) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        setFirebaseAuth(getAuth(app));
                        setFirebaseDb(getFirestore(app));
                    } catch (e) {
                        console.error("Firebase init error", e);
                        alert("Firebase 配置无效，已重置。");
                        localStorage.removeItem('lifeos_fb_config');
                        setFirebaseConfig(null);
                    }
                }
            }, [firebaseConfig]);

            // 2. Main Data Loading Effect (Auth Sensitive)
            useEffect(() => {
                let unsubscribe = null;

                const loadData = async (uid) => {
                    setIsDataLoaded(false);
                    
                    // A. Migration Check
                    migrateLegacyData(uid);

                    // B. Load Local Data (User Specific)
                    const localSections = JSON.parse(localStorage.getItem(getStorageKey('lifeos_sections_v2', uid)));
                    const localTasks = JSON.parse(localStorage.getItem(getStorageKey('lifeos_tasks', uid)));
                    const localReviews = JSON.parse(localStorage.getItem(getStorageKey('lifeos_reviews', uid)));
                    const localTheme = JSON.parse(localStorage.getItem(getStorageKey('lifeos_theme', uid)));

                    if (localSections) setSections(localSections);
                    if (localTasks) setTasksByDate(localTasks);
                    if (localReviews) setReviews(localReviews);
                    if (localTheme) setGlobalTheme(localTheme);

                    // C. Cloud Sync (If Logged In)
                    if (uid !== 'guest' && firebaseDb) {
                        const docRef = doc(firebaseDb, 'users', uid, 'data', 'main');
                        unsubscribe = onSnapshot(docRef, (snap) => {
                            if (snap.exists()) {
                                const data = snap.data();
                                isRemoteUpdate.current = true;
                                if (data.sections) setSections(data.sections);
                                if (data.tasksByDate) setTasksByDate(data.tasksByDate);
                                if (data.reviews) setReviews(data.reviews);
                                if (data.globalTheme) setGlobalTheme(data.globalTheme);
                                // Small delay to prevent echo
                                setTimeout(() => { isRemoteUpdate.current = false; }, 100);
                            } else {
                                // Upload local data if cloud is empty (First Sync)
                                setDoc(docRef, { 
                                    sections: localSections || INITIAL_SECTIONS, 
                                    tasksByDate: localTasks || INITIAL_TASKS_BY_DATE, 
                                    reviews: localReviews || {}, 
                                    globalTheme: localTheme || { pageBg: 'gray', headerBg: 'white', cardStyle: 'default' } 
                                });
                            }
                        });
                    }
                    
                    setIsDataLoaded(true);
                };

                if (firebaseAuth) {
                    // Wait for Auth State
                    const authUnsub = onAuthStateChanged(firebaseAuth, (u) => {
                        setUser(u);
                        loadData(u ? u.uid : 'guest');
                    });
                    return () => { authUnsub(); if(unsubscribe) unsubscribe(); };
                } else {
                    // Guest Mode
                    loadData('guest');
                }
            }, [firebaseAuth, firebaseDb]);

            // 3. Save Data Effect (Debounced or Direct)
            const saveData = (keySuffix, data) => {
                if (!isDataLoaded) return; // Critical Safety Lock
                
                const uid = user ? user.uid : 'guest';
                const key = getStorageKey(keySuffix, uid);
                localStorage.setItem(key, JSON.stringify(data));

                if (user && firebaseDb && !isRemoteUpdate.current) {
                    const docRef = doc(firebaseDb, 'users', uid, 'data', 'main');
                    // Map suffix to object key
                    const fieldMap = {
                        'lifeos_sections_v2': 'sections',
                        'lifeos_tasks': 'tasksByDate',
                        'lifeos_reviews': 'reviews',
                        'lifeos_theme': 'globalTheme'
                    };
                    const fieldName = fieldMap[keySuffix];
                    if (fieldName) {
                        setDoc(docRef, { [fieldName]: data }, { merge: true }).catch(e => console.error("Save Error", e));
                    }
                }
            };

            useEffect(() => saveData('lifeos_sections_v2', sections), [sections, isDataLoaded]);
            useEffect(() => saveData('lifeos_tasks', tasksByDate), [tasksByDate, isDataLoaded]);
            useEffect(() => saveData('lifeos_reviews', reviews), [reviews, isDataLoaded]);
            useEffect(() => saveData('lifeos_theme', globalTheme), [globalTheme, isDataLoaded]);

            // --- Handlers ---
            const handleSaveConfig = (jsonStr) => {
                try {
                    const config = JSON.parse(jsonStr);
                    localStorage.setItem('lifeos_fb_config', JSON.stringify(config));
                    setFirebaseConfig(config);
                    setIsConfigModalOpen(false);
                } catch (e) { alert("配置格式错误"); }
            };

            const handleLogout = async () => {
                if (confirm("确定退出登录？数据将保留在本地 (guest)。")) {
                    await signOut(firebaseAuth);
                }
            };

            const exportData = () => {
                const dataStr = JSON.stringify({ sections, tasksByDate, reviews, globalTheme }, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `lifeos_backup_${generateDateString(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm("这将覆盖当前数据，确定导入吗？")) {
                            if (data.sections) setSections(data.sections);
                            if (data.tasksByDate) setTasksByDate(data.tasksByDate);
                            if (data.reviews) setReviews(data.reviews);
                            if (data.globalTheme) setGlobalTheme(data.globalTheme);
                            alert("导入成功！");
                        }
                    } catch (e) { alert("文件格式错误"); }
                };
                reader.readAsText(file);
            };

            // --- UI State & Logic ---
            const [quote, setQuote] = useState(() => GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]);
            const [reviewDate, setReviewDate] = useState(new Date()); 
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isNoteModalOpen, setIsNoteModalOpen] = useState(false); 
            const [currentTask, setCurrentTask] = useState(null); 
            const [targetSection, setTargetSection] = useState(null); 
            const [editingPriority, setEditingPriority] = useState({ important: false, urgent: false });
            const [isSectionManagerOpen, setIsSectionManagerOpen] = useState(false);
            const [isEditSectionMode, setIsEditSectionMode] = useState(false); 
            const [isQuoteEditing, setIsQuoteEditing] = useState(false);
            const [recurrenceType, setRecurrenceType] = useState('none');
            const [settingsTab, setSettingsTab] = useState('sections'); 
            const [isStatsModalOpen, setIsStatsModalOpen] = useState(false);
            const [statsPeriod, setStatsPeriod] = useState(null); 
            const [isReviewCenterOpen, setIsReviewCenterOpen] = useState(false);
            const [reviewTab, setReviewTab] = useState('daily'); 
            const [inputTime, setInputTime] = useState(''); 
            const [isTimerOpen, setIsTimerOpen] = useState(false);
            const [timerActive, setTimerActive] = useState(false);
            const [timerTime, setTimerTime] = useState(25 * 60); 
            const [initialTime, setInitialTime] = useState(25); 
            const [showCelebration, setShowCelebration] = useState(false);
            const [celebrationQuote, setCelebrationQuote] = useState('');

            const calendarDates = useMemo(() => generateCalendarDates(currentDate), [currentDate]);

            useEffect(() => {
                let interval = null;
                if (timerActive && timerTime > 0) {
                    interval = setInterval(() => { setTimerTime((prev) => prev - 1); }, 1000);
                } else if (timerTime === 0 && timerActive) {
                    setTimerActive(false);
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-fairy-message-chime-2022.mp3');
                    audio.play().catch(e => console.log('Audio play failed', e));
                }
                return () => clearInterval(interval);
            }, [timerActive, timerTime]);

            const toggleTimer = () => setTimerActive(!timerActive);
            const resetTimer = () => { setTimerActive(false); setTimerTime(initialTime * 60); };
            const handleTimeChange = (e) => { const m = parseInt(e.target.value) || 0; setInitialTime(m); if (!timerActive) setTimerTime(m * 60); };
            const tasks = useMemo(() => tasksByDate[selectedDateStr] || {}, [tasksByDate, selectedDateStr]);
            
            const handleReviewDateChange = (direction) => { 
                const newDate = new Date(reviewDate); 
                if (reviewTab === 'daily') newDate.setDate(newDate.getDate() + direction);
                else if (reviewTab === 'weekly') newDate.setDate(newDate.getDate() + direction * 7);
                else if (reviewTab === 'monthly') newDate.setMonth(newDate.getMonth() + direction);
                else if (reviewTab === 'yearly') newDate.setFullYear(newDate.getFullYear() + direction);
                setReviewDate(newDate); 
            };

            const statsData = useMemo(() => {
                if (!statsPeriod) return { data: [], totalMins: 0, avgMins: 0, activeDays: 0 };
                let targetDates = []; const y = currentDate.getFullYear(); const m = currentDate.getMonth();
                if (statsPeriod === 'daily') targetDates.push(generateDateString(currentDate));
                else if (statsPeriod === 'weekly') { const { start } = getWeekRange(currentDate); for(let i=0; i<7; i++) { const temp = new Date(start); temp.setDate(start.getDate() + i); targetDates.push(generateDateString(temp)); } }
                else if (statsPeriod === 'monthly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy, dm] = dateStr.split('-').map(Number); if (dy === y && dm === m + 1) targetDates.push(dateStr); }); }
                else if (statsPeriod === 'yearly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy] = dateStr.split('-').map(Number); if (dy === y) targetDates.push(dateStr); }); }
                let tagMap = {}; let totalMins = 0; let activeDays = new Set(); let completedCount = 0;
                targetDates.forEach(dateStr => { const dayTasks = tasksByDate[dateStr]; if (!dayTasks) return; let hasCompleted = false; [...sections.map(s => s.id), 'fragmentary'].forEach(sec => { (dayTasks[sec] || []).forEach(task => { if (task.completed) { hasCompleted = true; const tag = task.tag || '未分类'; const mins = task.time ? parseDurationFromTimeStr(task.time) : 30; tagMap[tag] = (tagMap[tag] || 0) + mins; totalMins += mins; } }); }); if (hasCompleted) activeDays.add(dateStr); });
                const colors = ['#fca5a5', '#93c5fd', '#6ee7b7', '#fcd34d', '#c4b5fd', '#f9a8d4', '#818cf8', '#34d399', '#fbbf24', '#f87171'];
                const data = Object.keys(tagMap).map((k, i) => ({ tag: k, value: tagMap[k], color: colors[i % colors.length] })).sort((a,b) => b.value - a.value);
                const avgMins = activeDays.size > 0 ? Math.round(totalMins / activeDays.size) : 0;
                return { data, totalMins, avgMins, activeDays: activeDays.size };
            }, [statsPeriod, currentDate, tasksByDate, sections]);

            const stats = useMemo(() => {
                let impUrg = 0, impNotUrg = 0, urgNotImp = 0, notUrgNotImp = 0; 
                const allSectionTasks = sections.flatMap(sec => tasks[sec.id] || []);
                const fragTasks = tasks.fragmentary || [];
                [...allSectionTasks, ...fragTasks].forEach(t => { if (t.important && t.urgent) impUrg++; else if (t.important) impNotUrg++; else if (t.urgent) urgNotImp++; else notUrgNotImp++; });
                return { impUrg, impNotUrg, urgNotImp, notUrgNotImp, total: allSectionTasks.length + fragTasks.length };
            }, [tasks, sections]);

            const dailyProgress = useMemo(() => {
                const allSectionTasks = sections.flatMap(sec => tasks[sec.id] || []);
                if (allSectionTasks.length === 0) return 0;
                return Math.round((allSectionTasks.filter(t => t.completed).length / allSectionTasks.length) * 100);
            }, [tasks, sections]);

            const handleDateSelect = (dateObj) => { setCurrentDate(dateObj); setSelectedDateStr(generateDateString(dateObj)); };
            const handleDatePickerChange = (e) => { if (e.target.value) { const [y, m, d] = e.target.value.split('-').map(Number); handleDateSelect(new Date(y, m - 1, d)); } };
            const handleBackToToday = () => { const today = new Date(); setCurrentDate(today); setSelectedDateStr(generateDateString(today)); };
            
            const handleToggleTask = (task) => { 
                setTasksByDate(prev => { 
                    const newMap = { ...prev };
                    const d = { ...(newMap[selectedDateStr] || {}) }; 
                    let s = null; 
                    // Find section
                    for (const k of [...sections.map(x => x.id), 'fragmentary']) { if (d[k]?.some(t => t.id === task.id)) { s = k; break; } } 
                    
                    if (s) { 
                        // 如果当前是“未完成”状态，准备变成“完成” -> 弹出时间确认
                        let actualEnd = task.actualEnd;
                        let completed = !task.completed;

                        if (!task.completed) {
                            // 弹出确认结束时间
                            const plannedEnd = task.time ? (task.time.split('-')[1] || '') : '';
                            const endTime = confirmActionTime(plannedEnd, "结束");
                            
                            // 如果用户取消，则不改变状态
                            if (endTime === null) return prev;
                            
                            actualEnd = endTime;
                        } else {
                            // 如果是取消完成，清空结束时间
                            actualEnd = '';
                        }

                        const newTasks = d[s].map(t => t.id === task.id ? { ...t, completed, actualEnd } : t);
                        d[s] = newTasks;
                        
                        // 庆祝逻辑保持不变
                        if (completed) {
                            const allDayTasks = []; [...sections.map(sec => sec.id), 'fragmentary'].forEach(secId => { allDayTasks.push(...(secId === s ? newTasks : (d[secId] || []))); });
                            const total = allDayTasks.length; const count = allDayTasks.filter(t => t.completed).length;
                            if (total > 0 && count === total) { setCelebrationQuote(GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]); setShowCelebration(true); }
                        }
                    } 
                    return { ...newMap, [selectedDateStr]: d }; 
                }); 
            };
            
            const handleStartTask = (task, sectionId) => {
                if (task.completed || task.actualStart) return;

                // 提取计划开始时间
                const plannedStart = task.time ? task.time.split('-')[0] : '';
                
                // 弹出确认
                const startTime = confirmActionTime(plannedStart, "开始");
                
                if (startTime !== null) {
                    setTasksByDate(prev => {
                        const newMap = { ...prev };
                        const dateTasks = { ...(newMap[selectedDateStr] || {}) };
                        const listKey = sectionId === 'fragmentary' ? 'fragmentary' : sectionId;

                        if (dateTasks[listKey]) {
                            dateTasks[listKey] = dateTasks[listKey].map(t => {
                                if (t.id === task.id) {
                                    return {
                                        ...t,
                                        actualStart: startTime // 记录确定的时间
                                    };
                                }
                                return t;
                            });
                            newMap[selectedDateStr] = dateTasks;
                        }
                        return newMap;
                    });
                }
            };

            const handleEditTask = (task, sectionId) => { setCurrentTask({ ...task, sectionId }); setTargetSection(sectionId); setEditingPriority({ important: task.important, urgent: task.urgent }); setInputTime(task.time || ''); setRecurrenceType('none'); setIsTaskModalOpen(true); };
            const handleAddTask = (sectionId) => { setCurrentTask(null); setTargetSection(sectionId); setEditingPriority({ important: false, urgent: false }); setInputTime(''); setRecurrenceType('none'); setIsTaskModalOpen(true); };
            const handleOpenNote = (task) => { let s = null; const d = tasksByDate[selectedDateStr] || {}; for (const k of [...sections.map(x => x.id), 'fragmentary']) { if (d[k]?.some(t => t.id === task.id)) { s = k; break; } } setCurrentTask({ ...task, sectionId: s }); setIsNoteModalOpen(true); };
            const saveNote = (e) => { e.preventDefault(); const n = new FormData(e.target).get('note'); setTasksByDate(p => { const ns = { ...p }; const s = currentTask.sectionId; if (ns[selectedDateStr]?.[s]) { ns[selectedDateStr][s] = ns[selectedDateStr][s].map(t => t.id === currentTask.id ? { ...t, note: n } : t); } return ns; }); setIsNoteModalOpen(false); };
            const saveTask = (e) => { 
                e.preventDefault(); const f = new FormData(e.target); const isNew = !currentTask; const id = currentTask ? currentTask.id : Date.now(); const recurrence = f.get('recurrence'); 
                const baseTask = { 
                    title: f.get('title'), 
                    time: inputTime, 
                    tag: f.get('tag'), 
                    note: currentTask?.note || '', 
                    important: editingPriority.important, 
                    urgent: editingPriority.urgent, 
                    completed: currentTask?.completed || false, 
                    recurring: recurrence !== 'none',
                    originalTitle: currentTask?.originalTitle || '', 
                    actualStart: currentTask?.actualStart || '', 
                    actualEnd: currentTask?.actualEnd || ''
                };
                setTasksByDate(prev => { 
                    const newMap = { ...prev };
                    const addToDate = (dateStr, taskToAdd, isFutureSync = false) => { 
                        if (!newMap[dateStr]) newMap[dateStr] = {}; const dateTasks = { ...newMap[dateStr] }; const sectionTasks = [...(dateTasks[targetSection] || [])]; 
                        if (isNew && !isFutureSync) { sectionTasks.push({ ...taskToAdd, id: Date.now() + Math.random() }); } else { 
                            const idx = sectionTasks.findIndex(t => t.id === id); 
                            if (idx > -1 && !isFutureSync) { sectionTasks[idx] = { ...taskToAdd, id }; } 
                            else if (isFutureSync) { const dupIdx = sectionTasks.findIndex(t => t.title === taskToAdd.title && t.time === taskToAdd.time); if (dupIdx > -1) { sectionTasks[dupIdx] = { ...taskToAdd, id: sectionTasks[dupIdx].id }; } else { sectionTasks.push({ ...taskToAdd, id: Date.now() + Math.random() }); } }
                        } 
                        dateTasks[targetSection] = sectionTasks; newMap[dateStr] = dateTasks; 
                    };
                    addToDate(selectedDateStr, baseTask, false);
                    if (recurrence !== 'none') { const startDate = new Date(currentDate); const customDays = f.getAll('customDays').map(Number); for (let i = 1; i <= 30; i++) { const nextDate = new Date(startDate); nextDate.setDate(startDate.getDate() + i); let shouldAdd = false; if (recurrence === 'daily') shouldAdd = true; else if (recurrence === 'custom') { if (customDays.includes(nextDate.getDay())) shouldAdd = true; } if (shouldAdd) { addToDate(generateDateString(nextDate), { ...baseTask, completed: false }, true); } } }
                    return newMap; 
                }); setIsTaskModalOpen(false); 
            };
            const handleDeleteTaskDirectly = (id, s) => { setTasksByDate(prev => { const newDateMap = { ...prev }; const dateData = { ...(newDateMap[selectedDateStr] || {}) }; if (dateData[s]) { dateData[s] = dateData[s].filter(t => t.id !== id); newDateMap[selectedDateStr] = dateData; } return newDateMap; }); };
            const handleSaveSection = (e) => { e.preventDefault(); const f = new FormData(e.target); const s = { id: f.get('id') || `sec_${Date.now()}`, title: f.get('title'), icon: f.get('icon'), color: f.get('color') }; if (f.get('isNew') === 'true') setSections([...sections, s]); else setSections(sections.map(x => x.id === s.id ? s : x)); setIsEditSectionMode(false); };
            const handleDeleteSection = (id) => { if (confirm('确认删除?')) { setSections(sections.filter(s => s.id !== id)); setIsEditSectionMode(false); } };
            const handleTaskRemind = (task) => { downloadICS([task], selectedDateStr, "Task"); };
            const refreshQuote = () => { setQuote(GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]); };
            const openStats = (period) => { setStatsPeriod(period); setIsStatsModalOpen(true); };
            const openReviewCenter = (tab) => { setReviewTab(tab); setReviewDate(currentDate); setIsReviewCenterOpen(true); };

            // Render Loading if Data not ready
            if (!isDataLoaded) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 flex-col gap-4">
                        <Loader2 className="w-8 h-8 text-blue-500 animate-spin" />
                        <span className="text-sm text-gray-500 font-medium">正在加载数据...</span>
                    </div>
                );
            }
            
            // [新增] 任务排序与冲突检测逻辑
            const processTasksForTimeline = (taskList) => {
                if (!taskList || taskList.length === 0) return [];

                // 1. 分离有时段任务和无时段任务
                const timedTasks = [];
                const untimedTasks = [];

                taskList.forEach(t => {
                    const startMins = getMinutes(t.actualStart || t.time); // 优先使用实际开始时间
                    if (startMins !== -1) {
                        // 结束时间逻辑：有实际结束用实际，没实际用计划
                        // 注意：这里需要处理 actualStart 可能是 "09:15" 这种格式
                        // 为了简化，假设 actualStart 也是 HH:MM 格式（虽然上面代码是 ISOString，但在 confirmActionTime 里做了处理）
                        // 如果是 ISOString，需要先提取 HH:MM
                        let displayStart = t.actualStart || (t.time ? t.time.split('-')[0] : '');
                        if (displayStart.includes('T')) displayStart = displayStart.split('T')[1].substring(0, 5);

                        let displayEnd = t.actualEnd || (t.time ? t.time.split('-')[1] : '');
                        if (displayEnd && displayEnd.includes('T')) displayEnd = displayEnd.split('T')[1].substring(0, 5);

                        const startVal = timeToMins(displayStart);
                        const endVal = timeToMins(displayEnd);

                        timedTasks.push({ 
                            ...t, 
                            _startMins: startVal, 
                            _endMins: endVal 
                        });
                    } else {
                        untimedTasks.push(t);
                    }
                });

                // 2. 按开始时间排序
                timedTasks.sort((a, b) => a._startMins - b._startMins);

                // 3. 冲突检测
                let maxEndTime = -1;
                const processedTimedTasks = timedTasks.map((t, index) => {
                    let isOverlap = false;
                    // 如果不是第一个任务，且当前任务开始时间 < 上一个任务区域的最大结束时间
                    if (index > 0 && t._startMins < maxEndTime) {
                        isOverlap = true;
                    }
                    
                    // 更新 maxEndTime
                    if (t._endMins > maxEndTime) {
                        maxEndTime = t._endMins;
                    }

                    return { ...t, isOverlap };
                });

                // 4. 合并列表 (无时间任务在最后)
                return [...processedTimedTasks, ...untimedTasks];
            };

            return (
                <div className={`min-h-screen font-sans text-slate-800 pb-20 selection:bg-blue-100 ${PALETTE[globalTheme.pageBg]?.bg || 'bg-[#F5F7FA]'}`}>
                    
                    {/* Header: 极度紧凑优化版 */}
                    <div className={`sticky top-0 z-50 shadow-sm rounded-b-xl mb-3 transition-all ${PALETTE[globalTheme.headerBg]?.bg || 'bg-white'}`}>
                        <header className="px-3 pt-2 pb-0">
                            <div className="flex flex-col md:flex-row justify-between items-center mb-1 gap-1">
                                {/* Top Row: Date + Mobile Buttons */}
                                <div className="flex items-center gap-2 shrink-0 w-full md:w-auto justify-between md:justify-start">
                                    <div className="flex items-center gap-1">
                                        <div className="relative group">
                                            <div className="flex items-center gap-0.5 text-2xl font-black text-slate-800 cursor-pointer hover:text-blue-600 transition-colors tracking-tight" title="选择日期">{currentDate.getFullYear()}.{currentDate.getMonth() + 1}</div>
                                            <input type="date" className="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10" onChange={handleDatePickerChange} />
                                        </div>
                                        {selectedDateStr !== generateDateString(new Date()) && (<button onClick={handleBackToToday} className="px-2 py-0.5 bg-blue-50 text-blue-600 text-[10px] font-bold rounded-md hover:bg-blue-100 flex items-center gap-1 shadow-sm transition-all z-20 active:scale-95"><RotateCcw className="w-3 h-3" />今天</button>)}
                                    </div>
                                    <div className="flex gap-2">
                                        {/* 新增：板块管理按钮移至此处 (Mobile) */}
                                        <button onClick={() => setIsSectionManagerOpen(true)} className="md:hidden flex items-center gap-1 text-[10px] px-2 py-1 rounded-full bg-gray-50 border border-gray-200 text-gray-600"><Settings2 className="w-3 h-3" /></button>
                                        <button onClick={() => { if (!user) setIsConfigModalOpen(true); else setIsAuthModalOpen(true); }} className="md:hidden flex items-center gap-1 text-[10px] px-2 py-1 rounded-full bg-blue-50 border border-blue-100 text-blue-600"><Cloud className="w-3 h-3" /></button>
                                        <button onClick={(e) => { e.stopPropagation(); openReviewCenter('daily'); }} className="md:hidden bg-[#1E293B] text-white px-3 py-1 rounded-full text-[10px] font-bold flex items-center gap-1 hover:bg-slate-700 transition active:scale-95 shadow-lg shadow-slate-200 whitespace-nowrap"><LayoutGrid className="w-3 h-3" /> 复盘</button>
                                    </div>
                                </div>

                                {/* Quote - 更加紧凑 */}
                                <div className="flex-1 flex justify-center w-full md:w-auto order-last md:order-none -mt-0.5 md:mt-0">
                                    <div className="flex items-center gap-2 group cursor-pointer transition-all hover:scale-105 px-2 py-0.5 rounded-lg hover:bg-gray-50/50" onClick={() => !isQuoteEditing && setIsQuoteEditing(true)}>
                                        <span className="hidden lg:flex bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-0.5 rounded-full items-center gap-1 shrink-0 shadow-sm border border-orange-200">🔥 3 天</span>
                                        {isQuoteEditing ? (<input autoFocus className="text-xs font-serif font-medium text-gray-700 border-b-2 border-blue-500 outline-none text-center min-w-[200px] bg-transparent" value={quote} onChange={(e) => setQuote(e.target.value)} onBlur={() => setIsQuoteEditing(false)} onKeyDown={(e) => e.key === 'Enter' && setIsQuoteEditing(false)} />) : (<div className="flex items-center gap-1"><p className="text-slate-500 text-xs font-serif font-medium hover:text-blue-600 transition-colors text-center italic truncate max-w-[240px] md:max-w-md scale-90 origin-center" title="点击编辑语录">“{quote}”</p><button onClick={(e) => { e.stopPropagation(); refreshQuote(); }} className="text-gray-300 hover:text-blue-500 transition-colors shrink-0 p-0.5 rounded-full hover:bg-gray-100" title="随机切换"><Shuffle className="w-2.5 h-2.5" /></button></div>)}
                                    </div>
                                </div>

                                <div className="hidden md:flex items-center gap-3 shrink-0">
                                    <div className="flex items-center gap-2">
                                        {/* 新增：板块管理按钮移至此处 (Desktop) */}
                                        <button onClick={() => setIsSectionManagerOpen(true)} title="板块管理" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition"><Settings2 className="w-4 h-4"/></button>
                                        <button onClick={exportData} title="导出数据 (JSON)" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition"><Download className="w-4 h-4"/></button>
                                        <label title="导入数据" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition cursor-pointer"><Upload className="w-4 h-4"/><input type="file" className="hidden" accept=".json" onChange={importData}/></label>
                                    </div>
                                    <div className="h-4 w-px bg-gray-200"></div>
                                    
                                    {!firebaseConfig ? (
                                        <button onClick={() => setIsConfigModalOpen(true)} className="text-[10px] bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full border border-gray-200 flex items-center gap-1 hover:bg-gray-200 transition"><Cloud className="w-3 h-3"/> 连接云端</button>
                                    ) : !user ? (
                                        <button onClick={() => setIsAuthModalOpen(true)} className="text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full border border-blue-200 flex items-center gap-1 hover:bg-blue-100 transition"><LogIn className="w-3 h-3"/> 登录同步</button>
                                    ) : (
                                        <button onClick={handleLogout} className="text-[10px] bg-green-50 text-green-600 px-3 py-1.5 rounded-full border border-green-200 flex items-center gap-1 hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition group"><User className="w-3 h-3"/> {user.email.split('@')[0]} <LogOut className="w-3 h-3 hidden group-hover:block ml-1"/></button>
                                    )}
                                    
                                    <button onClick={(e) => { e.stopPropagation(); openReviewCenter('daily'); }} className="bg-[#1E293B] text-white px-5 py-2 rounded-full text-xs font-bold flex items-center gap-2 hover:bg-slate-700 transition active:scale-95 shadow-lg shadow-slate-200 whitespace-nowrap"><LayoutGrid className="w-4 h-4" /> 复盘/目标</button>
                                </div>
                            </div>
                        </header>
                        
                        {/* Calendar Strip - 高度压缩至 h-10, 字体加大 */}
                        <div className="pb-1 px-1">
                            <div className="flex justify-between items-center px-0.5">
                                <button onClick={() => handleDateSelect(new Date(currentDate.setDate(currentDate.getDate() - 1)))} className="p-1 text-gray-300 hover:text-gray-600"><ChevronLeft className="w-4 h-4" /></button>
                                <div className="flex-1 flex justify-between px-1 overflow-x-auto overflow-y-hidden scrollbar-hide">
                                    {calendarDates.map((d, i) => { const isActive = d.fullDate === selectedDateStr; return (<div key={i} onClick={() => handleDateSelect(d.obj)} className={`flex flex-col items-center justify-center min-w-[36px] h-10 rounded-lg cursor-pointer transition-all mx-0.5 ${isActive ? 'bg-blue-600 text-white shadow-lg shadow-blue-200 scale-105' : 'text-gray-400 hover:bg-gray-50'}`}><span className="text-[10px] mb-0 opacity-90 font-medium">{d.dayName}</span><span className="text-lg font-black leading-none">{d.dateNum}</span></div>); })}
                                </div>
                                <button onClick={() => handleDateSelect(new Date(currentDate.setDate(currentDate.getDate() + 1)))} className="p-1 text-gray-300 hover:text-gray-600"><ChevronRight className="w-4 h-4" /></button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto px-4 md:px-6">
                        <div className="bg-white rounded-xl p-3 shadow-sm mb-3 flex justify-between items-center relative z-10">
                            <div className="flex gap-4 md:gap-16 overflow-x-auto scrollbar-hide w-full md:w-auto">
                                <CircularProgress onClick={() => openStats('daily')} percentage={dailyProgress} label="今日" subLabel="已完成" colorClass="text-blue-400" trackClass="text-blue-50" />
                                <CircularProgress onClick={() => openStats('weekly')} percentage={50} label="本周" subLabel="数据中" colorClass="text-indigo-400" trackClass="text-indigo-50" />
                                <CircularProgress onClick={() => openStats('monthly')} percentage={30} label="本月" subLabel="进行中" colorClass="text-orange-400" trackClass="text-orange-50" />
                                <CircularProgress onClick={() => openStats('yearly')} percentage={10} label="年度" subLabel="积累中" colorClass="text-red-400" trackClass="text-red-50" />
                            </div>
                            <div className="flex flex-col items-center cursor-pointer group ml-4 shrink-0" onClick={() => setIsTimerOpen(true)}>
                                <button className={`bg-slate-100 rounded-full p-2 mb-1 relative transition-all group-hover:bg-slate-200 ${timerActive ? 'ring-2 ring-red-300 animate-pulse' : ''}`}><div className="text-xs font-bold text-slate-700 min-w-[32px] text-center">{timerActive ? formatTime(timerTime) : `${initialTime}:00`}</div><span className="absolute -top-1 -right-1 text-lg">🍅</span></button><div className="text-[10px] text-gray-400 group-hover:text-red-500">专注</div>
                            </div>
                        </div>
                        
                        {/* 统计卡片：极度扁平化 + 紧凑网格 */}
                        <div className="grid grid-cols-4 gap-1.5 mb-2">
                            <StatCard number={stats.impUrg} title="重要紧急" subText={`${Math.round(stats.impUrg/stats.total*100) || 0}%`} colorTheme="red" />
                            <StatCard number={stats.impNotUrg} title="重要不急" subText={`${Math.round(stats.impNotUrg/stats.total*100) || 0}%`} colorTheme="orange" />
                            <StatCard number={stats.urgNotImp} title="紧急不重" subText={`${Math.round(stats.urgNotImp/stats.total*100) || 0}%`} colorTheme="blue" />
                            <StatCard number={stats.notUrgNotImp} title="不急不重" subText={`${Math.round(stats.notUrgNotImp/stats.total*100) || 0}%`} colorTheme="green" />
                        </div>
                        
                        {/* 任务看板区域 - 删除了标题行，直接展示内容 */}
                        <div className="grid grid-cols-1 gap-3 mb-6">
                            {sections.map(section => (
                                <div key={section.id}>
                                    <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2"><React.Fragment>{React.createElement(ICON_MAP[section.icon] || Circle, { className: `w-5 h-5 ${COLOR_THEMES[section.color]?.icon || 'text-gray-400'} fill-current` })}</React.Fragment><h2 className={`font-bold text-lg ${COLOR_THEMES[section.color]?.text || 'text-gray-700'}`}>{section.title}</h2></div><button onClick={() => downloadICS(tasks[section.id], selectedDateStr, section.title)} className={`text-xs px-3 py-1.5 rounded-full flex items-center gap-1 transition-colors ${COLOR_THEMES[section.color]?.bg || 'bg-gray-100'} ${COLOR_THEMES[section.color]?.text || 'text-gray-600'} ${COLOR_THEMES[section.color]?.buttonBg || 'hover:bg-gray-200'}`}><Bell className="w-3 h-3" /> 提醒</button></div>
                                    <div className={`space-y-2 min-h-[50px] p-2.5 rounded-xl border border-dashed ${COLOR_THEMES[section.color]?.border || 'border-gray-200'} ${COLOR_THEMES[section.color]?.bg || 'bg-gray-50'} bg-opacity-30`}>
                                        {(!tasks[section.id] || tasks[section.id].length === 0) && <div className="text-center py-4 text-gray-400 text-xs">本日暂无安排</div>}
                                        {/* [修改点] 使用新的排序和冲突检测逻辑 */}
                                        {processTasksForTimeline(tasks[section.id]).map(task => (
                                            <TaskCard 
                                                key={task.id} 
                                                task={task} 
                                                onToggle={handleToggleTask} 
                                                onEdit={(t) => handleEditTask(t, section.id)} 
                                                onDelete={(id) => handleDeleteTaskDirectly(id, section.id)} 
                                                onNote={handleOpenNote} 
                                                onRemind={handleTaskRemind} 
                                                onStart={(t) => handleStartTask(t, section.id)} 
                                                cardStyle={globalTheme.cardStyle} 
                                                sectionColor={section.color}
                                                // 传递冲突状态
                                                isOverlap={task.isOverlap}
                                            />
                                        ))}
                                    </div>
                                    <button onClick={() => handleAddTask(section.id)} className={`w-full py-3 mt-3 rounded-xl border-2 border-dashed ${COLOR_THEMES[section.color]?.border || 'border-gray-300'} ${COLOR_THEMES[section.color]?.text || 'text-gray-500'} flex items-center justify-center hover:${COLOR_THEMES[section.color]?.bg || 'bg-gray-100'} transition-colors group`}><Plus className="w-5 h-5 group-hover:scale-110 transition-transform" /></button>
                                </div>
                            ))}
                        </div>

                        <div className="bg-white rounded-xl p-4 shadow-sm mb-8">
                            <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-3"><span className="bg-yellow-100 text-yellow-600 text-xs font-bold px-2 py-1 rounded">TODO</span><span className="font-bold text-slate-700">碎片清单</span></div><button onClick={() => handleAddTask('fragmentary')} className="px-3 py-1.5 bg-blue-50 text-blue-600 text-xs rounded hover:bg-blue-100 transition flex items-center gap-1"><Plus className="w-3 h-3" /> 添加</button></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                {/* [修改点] 碎片清单依然保持基础排序，无需冲突检测 */}
                                {tasks.fragmentary && [...tasks.fragmentary].sort((a, b) => {
                                    const timeA = a.time ? a.time.split('-')[0] : '23:59';
                                    const timeB = b.time ? b.time.split('-')[0] : '23:59';
                                    return timeA.localeCompare(timeB);
                                }).map(task => (
                                    <div key={task.id} onClick={() => handleToggleTask(task)} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition group relative">
                                        <div className="flex items-center gap-3"><button onClick={(e) => { e.stopPropagation(); handleToggleTask(task); }} className="text-gray-300 hover:text-indigo-500 flex-shrink-0">{task.completed ? <CheckCircle2 className="w-5 h-5 text-indigo-500" /> : <Circle className="w-5 h-5" />}</button><span className={`text-sm text-gray-700 ${task.completed ? 'line-through text-gray-400' : ''}`}>{task.title}</span></div>
                                        <div className="flex items-center gap-1">
                                            <button onClick={(e) => { e.stopPropagation(); handleEditTask(task, 'fragmentary'); }} className="p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded transition"><Edit3 className="w-3.5 h-3.5" /></button>
                                            <button onClick={(e) => { e.stopPropagation(); handleDeleteTaskDirectly(task.id, 'fragmentary'); }} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition"><Trash2 className="w-3.5 h-3.5" /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Modals */}
                    <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title={currentTask ? "编辑任务" : "添加新任务"}>
                        <form onSubmit={saveTask} className="flex flex-col gap-5 p-1">
                            <div><label className="block text-xs font-bold text-gray-500 mb-1.5">任务名称</label><input name="title" defaultValue={currentTask?.title} placeholder="例如：阅读30分钟" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" required autoFocus /></div>
                            <div className="flex items-end gap-4"><div className="flex-1"><label className="block text-xs font-bold text-gray-500 mb-1.5">时间段</label><TimeRangePicker value={inputTime} onChange={setInputTime} key={currentTask?.id || 'new'} /></div><div className="w-24 shrink-0"><label className="block text-xs font-bold text-gray-500 mb-1.5">标签</label><input list="tag-suggestions" name="tag" defaultValue={currentTask?.tag} placeholder="如: 工作" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-2 py-2.5 text-xs text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" /><datalist id="tag-suggestions"><option value="工作" /><option value="学习" /><option value="生活" /><option value="运动" /></datalist></div></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-2">重要/紧急程度</label><div className="flex justify-around bg-gray-50 p-3.5 rounded-xl border border-gray-200"><button type="button" onClick={() => setEditingPriority({ important: true, urgent: true })} className={`flex flex-col items-center gap-1.5 transition-all ${editingPriority.important && editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-indigo-500 ${editingPriority.important && editingPriority.urgent ? 'ring-2 ring-offset-2 ring-indigo-300' : ''}`}></div><span className="text-[10px] font-bold text-indigo-700">重要紧急</span></button><button type="button" onClick={() => setEditingPriority({ important: true, urgent: false })} className={`flex flex-col items-center gap-1.5 transition-all ${editingPriority.important && !editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-blue-500 ${editingPriority.important && !editingPriority.urgent ? 'ring-2 ring-offset-2 ring-blue-300' : ''}`}></div><span className="text-[10px] font-bold text-blue-700">重要不急</span></button><button type="button" onClick={() => setEditingPriority({ important: false, urgent: true })} className={`flex flex-col items-center gap-1.5 transition-all ${!editingPriority.important && editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-red-500 ${!editingPriority.important && editingPriority.urgent ? 'ring-2 ring-offset-2 ring-red-300' : ''}`}></div><span className="text-[10px] font-bold text-red-700">紧急不重</span></button><button type="button" onClick={() => setEditingPriority({ important: false, urgent: false })} className={`flex flex-col items-center gap-1.5 transition-all ${!editingPriority.important && !editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-emerald-500 ${!editingPriority.important && !editingPriority.urgent ? 'ring-2 ring-offset-2 ring-emerald-300' : ''}`}></div><span className="text-[10px] font-bold text-emerald-700">不急不重</span></button></div></div>
                            <div className="bg-blue-50/50 p-3.5 rounded-xl border border-blue-100 flex flex-col gap-3"><div className="flex items-center justify-between"><div className="flex items-center gap-1.5"><Repeat className="w-4 h-4 text-blue-500" /><label className="text-xs font-bold text-blue-700">同步/重复(未来30天)</label></div><div className="flex gap-3 text-xs font-medium text-blue-800"><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="none" checked={recurrenceType === 'none'} onChange={() => setRecurrenceType('none')} className="accent-blue-600" />单次</label><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="daily" checked={recurrenceType === 'daily'} onChange={() => setRecurrenceType('daily')} className="accent-blue-600" />每天</label><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="custom" checked={recurrenceType === 'custom'} onChange={() => setRecurrenceType('custom')} className="accent-blue-600" />自定义</label></div></div>{recurrenceType === 'custom' && (<div className="flex justify-between mt-1 px-2">{['日', '一', '二', '三', '四', '五', '六'].map((d, i) => (<label key={i} className="flex flex-col items-center cursor-pointer group"><input type="checkbox" name="customDays" value={i} className="peer sr-only" /><div className="w-7 h-7 rounded-full bg-white border border-blue-200 flex items-center justify-center text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all group-hover:border-blue-400">{d}</div></label>))}</div>)}</div>
                            <div className="flex gap-3 mt-2"><button type="button" onClick={() => setIsTaskModalOpen(false)} className="px-5 py-2.5 text-gray-500 text-sm bg-gray-100 hover:bg-gray-200 rounded-xl transition font-bold">取消</button><button type="submit" className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-md shadow-blue-200"><Save className="w-4 h-4" /> 保存</button></div>
                        </form>
                    </Modal>
                    
                    <Modal isOpen={isNoteModalOpen} onClose={() => setIsNoteModalOpen(false)} title="添加/编辑备注">
                        <form onSubmit={saveNote} className="flex flex-col gap-4">
                            <div className="bg-yellow-50 p-3 rounded-lg mb-2"><h4 className="text-sm font-bold text-gray-800 mb-1">{currentTask?.title}</h4><p className="text-xs text-gray-500">在这个任务中记录想法或细节...</p></div>
                            <textarea name="note" defaultValue={currentTask?.note} placeholder="例如：会议纪要、阅读笔记、购物清单..." className="w-full h-32 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" autoFocus />
                            <div className="flex justify-end gap-3 mt-2"><button type="button" onClick={() => setIsNoteModalOpen(false)} className="px-4 py-2 text-gray-500 text-sm hover:bg-gray-100 rounded-lg transition">取消</button><button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition flex items-center gap-2"><Save className="w-4 h-4" /> 保存备注</button></div>
                        </form>
                    </Modal>

                    <Modal isOpen={isSectionManagerOpen} onClose={() => {setIsSectionManagerOpen(false); setIsEditSectionMode(false); setSettingsTab('sections')}} title="自定义板块管理">
                        <div className="flex flex-col h-full"><div className="flex border-b border-gray-100 mb-4"><button onClick={() => setSettingsTab('sections')} className={`flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'sections' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400'}`}>板块管理</button><button onClick={() => setSettingsTab('appearance')} className={`flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'appearance' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400'}`}>外观设置</button></div>{settingsTab === 'sections' && (<div className="space-y-4">{!isEditSectionMode ? (<><button onClick={() => setIsEditSectionMode({ isNew: true })} className="w-full py-2 bg-blue-50 text-blue-600 rounded-lg mb-2 font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition"><Plus className="w-4 h-4"/> 新增板块</button>{sections.map(s => <div key={s.id} className="flex justify-between p-3 border border-gray-100 rounded-xl items-center bg-gray-50 hover:bg-white hover:shadow-sm transition"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-lg flex items-center justify-center ${COLOR_THEMES[s.color]?.bg || 'bg-gray-200'} ${COLOR_THEMES[s.color]?.text || 'text-gray-700'}`}>{React.createElement(ICON_MAP[s.icon] || Circle, { className: "w-5 h-5" })}</div><span className="font-bold text-slate-700">{s.title}</span></div><div className="flex gap-2"><button onClick={() => setIsEditSectionMode(s)} className="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition"><Edit3 className="w-4 h-4" /></button><button onClick={() => handleDeleteSection(s.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"><Trash2 className="w-4 h-4" /></button></div></div>)}</>) : (<form onSubmit={handleSaveSection} className="flex flex-col gap-5"><input type="hidden" name="id" value={isEditSectionMode.id || ''} /><input type="hidden" name="isNew" value={isEditSectionMode.isNew ? 'true' : 'false'} /><div><label className="block text-xs font-bold text-gray-500 mb-2">板块名称</label><input name="title" defaultValue={isEditSectionMode.title} placeholder="例如: 晨间阅读" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div><div><label className="block text-xs font-bold text-gray-500 mb-2">选择图标</label><div className="grid grid-cols-4 gap-2">{Object.keys(ICON_MAP).map(k=><label key={k} className="cursor-pointer"><input type="radio" name="icon" value={k} defaultChecked={isEditSectionMode.icon===k} className="peer sr-only"/><div className="w-full h-12 rounded-xl bg-gray-50 border border-gray-100 flex items-center justify-center text-gray-400 peer-checked:bg-blue-50 peer-checked:border-blue-200 peer-checked:text-blue-600 hover:bg-gray-100 transition">{React.createElement(ICON_MAP[k], { className: "w-5 h-5" })}</div></label>)}</div></div><div><label className="block text-xs font-bold text-gray-500 mb-3">主题色系</label><div className="grid grid-cols-4 gap-3">{Object.keys(COLOR_THEMES).map(k=>(<label key={k} className="cursor-pointer flex flex-col items-center gap-1 group"><input type="radio" name="color" value={k} defaultChecked={isEditSectionMode.color===k} className="peer sr-only"/><div className={`w-10 h-10 rounded-full shadow-sm border-2 border-white transition-all peer-checked:scale-110 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-300 ${COLOR_THEMES[k].preview} group-hover:scale-105`}></div><span className="text-[10px] text-gray-400 peer-checked:text-gray-800 font-medium">{COLOR_THEMES[k].label}</span></label>))}</div></div><div className="flex gap-3 pt-2"><button type="button" onClick={() => setIsEditSectionMode(false)} className="flex-1 py-3 text-gray-500 text-sm font-bold hover:bg-gray-100 rounded-xl transition">取消</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200">保存板块</button></div></form>)}</div>)}{settingsTab === 'appearance' && (<div className="space-y-6 pb-4"><div><label className="block text-xs font-bold text-gray-500 mb-3 flex items-center gap-1"><Layout className="w-4 h-4"/> 页面大背景</label><div className="grid grid-cols-3 sm:grid-cols-4 gap-3">{Object.keys(PALETTE).map(key => (<button key={key} onClick={() => setGlobalTheme(prev => ({ ...prev, headerBg: key }))} className={`h-10 rounded-xl border-2 transition-all flex items-center justify-center text-[10px] font-bold ${PALETTE[key].bg} ${PALETTE[key].text} ${globalTheme.headerBg === key ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-200 hover:border-gray-300'}`}>{PALETTE[key].label}</button>))}</div></div><div><label className="block text-xs font-bold text-gray-500 mb-3 flex items-center gap-1"><ListTodo className="w-4 h-4"/> 任务卡片风格</label><div className="flex gap-4"><button onClick={() => setGlobalTheme(prev => ({ ...prev, cardStyle: 'default' }))} className={`flex-1 p-3 rounded-xl border-2 transition-all ${globalTheme.cardStyle === 'default' ? 'border-blue-500 ring-2 ring-blue-200 bg-blue-50' : 'border-gray-200 bg-white hover:bg-gray-50'}`}><div className="bg-white border border-gray-200 rounded-lg p-3 mb-2 shadow-sm"><div className="flex items-center gap-2 mb-2"><div className="w-3 h-3 rounded-full border-2 border-gray-300"></div><div className="w-16 h-2 bg-gray-200 rounded"></div></div><div className="w-24 h-2 bg-gray-100 rounded ml-5"></div></div><div className={`text-sm font-bold text-center ${globalTheme.cardStyle === 'default' ? 'text-blue-700' : 'text-gray-600'}`}>简约白</div></button><button onClick={() => setGlobalTheme(prev => ({ ...prev, cardStyle: 'colored' }))} className={`flex-1 p-3 rounded-xl border-2 transition-all ${globalTheme.cardStyle === 'colored' ? 'border-blue-500 ring-2 ring-blue-200 bg-blue-50' : 'border-gray-200 bg-white hover:bg-gray-50'}`}><div className="bg-orange-50 border border-orange-100 rounded-lg p-3 mb-2 shadow-sm"><div className="flex items-center gap-2 mb-2"><div className="w-3 h-3 rounded-full border-2 border-orange-300"></div><div className="w-16 h-2 bg-orange-300 rounded"></div></div><div className="w-24 h-2 bg-orange-200 rounded ml-5"></div></div><div className={`text-sm font-bold text-center ${globalTheme.cardStyle === 'colored' ? 'text-blue-700' : 'text-gray-600'}`}>跟随色系</div></button></div></div></div>)}</div>
                    </Modal>

                    <Modal isOpen={isReviewCenterOpen} onClose={() => setIsReviewCenterOpen(false)} title="复盘与目标中心" fullScreen>
                        <div className="flex flex-col h-full bg-[#f8fafc]"><div className="flex px-4 pt-4 border-b border-gray-100 bg-white flex-shrink-0 gap-4 overflow-x-auto scrollbar-hide">{['daily', 'weekly', 'monthly', 'yearly'].map(t => (<button key={t} onClick={() => setReviewTab(t)} className={`pb-3 px-1 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${reviewTab === t ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400 hover:text-gray-600'}`}>{t === 'daily' ? '每日复盘' : t === 'weekly' ? '周复盘' : t === 'monthly' ? '月度总结' : '年度回顾'}</button>))}</div><div className="bg-white px-4 py-2 border-b border-gray-100 flex items-center justify-between flex-shrink-0 shadow-sm z-10"><button onClick={() => handleReviewDateChange(-1)} className="p-1 hover:bg-gray-100 rounded"><ChevronLeft className="w-5 h-5 text-gray-400"/></button><span className="text-sm font-bold text-slate-700">{getPeriodLabel(reviewTab, reviewDate)}</span><button onClick={() => handleReviewDateChange(1)} className="p-1 hover:bg-gray-100 rounded"><ChevronRight className="w-5 h-5 text-gray-400"/></button></div><div className="flex-1 overflow-y-auto custom-scrollbar">{reviewTab === 'daily' ? (<DailyReviewContent reviewDate={reviewDate} reviews={reviews} setReviews={setReviews} />) : (<PeriodReviewContent period={reviewTab} reviewDate={reviewDate} reviews={reviews} setReviews={setReviews} tasksByDate={tasksByDate} sections={sections} />)}</div></div>
                    </Modal>

                    <Modal isOpen={isStatsModalOpen} onClose={() => setIsStatsModalOpen(false)} title={`${statsPeriod === 'daily' ? '今日' : statsPeriod === 'weekly' ? '本周' : statsPeriod === 'monthly' ? '本月' : '年度'}专注统计`}>
                        <div className="p-4 bg-white min-h-[400px]">{statsData.data.length > 0 ? (<div className="flex flex-col items-center"><AdvancedPieChart data={statsData.data} totalMins={statsData.totalMins} /><div className="mt-8 text-center w-full pt-4 border-t border-gray-100"><p className="text-gray-800 font-bold text-lg mb-1">总计 {Math.floor(statsData.totalMins / 60)} 小时 {statsData.totalMins % 60} 分钟{statsPeriod !== 'daily' && ` 日均 ${statsData.avgMins} 分钟`}</p><p className="text-gray-400 text-xs mt-2">基于 {statsData.activeDays} 天的打卡数据计算</p></div></div>) : (<div className="flex flex-col items-center justify-center h-64 text-center"><div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4"><PieChart className="w-8 h-8 text-gray-300" /></div><p className="text-gray-500 font-medium">当前时间段还没有完成的任务哦~</p><p className="text-xs text-gray-400 mt-2">快去勾选完成任务来生成时间统计图吧！</p></div>)}</div>
                    </Modal>

                    <Modal isOpen={isTimerOpen} onClose={() => setIsTimerOpen(false)} title="专注番茄钟">
                        <div className="flex flex-col items-center justify-center p-4"><div className="relative w-48 h-48 mb-6"><svg className="w-full h-full transform -rotate-90"><circle cx="96" cy="96" r="88" stroke="#f1f5f9" strokeWidth="12" fill="transparent" /><circle cx="96" cy="96" r="88" stroke="#f87171" strokeWidth="12" fill="transparent" strokeDasharray={2 * Math.PI * 88} strokeDashoffset={(2 * Math.PI * 88) * (1 - timerTime / (initialTime * 60))} strokeLinecap="round" className="transition-all duration-1000 ease-linear" /></svg><div className="absolute inset-0 flex items-center justify-center text-4xl font-bold text-slate-700">{formatTime(timerTime)}</div></div><div className="flex gap-4 items-center mb-6"><button onClick={toggleTimer} className={`p-4 rounded-full text-white shadow-lg transition-transform active:scale-95 ${timerActive ? 'bg-orange-400' : 'bg-green-500'}`}>{timerActive ? <Pause className="w-8 h-8 fill-current" /> : <Play className="w-8 h-8 fill-current ml-1" />}</button><button onClick={resetTimer} className="p-4 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors" title="重置"><RotateCcw className="w-6 h-6" /></button></div><div className="w-full bg-gray-50 p-4 rounded-xl border border-gray-100"><label className="block text-xs font-bold text-gray-500 mb-2 flex items-center gap-1"><Timer className="w-3 h-3" /> 设置时长 (分钟)</label><div className="flex gap-2">{[25, 30, 45, 60].map(mins => (<button key={mins} onClick={() => { setInitialTime(mins); setTimerTime(mins * 60); setTimerActive(false); }} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-colors ${initialTime === mins ? 'bg-white text-blue-600 shadow-sm border border-blue-100' : 'text-gray-400 hover:text-gray-600'}`}>{mins}</button>))}</div><input type="range" min="1" max="120" value={initialTime} onChange={handleTimeChange} className="w-full mt-4 accent-red-400" /></div></div>
                    </Modal>

                    <Modal isOpen={showCelebration} onClose={() => setShowCelebration(false)} title="🎉 每日目标达成！">
                        <div className="p-6 flex flex-col items-center justify-center text-center"><WateringAnimation /><h3 className="text-xl font-bold text-slate-800 mt-6 mb-3">你真棒！</h3><p className="text-slate-600 text-sm leading-relaxed max-w-xs mx-auto italic">"{celebrationQuote}"</p><button onClick={() => setShowCelebration(false)} className="mt-8 px-6 py-2 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-full font-bold shadow-lg shadow-pink-200 hover:scale-105 transition-transform">继续保持 💪</button></div>
                    </Modal>

                    {/* New Modals for Cloud Sync */}
                    <ConfigModal isOpen={isConfigModalOpen} onClose={() => setIsConfigModalOpen(false)} onSave={handleSaveConfig} />
                    <AuthModal isOpen={isAuthModalOpen} onClose={() => setIsAuthModalOpen(false)} auth={firebaseAuth} />

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
