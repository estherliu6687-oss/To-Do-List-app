<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS - æ··åˆäº‘åŒæ­¥ç‰ˆ (Pro)</title>
    
    <!-- iOS Web App é€‚é… -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LifeOS">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: åŠ è½½ React å’Œ Firebase -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <style>
        /* å…¨å±€æ ·å¼ä¿®æ­£ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes grow { from { stroke-dasharray: 0 100; } to { stroke-dasharray: 100 0; } }
        @keyframes drop { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(60px); opacity: 0; } }
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        input, textarea { font-size: 16px !important; } /* é˜²æ­¢iOSç¼©æ”¾ */
    </style>
</head>
<body class="bg-[#F5F7FA]">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "firebase/firestore";
        import { 
            ChevronLeft, ChevronRight, Bell, PenLine, LayoutGrid, CheckCircle2, Circle,
            Plus, RefreshCcw, Zap, Coffee, Moon, X, Trash2, Save, Sun, Briefcase,
            BookOpen, Dumbbell, Music, Settings2, Edit3, Clock, Repeat, RotateCcw,
            StickyNote, Play, Pause, Timer, PieChart, BarChart3, Calendar as CalendarIcon,
            Target, Heart, TrendingUp, ListTodo, Sparkles, Check, Download, Palette,
            Layout, PanelTop, Shuffle, Cloud, Loader2, LogIn, LogOut, User, Lock, Mail, AlertCircle, HardDrive, Upload
        } from 'lucide-react';

        // --- 2. Utilities ---
        const generateDateString = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getDayName = (dayIndex) => ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][dayIndex];

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };

        const getWeekRange = (date) => {
            const day = date.getDay(); 
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const start = new Date(date);
            start.setDate(diff);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            return { start, end };
        };

        const getReviewId = (period, date) => {
            if (period === 'daily') return generateDateString(date);
            if (period === 'weekly') {
                const { start } = getWeekRange(date);
                return `W_${start.getFullYear()}_${getWeekNumber(start)}`;
            }
            if (period === 'monthly') return `M_${date.getFullYear()}_${date.getMonth() + 1}`;
            if (period === 'yearly') return `Y_${date.getFullYear()}`;
            return '';
        };

        const getPeriodLabel = (period, date) => {
            if (period === 'daily') return `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥`;
            if (period === 'weekly') {
                const { start, end } = getWeekRange(date);
                return `${start.getFullYear()}å¹´ ç¬¬${getWeekNumber(start)}å‘¨ (${start.getMonth()+1}.${start.getDate()}-${end.getMonth()+1}.${end.getDate()})`;
            }
            if (period === 'monthly') return `${date.getFullYear()}å¹´ ${date.getMonth()+1}æœˆ`;
            if (period === 'yearly') return `${date.getFullYear()}å¹´`;
            return '';
        };

        const generateCalendarDates = (baseDate = new Date()) => {
            const { start } = getWeekRange(baseDate);
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                dates.push({
                    fullDate: generateDateString(d),
                    dayName: getDayName(d.getDay()),
                    dateNum: d.getDate(),
                    obj: d
                });
            }
            return dates;
        };

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };

        const parseDurationFromTimeStr = (timeStr) => {
            if (!timeStr || typeof timeStr !== 'string') return 30; 
            const matches = timeStr.match(/(\d{1,2})[:ï¼š](\d{2})/g);
            if (matches && matches.length >= 2) {
                const [h1, m1] = matches[0].split(/[:ï¼š]/).map(Number);
                const [h2, m2] = matches[1].split(/[:ï¼š]/).map(Number);
                let startMins = h1 * 60 + m1;
                let endMins = h2 * 60 + m2;
                if (endMins < startMins) endMins += 24 * 60; 
                return Math.max(15, endMins - startMins); 
            }
            return 30; 
        };

        const downloadICS = (tasks, dateStr, title) => {
            if (!tasks || tasks.length === 0) {
                alert("æ²¡æœ‰å¯å¯¼å‡ºçš„ä»»åŠ¡");
                return;
            }
            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//LifeOS//Task Manager//CN\n";
            tasks.forEach(task => {
                if (!task.time) return; 
                const matches = task.time.match(/(\d{1,2})[:ï¼š](\d{2})/g);
                if (!matches || matches.length < 2) return;
                const [sH, sM] = matches[0].split(/[:ï¼š]/).map(s => s.padStart(2, '0'));
                const [eH, eM] = matches[1].split(/[:ï¼š]/).map(s => s.padStart(2, '0'));
                const dateClean = dateStr.replace(/-/g, '');
                icsContent += "BEGIN:VEVENT\n";
                icsContent += `SUMMARY:${task.title}\n`;
                icsContent += `DTSTART:${dateClean}T${sH}${sM}00\n`;
                icsContent += `DTEND:${dateClean}T${eH}${eM}00\n`;
                icsContent += `DESCRIPTION:${task.note || ''}\n`;
                icsContent += "END:VEVENT\n";
            });
            icsContent += "END:VCALENDAR";
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', `${title}_${dateStr}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- 3. Constants & Data ---
        const DEFAULT_QUOTE = "æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººï¼Œæ—¶å…‰ä¸è´Ÿæœ‰å¿ƒäººã€‚";
        const GROWTH_QUOTES = [
            "æ¯ä¸€æ¬¡ç›¸é‡ï¼Œéƒ½å¯ä»¥ç”¨5å¤©æ—¶é—´æ…¢æ…¢è®¤è¯†å¯¹æ–¹ã€‚", 
            "æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººï¼Œæ—¶å…‰ä¸è´Ÿæœ‰å¿ƒäººã€‚",
            "ä¸æ˜¯â€˜æˆ‘ä¸è¡Œâ€™ï¼Œè€Œæ˜¯â€˜æˆ‘æš‚æ—¶è¿˜ä¸è¡Œâ€™ã€‚",
            "æ‹¥æŠ±æŒ‘æˆ˜ï¼Œé‚£æ˜¯æˆé•¿çš„ä¿¡å·ã€‚",
            "å¤©èµ‹å†³å®šä¸‹é™ï¼ŒåŠªåŠ›å†³å®šä¸Šé™ã€‚",
            "å…è®¸è‡ªå·±ä¼‘æ¯ï¼Œä½†åˆ«å¿˜äº†é‡æ–°å‡ºå‘ã€‚",
            "ä»Šå¤©æ¯”æ˜¨å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹ï¼Œå°±æ˜¯èƒœåˆ©ã€‚",
            "æŠŠå›°éš¾å½“ä½œæ‰“æ€ªå‡çº§ï¼Œç»éªŒå€¼æ­£åœ¨ç–¯æ¶¨ã€‚",
            "ä¸“æ³¨å½“ä¸‹ï¼Œæœªæ¥è‡ªä¼šå‘ˆç°ã€‚"
        ];

        // åˆå§‹æ¿å— - ä»Šæ—¥æ—¥ç¨‹
        const INITIAL_SECTIONS = [
            { id: 'main', title: 'ä»Šæ—¥æ—¥ç¨‹', icon: 'ListTodo', color: 'blue' }
        ];
        
        const TODAY_STR = generateDateString(new Date());
        
        // åˆå§‹æ•°æ®
        const INITIAL_TASKS_BY_DATE = {
            [TODAY_STR]: {
                main: [
                    { id: 1, time: '08:00-08:30', title: 'æ™¨é—´ä¹ æƒ¯ (å–æ°´/æ‹‰ä¼¸)', completed: false, important: true, urgent: true, tag: 'ç”Ÿæ´»', note: '' },
                    { id: 3, time: '14:00-16:00', title: 'æ ¸å¿ƒä»»åŠ¡å¤„ç†', completed: false, important: true, urgent: false, tag: 'å·¥ä½œ', note: '' },
                    { id: 5, time: '20:00-21:00', title: 'å¤ç›˜ä¸æ˜æ—¥è®¡åˆ’', completed: false, important: true, urgent: true, tag: 'ç”Ÿæ´»', note: '' }
                ],
                fragmentary: []
            }
        };
        const ICON_MAP = { Sun, Coffee, Moon, Zap, Briefcase, BookOpen, Dumbbell, Music, ListTodo };
        const PALETTE = {
            white: { label: 'çº¯å‡€ç™½', bg: 'bg-white', text: 'text-slate-800' },
            gray: { label: 'æç®€ç°', bg: 'bg-slate-50', text: 'text-slate-800' },
            rose: { label: 'ç«ç‘°', bg: 'bg-rose-50', text: 'text-rose-900' },
            butter: { label: 'é»„æ²¹', bg: 'bg-amber-50', text: 'text-amber-900' },
            latte: { label: 'æ‹¿é“', bg: 'bg-stone-50', text: 'text-stone-800' },
            elf: { label: 'ç²¾çµ', bg: 'bg-lime-50', text: 'text-lime-900' },
            ocean: { label: 'æµ·ç›', bg: 'bg-sky-50', text: 'text-sky-900' },
            taro: { label: 'é¦™èŠ‹', bg: 'bg-purple-50', text: 'text-purple-900' },
            morandi: { label: 'è«å…°è¿ª', bg: 'bg-slate-100', text: 'text-slate-800' },
            wheat: { label: 'å°éº¦', bg: 'bg-yellow-50', text: 'text-yellow-900' },
            mint: { label: 'è–„è·', bg: 'bg-green-50', text: 'text-green-900' },
        };
        const COLOR_THEMES = {
            orange: { label: 'æ´»åŠ›æ©™', bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-200', icon: 'text-orange-500', preview: 'bg-orange-400', cardBg: 'bg-orange-50' },
            yellow: { label: 'æ˜äº®é»„', bg: 'bg-yellow-50', text: 'text-yellow-600', border: 'border-yellow-200', icon: 'text-yellow-500', preview: 'bg-yellow-400', cardBg: 'bg-yellow-50' },
            indigo: { label: 'æ·±é‚ƒé›', bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-200', icon: 'text-indigo-500', preview: 'bg-indigo-400', cardBg: 'bg-indigo-50' },
            blue: { label: 'å¤©ç©ºè“', bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-200', icon: 'text-blue-500', preview: 'bg-blue-400', cardBg: 'bg-blue-50' },
            green: { label: 'è‡ªç„¶ç»¿', bg: 'bg-green-50', text: 'text-green-600', border: 'border-green-200', icon: 'text-green-500', preview: 'bg-green-400', cardBg: 'bg-green-50' },
            purple: { label: 'ç¥ç§˜ç´«', bg: 'bg-purple-50', text: 'text-purple-600', border: 'border-purple-200', icon: 'text-purple-500', preview: 'bg-purple-400', cardBg: 'bg-purple-50' },
            red: { label: 'çƒ­æƒ…çº¢', bg: 'bg-red-50', text: 'text-red-600', border: 'border-red-200', icon: 'text-red-500', preview: 'bg-red-400', cardBg: 'bg-red-50' },
            rose: { label: 'ç«ç‘°', bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-200', icon: 'text-rose-500', preview: 'bg-rose-400', cardBg: 'bg-rose-50' },
            butter: { label: 'é»„æ²¹', bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-200', icon: 'text-amber-500', preview: 'bg-amber-400', cardBg: 'bg-amber-50' },
            latte: { label: 'æ‹¿é“', bg: 'bg-stone-50', text: 'text-stone-600', border: 'border-stone-200', icon: 'text-stone-500', preview: 'bg-stone-400', cardBg: 'bg-stone-50' },
            elf: { label: 'ç²¾çµ', bg: 'bg-lime-50', text: 'text-lime-600', border: 'border-lime-200', icon: 'text-lime-500', preview: 'bg-lime-400', cardBg: 'bg-lime-50' },
            ocean: { label: 'æµ·ç›', bg: 'bg-sky-50', text: 'text-sky-600', border: 'border-sky-200', icon: 'text-sky-500', preview: 'bg-sky-400', cardBg: 'bg-sky-50' },
            taro: { label: 'é¦™èŠ‹', bg: 'bg-fuchsia-50', text: 'text-fuchsia-600', border: 'border-fuchsia-200', icon: 'text-fuchsia-500', preview: 'bg-fuchsia-400', cardBg: 'bg-fuchsia-50' },
            morandi: { label: 'è«å…°è¿ª', bg: 'bg-slate-100', text: 'text-slate-600', border: 'border-slate-300', icon: 'text-slate-500', preview: 'bg-slate-400', cardBg: 'bg-slate-100' },
        };

        // --- 4. Sub-Components ---
        const Modal = ({ isOpen, onClose, title, children, fullScreen = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] flex items-center justify-center p-4" onClick={(e) => e.stopPropagation()}>
                    <div className={`bg-white rounded-2xl shadow-xl w-full ${fullScreen ? 'max-w-2xl h-[85vh]' : 'max-w-md max-h-[85vh]'} overflow-hidden animate-in fade-in zoom-in duration-200 flex flex-col`}>
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 flex-shrink-0">
                            <h3 className="font-bold text-gray-800 flex items-center gap-2">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full transition"><X className="w-5 h-5 text-gray-500" /></button>
                        </div>
                        <div className={`p-0 overflow-y-auto custom-scrollbar flex-1 bg-[#F9FAFB]`}>{children}</div>
                    </div>
                </div>
            );
        };

        const TimeRangePicker = ({ value, onChange }) => {
            const parseInitial = useMemo(() => {
                const matches = (value || '').match(/(\d{1,2})[:ï¼š](\d{2})/g);
                let sH = '09', sM = '00', eH = '10', eM = '00';
                if (matches && matches.length > 0) {
                    [sH, sM] = matches[0].split(/[:ï¼š]/).map(s => s.padStart(2,'0'));
                    if (matches.length > 1) { [eH, eM] = matches[1].split(/[:ï¼š]/).map(s => s.padStart(2,'0')); } 
                    else { let h = parseInt(sH), m = parseInt(sM) + 30; if (m >= 60) { h = (h + 1) % 24; m -= 60; } eH = String(h).padStart(2,'0'); eM = String(m).padStart(2,'0'); }
                }
                return { start: `${sH}:${sM}`, end: `${eH}:${eM}` };
            }, [value]); 
            const [times, setTimes] = useState(parseInitial);
            useEffect(() => { const newVal = `${times.start}-${times.end}`; if (newVal !== value) onChange(newVal); }, [times]);
            return (<div className="flex items-center gap-2"><div className="flex-1 bg-white border border-gray-200 rounded-xl px-2 py-2 shadow-sm focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all"><input type="time" value={times.start} onChange={(e) => setTimes(p => ({ ...p, start: e.target.value || p.start }))} className="w-full bg-transparent text-center font-bold text-gray-700 outline-none text-sm" required /></div><span className="text-gray-400 font-bold">-</span><div className="flex-1 bg-white border border-gray-200 rounded-xl px-2 py-2 shadow-sm focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all"><input type="time" value={times.end} onChange={(e) => setTimes(p => ({ ...p, end: e.target.value || p.end }))} className="w-full bg-transparent text-center font-bold text-gray-700 outline-none text-sm" required /></div></div>);
        };

        const WateringAnimation = () => (<div className="relative w-full h-64 flex items-center justify-center bg-white/50 rounded-xl"><svg viewBox="0 0 300 200" className="w-full h-full max-w-sm"><path d="M40 160 L260 160" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><g transform="translate(180, 115)"><path d="M10 45 L15 15 L45 15 L50 45 Q30 50 10 45 Z" fill="none" stroke="#334155" strokeWidth="2" strokeLinejoin="round" /><path d="M15 15 Q30 10 45 15" fill="none" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><g className="origin-bottom animate-[grow_2s_ease-out_forwards]" style={{transformBox: 'fill-box', transformOrigin: 'bottom center'}}><path d="M30 15 Q30 5 30 -5" stroke="#a3e635" strokeWidth="3" strokeLinecap="round" /><path d="M30 -5 Q20 -15 15 -5 Q25 5 30 -5" fill="#a3e635" /><path d="M30 -5 Q40 -15 45 -5 Q35 5 30 -5" fill="#a3e635" /></g></g><g transform="translate(60, 50) rotate(-10)"><path d="M20 40 C-10 30 -10 90 20 80" fill="none" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M80 50 L130 40 L135 60 L80 80" fill="#fca5a5" stroke="none" /><path d="M80 50 L130 40" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M80 80 L135 60" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M20 30 L80 30 L85 100 L15 100 Q10 65 20 30 Z" fill="#fca5a5" stroke="#334155" strokeWidth="2" strokeLinejoin="round" /><path d="M30 40 Q40 30 50 50 T70 60 T40 80" fill="none" stroke="#f472b6" strokeWidth="2" opacity="0.6" /><path d="M35 60 Q50 70 65 50" fill="none" stroke="#f472b6" strokeWidth="2" opacity="0.6" /><g transform="translate(135, 50)"><line x1="5" y1="0" x2="20" y2="-5" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><line x1="5" y1="10" x2="20" y2="15" stroke="#334155" strokeWidth="2" strokeLinecap="round" /></g></g><g><circle cx="200" cy="90" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite]" /><circle cx="210" cy="100" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite_0.3s]" /><circle cx="190" cy="105" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite_0.6s]" /></g></svg></div>);
        const CircularProgress = ({ percentage, label, subLabel, colorClass, trackClass, onClick }) => {const radius = 18; const circumference = 2 * Math.PI * radius; const strokeDashoffset = circumference - (percentage / 100) * circumference; return (<div className="flex flex-col items-center justify-center group cursor-pointer relative z-10" onClick={onClick} style={{ pointerEvents: 'auto' }}><div className="relative w-12 h-12 flex items-center justify-center transition-transform group-hover:scale-105"><svg className="w-full h-full transform -rotate-90"><circle cx="24" cy="24" r={radius} stroke="currentColor" strokeWidth="4" fill="transparent" className={trackClass} /><circle cx="24" cy="24" r={radius} stroke="currentColor" strokeWidth="4" fill="transparent" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round" className={colorClass} /></svg><span className="absolute text-[10px] font-bold text-gray-600">{percentage}%</span></div><div className="mt-1 text-center"><div className="text-[10px] text-gray-400 group-hover:text-blue-500 transition-colors">{label}</div><div className="text-xs font-bold text-gray-800">{subLabel}</div></div></div>);};
        const AdvancedPieChart = ({ data, totalMins }) => {if (!data || data.length === 0) return null; let cumulativePercent = 0; const getCoordinates = (percent, radius = 1) => { const rad = 2 * Math.PI * (percent - 0.25); const x = Math.cos(rad) * radius; const y = Math.sin(rad) * radius; return [x, y]; }; const formatDuration = (mins) => { const h = Math.floor(mins / 60); const m = mins % 60; if (h > 0 && m > 0) return `${h}å°æ—¶${m}åˆ†`; if (h > 0) return `${h}å°æ—¶`; return `${m}åˆ†`; }; return (<div className="relative w-full aspect-square max-w-sm mx-auto my-4"><svg viewBox="-2 -2 4 4" className="w-full h-full overflow-visible">{data.map((item, index) => { const percent = item.value / totalMins; const [startX, startY] = getCoordinates(cumulativePercent); const midPercent = cumulativePercent + percent / 2; cumulativePercent += percent; const [endX, endY] = getCoordinates(cumulativePercent); const largeArcFlag = percent > 0.5 ? 1 : 0; const pathData = `M 0 0 L ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} Z`; const [midX, midY] = getCoordinates(midPercent); const isRight = midX > 0; const elbowX = midX * 1.15; const elbowY = midY * 1.15; const textStartX = isRight ? elbowX + 0.2 : elbowX - 0.2; return (<g key={index}><path d={pathData} fill={item.color} stroke="white" strokeWidth="0.02" className="hover:opacity-90 transition-opacity cursor-pointer" />{percent > 0.03 && (<React.Fragment><polyline points={`${midX},${midY} ${elbowX},${elbowY} ${textStartX},${elbowY}`} fill="none" stroke="#9ca3af" strokeWidth="0.015" /><text x={isRight ? textStartX + 0.05 : textStartX - 0.05} y={elbowY - 0.06} fill="#4b5563" fontSize="0.16" textAnchor={isRight ? 'start' : 'end'} alignmentBaseline="baseline" className="font-bold">{item.tag}</text><text x={isRight ? textStartX + 0.05 : textStartX - 0.05} y={elbowY + 0.14} fill="#6b7280" fontSize="0.12" textAnchor={isRight ? 'start' : 'end'} alignmentBaseline="baseline">{formatDuration(item.value)}</text></React.Fragment>)}</g>);})}</svg></div>);};
        
        // ä¼˜åŒ–åçš„ç»Ÿè®¡å¡ç‰‡ï¼šæåº¦æ‰å¹³åŒ–ï¼Œå»é™¤èƒ¶å›ŠèƒŒæ™¯ï¼Œå­—å·å¾®è°ƒ
        const StatCard = ({ number, title, subText, colorTheme }) => {
            const themes = {
                red: { bg: 'bg-red-50', text: 'text-red-600', border: 'border-red-100' },
                orange: { bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-100' },
                blue: { bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-100' },
                green: { bg: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-100' },
            };
            const theme = themes[colorTheme] || themes.blue;
            
            return (
                <div className={`${theme.bg} rounded-xl p-1.5 flex flex-col items-center justify-center border ${theme.border} shadow-sm h-full`}>
                    <span className="text-[9px] font-bold text-gray-500 leading-none scale-90 origin-bottom">{title}</span>
                    <span className={`text-lg font-black ${theme.text} leading-none my-0.5`}>{number}</span>
                    <span className={`text-[9px] font-bold ${theme.text} opacity-80 leading-none scale-90 origin-top`}>{subText}</span>
                </div>
            );
        };

        const TaskCard = ({ task, onToggle, onEdit, onDelete, onNote, onRemind, cardStyle, sectionColor }) => {
            const getMatrixTag = () => {
                if (task.important && task.urgent) return { text: 'é‡è¦ç´§æ€¥', color: 'indigo' };
                if (task.important && !task.urgent) return { text: 'é‡è¦ä¸æ€¥', color: 'blue' };
                if (!task.important && task.urgent) return { text: 'ç´§æ€¥ä¸é‡', color: 'red' };
                return { text: 'ä¸æ€¥ä¸é‡', color: 'green' };
            };
            const matrixTag = getMatrixTag();
            const tagColors = { indigo: 'bg-indigo-100 text-indigo-700', blue: 'bg-blue-100 text-blue-700', red: 'bg-red-100 text-red-700', green: 'bg-emerald-100 text-emerald-700', gray: 'bg-gray-100 text-gray-600' };
            const userTag = typeof task.tag === 'string' ? task.tag : '';
            const theme = sectionColor && COLOR_THEMES[sectionColor] ? COLOR_THEMES[sectionColor] : COLOR_THEMES.butter; 
            const bgClass = task.completed ? 'bg-white border-gray-100' : cardStyle === 'colored' && theme ? `${theme.cardBg} border-transparent` : 'bg-white border-gray-100 hover:shadow-md'; 
            
            return (
                <div className={`p-2.5 rounded-xl shadow-sm border transition-all duration-300 group mb-2 relative cursor-pointer flex items-start gap-3 ${bgClass}`} onClick={() => onToggle(task.id)}>
                    <div className="flex flex-col items-end justify-center min-w-[4rem] border-r-2 border-gray-100 pr-3 py-1 self-stretch">
                        {task.time ? (
                            <>
                                <span className="text-sm font-black font-mono text-slate-700 leading-none">{task.time.split('-')[0]}</span>
                                <span className="text-[10px] font-bold text-gray-400 leading-none mt-1">{task.time.split('-')[1] ? '-' + task.time.split('-')[1] : ''}</span>
                            </>
                        ) : (
                            <span className="text-xs font-bold text-gray-300">--:--</span>
                        )}
                    </div>

                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-20 bg-white/90 backdrop-blur-sm p-1 rounded-lg shadow-sm border border-gray-100">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(task); }} className="p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-md transition" title="ç¼–è¾‘ä»»åŠ¡"><Edit3 className="w-3.5 h-3.5" /></button>
                        <div className="w-px bg-gray-200 my-1"></div>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-md transition" title="åˆ é™¤ä»»åŠ¡"><Trash2 className="w-3.5 h-3.5" /></button>
                    </div>

                    <div className={`flex-1 transition-opacity duration-300 min-w-0 py-0.5 ${task.completed ? 'opacity-40' : 'opacity-100'}`}>
                        <div className="flex items-center gap-2 mb-1.5">
                            <h3 className={`font-bold text-sm truncate transition-colors duration-300 ${task.completed ? 'line-through text-gray-300 decoration-gray-300' : 'text-gray-800'}`}>
                                {String(task.title)}
                                {task.recurring && <RotateCcw className="inline-block w-3 h-3 ml-2 text-blue-400" />}
                            </h3>
                        </div>
                        
                        <div className="flex flex-wrap items-center gap-2">
                            {userTag && <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${task.completed ? 'bg-gray-100 text-gray-400' : 'bg-gray-100 text-gray-600'}`}>{String(userTag)}</span>}
                            <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${task.completed ? 'bg-gray-100 text-gray-400' : tagColors[matrixTag.color]}`}>{matrixTag.text}</span>
                            
                            <div className={`flex items-center gap-2 ${task.completed ? 'hidden' : 'flex'}`}>
                                <button className="flex items-center gap-0.5 text-[10px] px-1.5 py-0.5 rounded hover:bg-pink-50 hover:text-pink-600 text-gray-400 transition-all" onClick={(e) => { e.stopPropagation(); onNote(task); }}>
                                    <PenLine className="w-3 h-3" /><span>å¤‡æ³¨</span>
                                </button>
                                <button className="flex items-center gap-0.5 text-[10px] px-1.5 py-0.5 rounded hover:bg-yellow-50 hover:text-yellow-600 text-gray-400 transition-all" onClick={(e) => { e.stopPropagation(); onRemind(task); }}>
                                    <Bell className="w-3 h-3" /><span>æé†’</span>
                                </button>
                            </div>
                        </div>

                        {task.note && (<div className={`mt-2 px-2 py-1.5 rounded-lg text-xs flex gap-2 items-start border transition-colors ${task.completed ? 'bg-gray-50 border-gray-100 text-gray-300' : 'bg-yellow-50 border-yellow-100/50 text-gray-600'}`}><StickyNote className={`w-3 h-3 mt-0.5 flex-shrink-0 ${task.completed ? 'text-gray-300' : 'text-yellow-400'}`} /><span className="line-clamp-1">{String(task.note)}</span></div>)}
                    </div>

                    <div className="flex-shrink-0 ml-1 self-center">
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center transition-all duration-300 ${task.completed ? 'bg-green-400 shadow-sm scale-110' : 'border-2 border-gray-200 hover:border-indigo-300 bg-white'}`}>
                            {task.completed && <Check className="w-4 h-4 text-white stroke-[3]" />}
                        </div>
                    </div>
                </div>
            );
        };

        const DailyReviewContent = ({ reviewDate, reviews, setReviews }) => {
            const reviewId = getReviewId('daily', reviewDate);
            const data = reviews[reviewId] || { gratitude: '', facts: '', insight: '', adjustment: '' };
            const [gratitudeSaved, setGratitudeSaved] = useState(false);
            const [threeLineSaved, setThreeLineSaved] = useState(false);
            
            const gratitudeRef = useRef(null);
            const factsRef = useRef(null);
            const insightRef = useRef(null);
            const adjustmentRef = useRef(null);

            const adjustHeight = (ref) => {
                if (ref.current) {
                    ref.current.style.height = 'auto';
                    ref.current.style.height = ref.current.scrollHeight + 'px';
                }
            };

            useEffect(() => { adjustHeight(gratitudeRef); }, [data.gratitude]);
            useEffect(() => { 
                adjustHeight(factsRef);
                adjustHeight(insightRef);
                adjustHeight(adjustmentRef);
            }, [data.facts, data.insight, data.adjustment]);

            const updateReview = (field, value) => {
                setReviews(prev => ({ ...prev, [reviewId]: { ...(prev[reviewId] || {}), [field]: value } }));
                if (field === 'gratitude') setGratitudeSaved(false);
                else setThreeLineSaved(false);
            };

            const handleSaveGratitude = () => {
                setGratitudeSaved(true);
                setTimeout(() => setGratitudeSaved(false), 2000);
            };

            const handleSaveThreeLine = () => {
                setThreeLineSaved(true);
                setTimeout(() => setThreeLineSaved(false), 2000);
            };

            return (
                <div className="space-y-6 p-4">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-pink-50">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2"><Heart className="w-5 h-5 text-pink-400 fill-pink-400" /><h4 className="font-bold text-gray-800">æ„Ÿæ©ç¬”è®°</h4></div>
                            <button onClick={handleSaveGratitude} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${gratitudeSaved ? 'bg-green-100 text-green-600' : 'bg-pink-50 text-pink-600 hover:bg-pink-100'}`}>
                                {gratitudeSaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> å·²ä¿å­˜</span> : 'ä¿å­˜'}
                            </button>
                        </div>
                        <textarea 
                            ref={gratitudeRef}
                            className="w-full min-h-[96px] bg-pink-50/30 rounded-lg p-3 text-sm focus:outline-none focus:ring-1 focus:ring-pink-200 resize-none placeholder:text-gray-300 overflow-hidden transition-all" 
                            placeholder="è®°å½•ä»Šå¤©å€¼å¾—æ„Ÿæ¿€çš„å°ç¡®å¹¸..." 
                            value={String(data.gratitude || '')} 
                            onChange={(e) => updateReview('gratitude', e.target.value)} 
                        />
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-blue-50">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2"><Sparkles className="w-5 h-5 text-orange-400 fill-orange-400" /><h4 className="font-bold text-gray-800">3è¡Œæç®€å¤ç›˜</h4></div>
                            <button onClick={handleSaveThreeLine} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${threeLineSaved ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>
                                {threeLineSaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> å·²ä¿å­˜</span> : 'ä¿å­˜'}
                            </button>
                        </div>
                        <div className="space-y-3">
                            <div>
                                <label className="text-xs font-bold text-blue-500 mb-1 block flex items-center gap-1"><LayoutGrid className="w-3 h-3"/> äº‹å®</label>
                                <textarea ref={factsRef} rows={1} className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-blue-200 transition-all resize-none overflow-hidden" placeholder="å®Œæˆ..." value={String(data.facts || '')} onChange={(e) => updateReview('facts', e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-pink-500 mb-1 block flex items-center gap-1"><Zap className="w-3 h-3"/> æ´å¯Ÿ</label>
                                <textarea ref={insightRef} rows={1} className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-pink-200 transition-all resize-none overflow-hidden" placeholder="å¿ƒå¾—..." value={String(data.insight || '')} onChange={(e) => updateReview('insight', e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-green-500 mb-1 block flex items-center gap-1"><CheckCircle2 className="w-3 h-3"/> è°ƒæ•´</label>
                                <textarea ref={adjustmentRef} rows={1} className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-green-200 transition-all resize-none overflow-hidden" placeholder="ä¸‹ä¸€æ­¥..." value={String(data.adjustment || '')} onChange={(e) => updateReview('adjustment', e.target.value)} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PeriodReviewContent = ({ period, reviewDate, reviews, setReviews, tasksByDate, sections }) => {
            const reviewId = getReviewId(period, reviewDate);
            const data = reviews[reviewId] || {};
            const goals = Array.isArray(data.goals) ? data.goals : [];
            
            const [summarySaved, setSummarySaved] = useState(false);
            const [kptSaved, setKptSaved] = useState({ keep: false, problem: false, try: false });
            const [graiSaved, setGraiSaved] = useState({ goal: false, result: false, analysis: false, insight: false });
            const [pdcaSaved, setPdcaSaved] = useState({ plan: false, do: false, check: false, action: false });

            const summaryRef = useRef(null);
            const keepRef = useRef(null);
            const problemRef = useRef(null);
            const tryRef = useRef(null);
            const goalRef = useRef(null);
            const resultRef = useRef(null);
            const analysisRef = useRef(null);
            const insightRef = useRef(null);
            const planRef = useRef(null);
            const doRef = useRef(null);
            const checkRef = useRef(null);
            const actionRef = useRef(null);

            const adjustHeight = (ref) => {
                if (ref.current) {
                    ref.current.style.height = 'auto';
                    ref.current.style.height = ref.current.scrollHeight + 'px';
                }
            };

            useEffect(() => { adjustHeight(summaryRef); }, [data.summary]);
            useEffect(() => { if(period === 'yearly') { adjustHeight(keepRef); adjustHeight(problemRef); adjustHeight(tryRef); } }, [data.kpt_keep, data.kpt_problem, data.kpt_try, period]);
            useEffect(() => { if(period === 'monthly') { adjustHeight(goalRef); adjustHeight(resultRef); adjustHeight(analysisRef); adjustHeight(insightRef); } }, [data.grai_goal, data.grai_result, data.grai_analysis, data.grai_insight, period]);
            useEffect(() => { if(period === 'weekly') { adjustHeight(planRef); adjustHeight(doRef); adjustHeight(checkRef); adjustHeight(actionRef); } }, [data.pdca_plan, data.pdca_do, data.pdca_check, data.pdca_action, period]);
            
            const statsData = useMemo(() => {
                let targetDates = [];
                const y = reviewDate.getFullYear();
                const m = reviewDate.getMonth();
                if (period === 'weekly') { const { start } = getWeekRange(reviewDate); for(let i=0; i<7; i++) { const temp = new Date(start); temp.setDate(start.getDate() + i); targetDates.push(generateDateString(temp)); } }
                else if (period === 'monthly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy, dm] = dateStr.split('-').map(Number); if (dy === y && dm === m + 1) targetDates.push(dateStr); }); }
                else if (period === 'yearly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy] = dateStr.split('-').map(Number); if (dy === y) targetDates.push(dateStr); }); }
                let tagMap = {}; let totalMins = 0; let activeDays = new Set(); let completedCount = 0;
                targetDates.forEach(dateStr => { const dayTasks = tasksByDate[dateStr]; if (!dayTasks) return; let hasCompleted = false; [...sections.map(s => s.id), 'fragmentary'].forEach(sec => { (dayTasks[sec] || []).forEach(task => { if (task.completed) { hasCompleted = true; completedCount++; const tag = task.tag || 'æœªåˆ†ç±»'; const mins = task.time ? parseDurationFromTimeStr(task.time) : 30; tagMap[tag] = (tagMap[tag] || 0) + mins; totalMins += mins; } }); }); if (hasCompleted) activeDays.add(dateStr); });
                const colors = ['#fca5a5', '#93c5fd', '#6ee7b7', '#fcd34d', '#c4b5fd', '#f9a8d4', '#818cf8', '#34d399', '#fbbf24', '#f87171'];
                const chartData = Object.keys(tagMap).map((k, i) => ({ tag: k, value: tagMap[k], color: colors[i % colors.length] })).sort((a,b) => b.value - a.value);
                return { data: chartData, totalMins, completedCount, activeDays: activeDays.size };
            }, [period, reviewDate, tasksByDate, sections]);

            const [newGoal, setNewGoal] = useState('');
            const updateReview = (field, value) => {
                setReviews(prev => ({ ...prev, [reviewId]: { ...(prev[reviewId] || {}), [field]: value } }));
                if (field === 'summary') setSummarySaved(false);
                if (field.startsWith('kpt_')) setKptSaved(prev => ({ ...prev, [field.split('_')[1]]: false }));
                if (field.startsWith('grai_')) setGraiSaved(prev => ({ ...prev, [field.split('_')[1]]: false }));
                if (field.startsWith('pdca_')) setPdcaSaved(prev => ({ ...prev, [field.split('_')[1]]: false }));
            };
            
            const addGoal = () => { if (!newGoal.trim()) return; const newGoalObj = { id: Date.now(), text: newGoal, completed: false }; updateReview('goals', [...goals, newGoalObj]); setNewGoal(''); };
            const toggleGoal = (goalId) => { const newGoals = goals.map(g => g.id === goalId ? { ...g, completed: !g.completed } : g); updateReview('goals', newGoals); };
            
            const handleSaveSummary = () => { setSummarySaved(true); setTimeout(() => setSummarySaved(false), 2000); };
            const handleSaveKpt = (type) => { setKptSaved(prev => ({ ...prev, [type]: true })); setTimeout(() => setKptSaved(prev => ({ ...prev, [type]: false })), 2000); };
            const handleSaveGrai = (type) => { setGraiSaved(prev => ({ ...prev, [type]: true })); setTimeout(() => setGraiSaved(prev => ({ ...prev, [type]: false })), 2000); };
            const handleSavePdca = (type) => { setPdcaSaved(prev => ({ ...prev, [type]: true })); setTimeout(() => setPdcaSaved(prev => ({ ...prev, [type]: false })), 2000); };

            return (
                <div className="space-y-4 p-4">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex items-center gap-2 mb-2"><PieChart className="w-5 h-5 text-indigo-500" /><h4 className="font-bold text-gray-800 text-sm">æ—¶é—´åˆ†é…ä¸æ•°æ®å›é¡¾</h4></div>
                        {statsData.data.length > 0 ? (<div className="flex flex-col items-center"><AdvancedPieChart data={statsData.data} totalMins={statsData.totalMins} /><div className="mt-4 text-center w-full pt-4 border-t border-gray-100"><p className="text-gray-800 font-bold text-sm mb-1">æ€»è®¡ {Math.floor(statsData.totalMins / 60)} å°æ—¶ {statsData.totalMins % 60} åˆ†é’Ÿ</p><p className="text-gray-400 text-xs mt-1">æ‰“å¡å®Œæˆ {statsData.completedCount} ä¸ªä»»åŠ¡ Â· å‘¨æœŸå†…æ´»è·ƒ {statsData.activeDays} å¤©</p></div></div>) : (<div className="text-center py-6 text-gray-400 text-xs">è¯¥å‘¨æœŸæš‚æ— å·²å®Œæˆçš„ä»»åŠ¡æ•°æ®</div>)}
                    </div>

                     <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex items-center gap-2 mb-3"><Target className="w-5 h-5 text-red-500" /><h4 className="font-bold text-gray-800 text-sm">æ ¸å¿ƒç›®æ ‡</h4></div>
                        <div className="space-y-2 mb-3">{goals.map(goal => (<div key={goal.id} className="flex items-center gap-2 group p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"><button onClick={() => toggleGoal(goal.id)} className={`flex-shrink-0 transition-colors ${goal.completed ? 'text-green-500' : 'text-gray-300 hover:text-gray-400'}`}>{goal.completed ? <CheckCircle2 className="w-5 h-5" /> : <Circle className="w-5 h-5" />}</button><span className={`flex-1 text-sm ${goal.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{String(goal.text)}</span></div>))}</div>
                        <div className="flex gap-2 w-full mt-2"><input className="flex-1 bg-white border border-gray-200 rounded px-3 py-1.5 text-sm outline-none" placeholder="æ·»åŠ æ–°ç›®æ ‡..." value={newGoal} onChange={(e) => setNewGoal(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addGoal()} /><button onClick={addGoal} className="bg-[#1E293B] text-white px-4 py-1.5 rounded text-xs font-bold">æ·»åŠ </button></div>
                    </div>

                    {period === 'yearly' ? (
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2"><TrendingUp className="w-5 h-5 text-purple-600" /><h4 className="font-black text-gray-800 text-lg">KPT å¹´å¤ç›˜æ³•</h4></div>
                            <div className="space-y-5">
                                <div className="bg-green-50/50 p-4 rounded-xl border border-green-100"><div className="flex items-center justify-between mb-2"><label className="text-green-700 font-bold flex items-center gap-2"><CheckCircle2 className="w-4 h-4"/> Keep ä¿æŒ</label><button onClick={() => handleSaveKpt('keep')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${kptSaved.keep ? 'bg-green-200 text-green-700' : 'bg-white text-green-600 border border-green-200 hover:bg-green-50'}`}>{kptSaved.keep ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-green-600/70 mb-2">å“ªäº›è¡Œä¸ºæ˜¯å¯ä»¥ä¿æŒçš„ï¼Ÿæœ‰å“ªäº›äº®ç‚¹ï¼Ÿ</p><textarea ref={keepRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-green-200 resize-none overflow-hidden transition-all text-gray-700" placeholder="è®°å½•å€¼å¾—å»¶ç»­çš„æˆåŠŸç»éªŒ..." value={String(data.kpt_keep || '')} onChange={(e) => updateReview('kpt_keep', e.target.value)} /></div>
                                <div className="bg-orange-50/50 p-4 rounded-xl border border-orange-100"><div className="flex items-center justify-between mb-2"><label className="text-orange-700 font-bold flex items-center gap-2"><AlertCircle className="w-4 h-4"/> Problem é—®é¢˜</label><button onClick={() => handleSaveKpt('problem')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${kptSaved.problem ? 'bg-orange-200 text-orange-700' : 'bg-white text-orange-600 border border-orange-200 hover:bg-orange-50'}`}>{kptSaved.problem ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-orange-600/70 mb-2">æ›¾é‡åˆ°äº†å“ªäº›é—®é¢˜ï¼Ÿæœ‰å“ªäº›ä¸è¶³ï¼Ÿ</p><textarea ref={problemRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-orange-200 resize-none overflow-hidden transition-all text-gray-700" placeholder="è¯šå®åœ°è®°å½•é‡åˆ°çš„å›°éš¾å’ŒæŒ‘æˆ˜..." value={String(data.kpt_problem || '')} onChange={(e) => updateReview('kpt_problem', e.target.value)} /></div>
                                <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100"><div className="flex items-center justify-between mb-2"><label className="text-blue-700 font-bold flex items-center gap-2"><Sparkles className="w-4 h-4"/> Try å°è¯•</label><button onClick={() => handleSaveKpt('try')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${kptSaved.try ? 'bg-blue-200 text-blue-700' : 'bg-white text-blue-600 border border-blue-200 hover:bg-blue-50'}`}>{kptSaved.try ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-blue-600/70 mb-2">å¯ä»¥å°è¯•å»åšä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆæ–°çš„è§£å†³æ–¹æ¡ˆï¼Ÿ</p><textarea ref={tryRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 resize-none overflow-hidden transition-all text-gray-700" placeholder="å†™ä¸‹æ˜å¹´çš„è¡ŒåŠ¨è®¡åˆ’å’Œæ”¹è¿›æ–¹æ¡ˆ..." value={String(data.kpt_try || '')} onChange={(e) => updateReview('kpt_try', e.target.value)} /></div>
                            </div>
                            <div className="mt-6 pt-4 border-t border-gray-100"><span className="text-xs font-bold text-gray-400 block mb-2">ğŸ’¡ å¤ç›˜æ€è€ƒç»´åº¦å‚è€ƒï¼š</span><div className="flex flex-wrap gap-2"><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">ğŸŒ± å†…åœ¨ï¼šä¸ªäººæˆé•¿</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">ğŸ’¼ å†…åœ¨ï¼šèŒä¸šå‘å±•</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">ğŸ’° å†…åœ¨ï¼šè´¢åŠ¡çŠ¶å†µ</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">ğŸŒŸ å†…åœ¨ï¼šè‡ªæˆ‘å®ç°</span></div><div className="flex flex-wrap gap-2 mt-2"><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">ğŸ¤ å¤–åœ¨ï¼šæœ‹å‹/äººè„‰</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">ğŸ® å¤–åœ¨ï¼šå¨±ä¹ä¼‘é—²</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">ğŸ  å¤–åœ¨ï¼šå®¶åº­</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded">ğŸ’ª å¤–åœ¨ï¼šå¥åº·</span></div></div>
                        </div>
                    ) : period === 'monthly' ? (
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2"><TrendingUp className="w-5 h-5 text-indigo-600" /><h4 className="font-black text-gray-800 text-lg">GRAI æœˆå¤ç›˜æ³•</h4></div>
                            <div className="space-y-5">
                                <div className="bg-teal-50/50 p-4 rounded-xl border border-teal-100"><div className="flex items-center justify-between mb-2"><label className="text-teal-700 font-bold flex items-center gap-2"><Target className="w-4 h-4"/> Goal å›é¡¾ç›®æ ‡</label><button onClick={() => handleSaveGrai('goal')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${graiSaved.goal ? 'bg-teal-200 text-teal-700' : 'bg-white text-teal-600 border border-teal-200 hover:bg-teal-50'}`}>{graiSaved.goal ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-teal-600/70 mb-2">å½“åˆçš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿæ ¸å¿ƒé˜¶æ®µæ€§ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</p><textarea ref={goalRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.grai_goal || '')} onChange={(e) => updateReview('grai_goal', e.target.value)} /></div>
                                <div className="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100"><div className="flex items-center justify-between mb-2"><label className="text-indigo-700 font-bold flex items-center gap-2"><PieChart className="w-4 h-4"/> Result è¯„ä¼°ç»“æœ</label><button onClick={() => handleSaveGrai('result')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${graiSaved.result ? 'bg-indigo-200 text-indigo-700' : 'bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50'}`}>{graiSaved.result ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-indigo-600/70 mb-2">ç›®æ ‡æ˜¯å¦å®Œæˆï¼Ÿå·®è·å¤šå°‘ï¼Ÿç›¸æ¯”åŸå®šç›®æ ‡æœ‰å“ªäº›ä¼˜åŠ£åŠ¿ï¼Ÿ</p><textarea ref={resultRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.grai_result || '')} onChange={(e) => updateReview('grai_result', e.target.value)} /></div>
                                <div className="bg-amber-50/50 p-4 rounded-xl border border-amber-100"><div className="flex items-center justify-between mb-2"><label className="text-amber-700 font-bold flex items-center gap-2"><LayoutGrid className="w-4 h-4"/> Analysis åˆ†æåŸå› </label><button onClick={() => handleSaveGrai('analysis')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${graiSaved.analysis ? 'bg-amber-200 text-amber-700' : 'bg-white text-amber-600 border border-amber-200 hover:bg-amber-50'}`}>{graiSaved.analysis ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-amber-600/70 mb-2">ç»å†äº†ä»€ä¹ˆï¼Ÿäº§ç”Ÿè¯¥ç»“æœçš„åŸå› ï¼ˆä¸»è§‚/å®¢è§‚ï¼‰æœ‰å“ªäº›ï¼Ÿ</p><textarea ref={analysisRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.grai_analysis || '')} onChange={(e) => updateReview('grai_analysis', e.target.value)} /></div>
                                <div className="bg-violet-50/50 p-4 rounded-xl border border-violet-100"><div className="flex items-center justify-between mb-2"><label className="text-violet-700 font-bold flex items-center gap-2"><Zap className="w-4 h-4"/> Insight å½’ç±»æ€»ç»“</label><button onClick={() => handleSaveGrai('insight')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${graiSaved.insight ? 'bg-violet-200 text-violet-700' : 'bg-white text-violet-600 border border-violet-200 hover:bg-violet-50'}`}>{graiSaved.insight ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-violet-600/70 mb-2">å¾—å‡ºçš„å¯¹åº”æªæ–½æ˜¯ä»€ä¹ˆï¼Ÿå¾—åˆ°äº†ä»€ä¹ˆç»éªŒï¼Ÿè§„å¾‹æ˜¯ä»€ä¹ˆï¼Ÿ</p><textarea ref={insightRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-violet-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.grai_insight || '')} onChange={(e) => updateReview('grai_insight', e.target.value)} /></div>
                            </div>
                        </div>
                    ) : period === 'weekly' ? (
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2"><TrendingUp className="w-5 h-5 text-emerald-600" /><h4 className="font-black text-gray-800 text-lg">PDCA å‘¨å¤ç›˜æ³•</h4></div>
                            <div className="space-y-5">
                                <div className="bg-sky-50/50 p-4 rounded-xl border border-sky-100"><div className="flex items-center justify-between mb-2"><label className="text-sky-700 font-bold flex items-center gap-2"><Settings2 className="w-4 h-4"/> Plan è®¡åˆ’</label><button onClick={() => handleSavePdca('plan')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${pdcaSaved.plan ? 'bg-sky-200 text-sky-700' : 'bg-white text-sky-600 border border-sky-200 hover:bg-sky-50'}`}>{pdcaSaved.plan ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-sky-600/70 mb-2">åˆ¶å®šè®¡åˆ’ï¼šå†™ä¸‹æœ¬å‘¨è®¡åˆ’ï¼Œè®¡åˆ’åšå“ªäº›äº‹ã€‚</p><textarea ref={planRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.pdca_plan || '')} onChange={(e) => updateReview('pdca_plan', e.target.value)} /></div>
                                <div className="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100"><div className="flex items-center justify-between mb-2"><label className="text-emerald-700 font-bold flex items-center gap-2"><Play className="w-4 h-4"/> Do æ‰§è¡Œ</label><button onClick={() => handleSavePdca('do')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${pdcaSaved.do ? 'bg-emerald-200 text-emerald-700' : 'bg-white text-emerald-600 border border-emerald-200 hover:bg-emerald-50'}`}>{pdcaSaved.do ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-emerald-600/70 mb-2">å®æ–½ã€æ‰§è¡Œï¼šå†™ä¸‹å…·ä½“å®Œæˆäº†å“ªäº›äº‹ã€‚</p><textarea ref={doRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.pdca_do || '')} onChange={(e) => updateReview('pdca_do', e.target.value)} /></div>
                                <div className="bg-amber-50/50 p-4 rounded-xl border border-amber-100"><div className="flex items-center justify-between mb-2"><label className="text-amber-700 font-bold flex items-center gap-2"><CheckCircle2 className="w-4 h-4"/> Check æ£€æŸ¥</label><button onClick={() => handleSavePdca('check')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${pdcaSaved.check ? 'bg-amber-200 text-amber-700' : 'bg-white text-amber-600 border border-amber-200 hover:bg-amber-50'}`}>{pdcaSaved.check ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-amber-600/70 mb-2">æ£€æŸ¥ã€å¤ç›˜ï¼šæ ¸å¯¹è®¡åˆ’ä¸­å“ªäº›äº‹æ²¡æœ‰å®Œæˆï¼Œåˆ†æåŸå› ã€‚</p><textarea ref={checkRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.pdca_check || '')} onChange={(e) => updateReview('pdca_check', e.target.value)} /></div>
                                <div className="bg-rose-50/50 p-4 rounded-xl border border-rose-100"><div className="flex items-center justify-between mb-2"><label className="text-rose-700 font-bold flex items-center gap-2"><RotateCcw className="w-4 h-4"/> Action å¤„ç†</label><button onClick={() => handleSavePdca('action')} className={`text-[10px] px-2 py-1 rounded-full transition-all font-bold ${pdcaSaved.action ? 'bg-rose-200 text-rose-700' : 'bg-white text-rose-600 border border-rose-200 hover:bg-rose-50'}`}>{pdcaSaved.action ? 'å·²ä¿å­˜' : 'ä¿å­˜'}</button></div><p className="text-xs text-rose-600/70 mb-2">é‡‡å–æªæ–½ï¼šé’ˆå¯¹æ²¡æœ‰å®Œæˆçš„è®¡åˆ’ï¼Œåç»­æœ‰ä»€ä¹ˆæ”¹å–„çš„æªæ–½ã€‚</p><textarea ref={actionRef} rows={2} className="w-full bg-white rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-rose-200 resize-none overflow-hidden transition-all text-gray-700" value={String(data.pdca_action || '')} onChange={(e) => updateReview('pdca_action', e.target.value)} /></div>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex items-center justify-between mb-3"><div className="flex items-center gap-2"><PenLine className="w-5 h-5 text-emerald-500" /><h4 className="font-bold text-gray-800 text-sm">å‘¨æœŸå¿ƒå¾—æ€»ç»“</h4></div><button onClick={handleSaveSummary} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${summarySaved ? 'bg-green-100 text-green-600' : 'bg-emerald-50 text-emerald-600 hover:bg-emerald-100'}`}>{summarySaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> å·²ä¿å­˜</span> : 'ä¿å­˜'}</button></div>
                            <textarea ref={summaryRef} className="w-full min-h-[96px] bg-gray-50 rounded-lg p-3 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-200 resize-none placeholder:text-gray-400 overflow-hidden transition-all" placeholder={`å†™ä¸‹è¿™${period === 'weekly' ? 'ä¸€å‘¨' : 'ä¸€æ®µæ—¶é—´'}çš„å¿ƒå¾—ä½“ä¼šæˆ–ä¸‹ä¸€æ­¥è®¡åˆ’...`} value={String(data.summary || '')} onChange={(e) => updateReview('summary', e.target.value)} />
                        </div>
                    )}
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, onSave }) => {
            if (!isOpen) return null;
            const [configStr, setConfigStr] = useState('');
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="äº‘ç«¯åŒæ­¥è®¾ç½®">
                    <div className="p-6">
                        <div className="bg-blue-50 p-4 rounded-xl mb-4 text-sm text-blue-800">
                            <p className="font-bold mb-2 flex items-center gap-2"><Cloud className="w-4 h-4"/> å¼€å¯å¤šè®¾å¤‡åŒæ­¥</p>
                            <p className="mb-2">1. è®¿é—® <a href="https://console.firebase.google.com/" target="_blank" className="underline font-bold">Firebase Console</a> åˆ›å»ºé¡¹ç›®ã€‚</p>
                            <p className="mb-2">2. åˆ›å»º Web åº”ç”¨ï¼Œå¤åˆ¶ <code>firebaseConfig</code> å¯¹è±¡ (åŒ…å« apiKey, authDomain ç­‰)ã€‚</p>
                            <p>3. ç²˜è´´åˆ°ä¸‹æ–¹æ¡†ä¸­ï¼Œå¼€å¯ Auth (Email/Pass) å’Œ Firestore æ•°æ®åº“ã€‚</p>
                        </div>
                        <textarea 
                            className="w-full h-40 bg-gray-100 p-3 rounded-xl text-xs font-mono mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder='{ "apiKey": "AIzaSy...", "authDomain": "...", ... }'
                            value={configStr}
                            onChange={(e) => setConfigStr(e.target.value)}
                        />
                        <button onClick={() => onSave(configStr)} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">ä¿å­˜é…ç½®å¹¶é‡å¯</button>
                    </div>
                </Modal>
            );
        };

        const AuthModal = ({ isOpen, onClose, auth }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                try {
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                    onClose();
                } catch (err) {
                    setError(err.code === 'auth/invalid-email' ? "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®" : err.code === 'auth/wrong-password' ? "å¯†ç é”™è¯¯" : "æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®");
                } finally { setLoading(false); }
            };

            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={isRegister ? "æ³¨å†Œäº‘ç«¯è´¦æˆ·" : "ç™»å½•äº‘ç«¯è´¦æˆ·"}>
                    <div className="p-6">
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">é‚®ç®±</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 focus:border-blue-500 outline-none" required /></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">å¯†ç </label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 focus:border-blue-500 outline-none" required /></div>
                            {error && <div className="text-xs text-red-500 bg-red-50 p-2 rounded">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition flex justify-center">{loading ? <Loader2 className="animate-spin"/> : (isRegister ? "æ³¨å†Œ" : "ç™»å½•")}</button>
                        </form>
                        <div className="mt-4 text-center"><button onClick={() => setIsRegister(!isRegister)} className="text-xs text-gray-400 underline">{isRegister ? "å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•" : "å»æ³¨å†Œ"}</button></div>
                    </div>
                </Modal>
            );
        };

        const getStorageKey = (key, uid) => `${key}_${uid}`;

        const migrateLegacyData = (uid) => {
            const keys = ['lifeos_sections_v2', 'lifeos_tasks', 'lifeos_reviews', 'lifeos_theme'];
            let hasMigrated = false;
            
            keys.forEach(baseKey => {
                const legacyData = localStorage.getItem(baseKey);
                const userKey = getStorageKey(baseKey, uid);
                const userData = localStorage.getItem(userKey);
                
                // If legacy data exists AND user data does NOT exist, migrate
                if (legacyData && !userData) {
                    localStorage.setItem(userKey, legacyData);
                    hasMigrated = true;
                    console.log(`Migrated ${baseKey} to ${userKey}`);
                }
            });
            return hasMigrated;
        };

        function App() {
            const [currentDate, setCurrentDate] = useState(new Date()); 
            const [selectedDateStr, setSelectedDateStr] = useState(generateDateString(new Date())); 
            
            // --- State Initialization (Empty) ---
            const [sections, setSections] = useState(INITIAL_SECTIONS);
            const [tasksByDate, setTasksByDate] = useState(INITIAL_TASKS_BY_DATE);
            const [reviews, setReviews] = useState({});
            const [globalTheme, setGlobalTheme] = useState({ pageBg: 'gray', headerBg: 'white', cardStyle: 'default' });
            
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            
            // Firebase Refs
            const [firebaseConfig, setFirebaseConfig] = useState(() => JSON.parse(localStorage.getItem('lifeos_fb_config') || 'null'));
            const [firebaseAuth, setFirebaseAuth] = useState(null);
            const [firebaseDb, setFirebaseDb] = useState(null);
            const [user, setUser] = useState(null);
            const isRemoteUpdate = useRef(false);

            // 1. Initialize Firebase if Config Present
            useEffect(() => {
                if (firebaseConfig) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        setFirebaseAuth(getAuth(app));
                        setFirebaseDb(getFirestore(app));
                    } catch (e) {
                        console.error("Firebase init error", e);
                        alert("Firebase é…ç½®æ— æ•ˆï¼Œå·²é‡ç½®ã€‚");
                        localStorage.removeItem('lifeos_fb_config');
                        setFirebaseConfig(null);
                    }
                }
            }, [firebaseConfig]);

            // 2. Main Data Loading Effect (Auth Sensitive)
            useEffect(() => {
                let unsubscribe = null;

                const loadData = async (uid) => {
                    setIsDataLoaded(false);
                    
                    // A. Migration Check
                    migrateLegacyData(uid);

                    // B. Load Local Data (User Specific)
                    const localSections = JSON.parse(localStorage.getItem(getStorageKey('lifeos_sections_v2', uid)));
                    const localTasks = JSON.parse(localStorage.getItem(getStorageKey('lifeos_tasks', uid)));
                    const localReviews = JSON.parse(localStorage.getItem(getStorageKey('lifeos_reviews', uid)));
                    const localTheme = JSON.parse(localStorage.getItem(getStorageKey('lifeos_theme', uid)));

                    if (localSections) setSections(localSections);
                    if (localTasks) setTasksByDate(localTasks);
                    if (localReviews) setReviews(localReviews);
                    if (localTheme) setGlobalTheme(localTheme);

                    // C. Cloud Sync (If Logged In)
                    if (uid !== 'guest' && firebaseDb) {
                        const docRef = doc(firebaseDb, 'users', uid, 'data', 'main');
                        unsubscribe = onSnapshot(docRef, (snap) => {
                            if (snap.exists()) {
                                const data = snap.data();
                                isRemoteUpdate.current = true;
                                if (data.sections) setSections(data.sections);
                                if (data.tasksByDate) setTasksByDate(data.tasksByDate);
                                if (data.reviews) setReviews(data.reviews);
                                if (data.globalTheme) setGlobalTheme(data.globalTheme);
                                // Small delay to prevent echo
                                setTimeout(() => { isRemoteUpdate.current = false; }, 100);
                            } else {
                                // Upload local data if cloud is empty (First Sync)
                                setDoc(docRef, { 
                                    sections: localSections || INITIAL_SECTIONS, 
                                    tasksByDate: localTasks || INITIAL_TASKS_BY_DATE, 
                                    reviews: localReviews || {}, 
                                    globalTheme: localTheme || { pageBg: 'gray', headerBg: 'white', cardStyle: 'default' } 
                                });
                            }
                        });
                    }
                    
                    setIsDataLoaded(true);
                };

                if (firebaseAuth) {
                    // Wait for Auth State
                    const authUnsub = onAuthStateChanged(firebaseAuth, (u) => {
                        setUser(u);
                        loadData(u ? u.uid : 'guest');
                    });
                    return () => { authUnsub(); if(unsubscribe) unsubscribe(); };
                } else {
                    // Guest Mode
                    loadData('guest');
                }
            }, [firebaseAuth, firebaseDb]);

            // 3. Save Data Effect (Debounced or Direct)
            const saveData = (keySuffix, data) => {
                if (!isDataLoaded) return; // Critical Safety Lock
                
                const uid = user ? user.uid : 'guest';
                const key = getStorageKey(keySuffix, uid);
                localStorage.setItem(key, JSON.stringify(data));

                if (user && firebaseDb && !isRemoteUpdate.current) {
                    const docRef = doc(firebaseDb, 'users', uid, 'data', 'main');
                    // Map suffix to object key
                    const fieldMap = {
                        'lifeos_sections_v2': 'sections',
                        'lifeos_tasks': 'tasksByDate',
                        'lifeos_reviews': 'reviews',
                        'lifeos_theme': 'globalTheme'
                    };
                    const fieldName = fieldMap[keySuffix];
                    if (fieldName) {
                        setDoc(docRef, { [fieldName]: data }, { merge: true }).catch(e => console.error("Save Error", e));
                    }
                }
            };

            useEffect(() => saveData('lifeos_sections_v2', sections), [sections, isDataLoaded]);
            useEffect(() => saveData('lifeos_tasks', tasksByDate), [tasksByDate, isDataLoaded]);
            useEffect(() => saveData('lifeos_reviews', reviews), [reviews, isDataLoaded]);
            useEffect(() => saveData('lifeos_theme', globalTheme), [globalTheme, isDataLoaded]);

            // --- Handlers ---
            const handleSaveConfig = (jsonStr) => {
                try {
                    const config = JSON.parse(jsonStr);
                    localStorage.setItem('lifeos_fb_config', JSON.stringify(config));
                    setFirebaseConfig(config);
                    setIsConfigModalOpen(false);
                } catch (e) { alert("é…ç½®æ ¼å¼é”™è¯¯"); }
            };

            const handleLogout = async () => {
                if (confirm("ç¡®å®šé€€å‡ºç™»å½•ï¼Ÿæ•°æ®å°†ä¿ç•™åœ¨æœ¬åœ° (guest)ã€‚")) {
                    await signOut(firebaseAuth);
                }
            };

            const exportData = () => {
                const dataStr = JSON.stringify({ sections, tasksByDate, reviews, globalTheme }, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `lifeos_backup_${generateDateString(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm("è¿™å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šå¯¼å…¥å—ï¼Ÿ")) {
                            if (data.sections) setSections(data.sections);
                            if (data.tasksByDate) setTasksByDate(data.tasksByDate);
                            if (data.reviews) setReviews(data.reviews);
                            if (data.globalTheme) setGlobalTheme(data.globalTheme);
                            alert("å¯¼å…¥æˆåŠŸï¼");
                        }
                    } catch (e) { alert("æ–‡ä»¶æ ¼å¼é”™è¯¯"); }
                };
                reader.readAsText(file);
            };

            // --- UI State & Logic ---
            const [quote, setQuote] = useState(() => GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]);
            const [reviewDate, setReviewDate] = useState(new Date()); 
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isNoteModalOpen, setIsNoteModalOpen] = useState(false); 
            const [currentTask, setCurrentTask] = useState(null); 
            const [targetSection, setTargetSection] = useState(null); 
            const [editingPriority, setEditingPriority] = useState({ important: false, urgent: false });
            const [isSectionManagerOpen, setIsSectionManagerOpen] = useState(false);
            const [isEditSectionMode, setIsEditSectionMode] = useState(false); 
            const [isQuoteEditing, setIsQuoteEditing] = useState(false);
            const [recurrenceType, setRecurrenceType] = useState('none');
            const [settingsTab, setSettingsTab] = useState('sections'); 
            const [isStatsModalOpen, setIsStatsModalOpen] = useState(false);
            const [statsPeriod, setStatsPeriod] = useState(null); 
            const [isReviewCenterOpen, setIsReviewCenterOpen] = useState(false);
            const [reviewTab, setReviewTab] = useState('daily'); 
            const [inputTime, setInputTime] = useState(''); 
            const [isTimerOpen, setIsTimerOpen] = useState(false);
            const [timerActive, setTimerActive] = useState(false);
            const [timerTime, setTimerTime] = useState(25 * 60); 
            const [initialTime, setInitialTime] = useState(25); 
            const [showCelebration, setShowCelebration] = useState(false);
            const [celebrationQuote, setCelebrationQuote] = useState('');

            const calendarDates = useMemo(() => generateCalendarDates(currentDate), [currentDate]);

            useEffect(() => {
                let interval = null;
                if (timerActive && timerTime > 0) {
                    interval = setInterval(() => { setTimerTime((prev) => prev - 1); }, 1000);
                } else if (timerTime === 0 && timerActive) {
                    setTimerActive(false);
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-fairy-message-chime-2022.mp3');
                    audio.play().catch(e => console.log('Audio play failed', e));
                }
                return () => clearInterval(interval);
            }, [timerActive, timerTime]);

            const toggleTimer = () => setTimerActive(!timerActive);
            const resetTimer = () => { setTimerActive(false); setTimerTime(initialTime * 60); };
            const handleTimeChange = (e) => { const m = parseInt(e.target.value) || 0; setInitialTime(m); if (!timerActive) setTimerTime(m * 60); };
            const tasks = useMemo(() => tasksByDate[selectedDateStr] || {}, [tasksByDate, selectedDateStr]);
            
            const handleReviewDateChange = (direction) => { 
                const newDate = new Date(reviewDate); 
                if (reviewTab === 'daily') newDate.setDate(newDate.getDate() + direction);
                else if (reviewTab === 'weekly') newDate.setDate(newDate.getDate() + direction * 7);
                else if (reviewTab === 'monthly') newDate.setMonth(newDate.getMonth() + direction);
                else if (reviewTab === 'yearly') newDate.setFullYear(newDate.getFullYear() + direction);
                setReviewDate(newDate); 
            };

            const statsData = useMemo(() => {
                if (!statsPeriod) return { data: [], totalMins: 0, avgMins: 0, activeDays: 0 };
                let targetDates = []; const y = currentDate.getFullYear(); const m = currentDate.getMonth();
                if (statsPeriod === 'daily') targetDates.push(generateDateString(currentDate));
                else if (statsPeriod === 'weekly') { const { start } = getWeekRange(currentDate); for(let i=0; i<7; i++) { const temp = new Date(start); temp.setDate(start.getDate() + i); targetDates.push(generateDateString(temp)); } }
                else if (statsPeriod === 'monthly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy, dm] = dateStr.split('-').map(Number); if (dy === y && dm === m + 1) targetDates.push(dateStr); }); }
                else if (statsPeriod === 'yearly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy] = dateStr.split('-').map(Number); if (dy === y) targetDates.push(dateStr); }); }
                let tagMap = {}; let totalMins = 0; let activeDays = new Set(); let completedCount = 0;
                targetDates.forEach(dateStr => { const dayTasks = tasksByDate[dateStr]; if (!dayTasks) return; let hasCompleted = false; [...sections.map(s => s.id), 'fragmentary'].forEach(sec => { (dayTasks[sec] || []).forEach(task => { if (task.completed) { hasCompleted = true; completedCount++; const tag = task.tag || 'æœªåˆ†ç±»'; const mins = task.time ? parseDurationFromTimeStr(task.time) : 30; tagMap[tag] = (tagMap[tag] || 0) + mins; totalMins += mins; } }); }); if (hasCompleted) activeDays.add(dateStr); });
                const colors = ['#fca5a5', '#93c5fd', '#6ee7b7', '#fcd34d', '#c4b5fd', '#f9a8d4', '#818cf8', '#34d399', '#fbbf24', '#f87171'];
                const data = Object.keys(tagMap).map((k, i) => ({ tag: k, value: tagMap[k], color: colors[i % colors.length] })).sort((a,b) => b.value - a.value);
                const avgMins = activeDays.size > 0 ? Math.round(totalMins / activeDays.size) : 0;
                return { data, totalMins, avgMins, activeDays: activeDays.size };
            }, [statsPeriod, currentDate, tasksByDate, sections]);

            const stats = useMemo(() => {
                let impUrg = 0, impNotUrg = 0, urgNotImp = 0, notUrgNotImp = 0; 
                const allSectionTasks = sections.flatMap(sec => tasks[sec.id] || []);
                const fragTasks = tasks.fragmentary || [];
                [...allSectionTasks, ...fragTasks].forEach(t => { if (t.important && t.urgent) impUrg++; else if (t.important) impNotUrg++; else if (t.urgent) urgNotImp++; else notUrgNotImp++; });
                return { impUrg, impNotUrg, urgNotImp, notUrgNotImp, total: allSectionTasks.length + fragTasks.length };
            }, [tasks, sections]);

            const dailyProgress = useMemo(() => {
                const allSectionTasks = sections.flatMap(sec => tasks[sec.id] || []);
                if (allSectionTasks.length === 0) return 0;
                return Math.round((allSectionTasks.filter(t => t.completed).length / allSectionTasks.length) * 100);
            }, [tasks, sections]);

            const handleDateSelect = (dateObj) => { setCurrentDate(dateObj); setSelectedDateStr(generateDateString(dateObj)); };
            const handleDatePickerChange = (e) => { if (e.target.value) { const [y, m, d] = e.target.value.split('-').map(Number); handleDateSelect(new Date(y, m - 1, d)); } };
            const handleBackToToday = () => { const today = new Date(); setCurrentDate(today); setSelectedDateStr(generateDateString(today)); };
            
            const handleToggleTask = (id) => { 
                setTasksByDate(prev => { 
                    const d = { ...(prev[selectedDateStr] || {}) }; 
                    let s = null; 
                    for (const k of [...sections.map(x => x.id), 'fragmentary']) { if (d[k]?.some(t => t.id === id)) { s = k; break; } } 
                    if (s) { 
                        const newTasks = d[s].map(t => t.id === id ? { ...t, completed: !t.completed } : t); d[s] = newTasks;
                        const allDayTasks = []; [...sections.map(sec => sec.id), 'fragmentary'].forEach(secId => { allDayTasks.push(...(secId === s ? newTasks : (d[secId] || []))); });
                        const total = allDayTasks.length; const completed = allDayTasks.filter(t => t.completed).length;
                        if (total > 0 && completed === total) { setCelebrationQuote(GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]); setShowCelebration(true); }
                    } return { ...prev, [selectedDateStr]: d }; 
                }); 
            };
            
            const handleEditTask = (task, sectionId) => { setCurrentTask({ ...task, sectionId }); setTargetSection(sectionId); setEditingPriority({ important: task.important, urgent: task.urgent }); setInputTime(task.time || ''); setRecurrenceType('none'); setIsTaskModalOpen(true); };
            const handleAddTask = (sectionId) => { setCurrentTask(null); setTargetSection(sectionId); setEditingPriority({ important: false, urgent: false }); setInputTime(''); setRecurrenceType('none'); setIsTaskModalOpen(true); };
            const handleOpenNote = (task) => { let s = null; const d = tasksByDate[selectedDateStr] || {}; for (const k of [...sections.map(x => x.id), 'fragmentary']) { if (d[k]?.some(t => t.id === task.id)) { s = k; break; } } setCurrentTask({ ...task, sectionId: s }); setIsNoteModalOpen(true); };
            const saveNote = (e) => { e.preventDefault(); const n = new FormData(e.target).get('note'); setTasksByDate(p => { const ns = { ...p }; const s = currentTask.sectionId; if (ns[selectedDateStr]?.[s]) { ns[selectedDateStr][s] = ns[selectedDateStr][s].map(t => t.id === currentTask.id ? { ...t, note: n } : t); } return ns; }); setIsNoteModalOpen(false); };
            const saveTask = (e) => { 
                e.preventDefault(); const f = new FormData(e.target); const isNew = !currentTask; const id = currentTask ? currentTask.id : Date.now(); const recurrence = f.get('recurrence'); 
                const baseTask = { title: f.get('title'), time: inputTime, tag: f.get('tag'), note: currentTask?.note || '', important: editingPriority.important, urgent: editingPriority.urgent, completed: currentTask?.completed || false, recurring: recurrence !== 'none' };
                setTasksByDate(prev => { 
                    const newMap = { ...prev };
                    const addToDate = (dateStr, taskToAdd, isFutureSync = false) => { 
                        if (!newMap[dateStr]) newMap[dateStr] = {}; const dateTasks = { ...newMap[dateStr] }; const sectionTasks = [...(dateTasks[targetSection] || [])]; 
                        if (isNew && !isFutureSync) { sectionTasks.push({ ...taskToAdd, id: Date.now() + Math.random() }); } else { 
                            const idx = sectionTasks.findIndex(t => t.id === id); 
                            if (idx > -1 && !isFutureSync) { sectionTasks[idx] = { ...taskToAdd, id }; } 
                            else if (isFutureSync) { const dupIdx = sectionTasks.findIndex(t => t.title === taskToAdd.title && t.time === taskToAdd.time); if (dupIdx > -1) { sectionTasks[dupIdx] = { ...taskToAdd, id: sectionTasks[dupIdx].id }; } else { sectionTasks.push({ ...taskToAdd, id: Date.now() + Math.random() }); } }
                        } 
                        dateTasks[targetSection] = sectionTasks; newMap[dateStr] = dateTasks; 
                    };
                    addToDate(selectedDateStr, baseTask, false);
                    if (recurrence !== 'none') { const startDate = new Date(currentDate); const customDays = f.getAll('customDays').map(Number); for (let i = 1; i <= 30; i++) { const nextDate = new Date(startDate); nextDate.setDate(startDate.getDate() + i); let shouldAdd = false; if (recurrence === 'daily') shouldAdd = true; else if (recurrence === 'custom') { if (customDays.includes(nextDate.getDay())) shouldAdd = true; } if (shouldAdd) { addToDate(generateDateString(nextDate), { ...baseTask, completed: false }, true); } } }
                    return newMap; 
                }); setIsTaskModalOpen(false); 
            };
            const handleDeleteTaskDirectly = (id, s) => { setTasksByDate(prev => { const newDateMap = { ...prev }; const dateData = { ...(newDateMap[selectedDateStr] || {}) }; if (dateData[s]) { dateData[s] = dateData[s].filter(t => t.id !== id); newDateMap[selectedDateStr] = dateData; } return newDateMap; }); };
            const handleSaveSection = (e) => { e.preventDefault(); const f = new FormData(e.target); const s = { id: f.get('id') || `sec_${Date.now()}`, title: f.get('title'), icon: f.get('icon'), color: f.get('color') }; if (f.get('isNew') === 'true') setSections([...sections, s]); else setSections(sections.map(x => x.id === s.id ? s : x)); setIsEditSectionMode(false); };
            const handleDeleteSection = (id) => { if (confirm('ç¡®è®¤åˆ é™¤?')) { setSections(sections.filter(s => s.id !== id)); setIsEditSectionMode(false); } };
            const handleTaskRemind = (task) => { downloadICS([task], selectedDateStr, "Task"); };
            const refreshQuote = () => { setQuote(GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]); };
            const openStats = (period) => { setStatsPeriod(period); setIsStatsModalOpen(true); };
            const openReviewCenter = (tab) => { setReviewTab(tab); setReviewDate(currentDate); setIsReviewCenterOpen(true); };

            // Render Loading if Data not ready
            if (!isDataLoaded) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 flex-col gap-4">
                        <Loader2 className="w-8 h-8 text-blue-500 animate-spin" />
                        <span className="text-sm text-gray-500 font-medium">æ­£åœ¨åŠ è½½æ•°æ®...</span>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen font-sans text-slate-800 pb-20 selection:bg-blue-100 ${PALETTE[globalTheme.pageBg]?.bg || 'bg-[#F5F7FA]'}`}>
                    
                    {/* Header: æåº¦ç´§å‡‘ä¼˜åŒ–ç‰ˆ */}
                    <div className={`sticky top-0 z-50 shadow-sm rounded-b-xl mb-3 transition-all ${PALETTE[globalTheme.headerBg]?.bg || 'bg-white'}`}>
                        <header className="px-3 pt-2 pb-0">
                            <div className="flex flex-col md:flex-row justify-between items-center mb-1 gap-1">
                                {/* Top Row: Date + Mobile Buttons */}
                                <div className="flex items-center gap-2 shrink-0 w-full md:w-auto justify-between md:justify-start">
                                    <div className="flex items-center gap-1">
                                        <div className="relative group">
                                            <div className="flex items-center gap-0.5 text-2xl font-black text-slate-800 cursor-pointer hover:text-blue-600 transition-colors tracking-tight" title="é€‰æ‹©æ—¥æœŸ">{currentDate.getFullYear()}.{currentDate.getMonth() + 1}</div>
                                            <input type="date" className="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10" onChange={handleDatePickerChange} />
                                        </div>
                                        {selectedDateStr !== generateDateString(new Date()) && (<button onClick={handleBackToToday} className="px-2 py-0.5 bg-blue-50 text-blue-600 text-[10px] font-bold rounded-md hover:bg-blue-100 flex items-center gap-1 shadow-sm transition-all z-20 active:scale-95"><RotateCcw className="w-3 h-3" />ä»Šå¤©</button>)}
                                    </div>
                                    <div className="flex gap-2">
                                        {/* æ–°å¢ï¼šæ¿å—ç®¡ç†æŒ‰é’®ç§»è‡³æ­¤å¤„ (Mobile) */}
                                        <button onClick={() => setIsSectionManagerOpen(true)} className="md:hidden flex items-center gap-1 text-[10px] px-2 py-1 rounded-full bg-gray-50 border border-gray-200 text-gray-600"><Settings2 className="w-3 h-3" /></button>
                                        <button onClick={() => { if (!user) setIsConfigModalOpen(true); else setIsAuthModalOpen(true); }} className="md:hidden flex items-center gap-1 text-[10px] px-2 py-1 rounded-full bg-blue-50 border border-blue-100 text-blue-600"><Cloud className="w-3 h-3" /></button>
                                        <button onClick={(e) => { e.stopPropagation(); openReviewCenter('daily'); }} className="md:hidden bg-[#1E293B] text-white px-3 py-1 rounded-full text-[10px] font-bold flex items-center gap-1 hover:bg-slate-700 transition active:scale-95 shadow-lg shadow-slate-200 whitespace-nowrap"><LayoutGrid className="w-3 h-3" /> å¤ç›˜</button>
                                    </div>
                                </div>

                                {/* Quote - æ›´åŠ ç´§å‡‘ */}
                                <div className="flex-1 flex justify-center w-full md:w-auto order-last md:order-none -mt-0.5 md:mt-0">
                                    <div className="flex items-center gap-2 group cursor-pointer transition-all hover:scale-105 px-2 py-0.5 rounded-lg hover:bg-gray-50/50" onClick={() => !isQuoteEditing && setIsQuoteEditing(true)}>
                                        <span className="hidden lg:flex bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-0.5 rounded-full items-center gap-1 shrink-0 shadow-sm border border-orange-200">ğŸ”¥ 3 å¤©</span>
                                        {isQuoteEditing ? (<input autoFocus className="text-xs font-serif font-medium text-gray-700 border-b-2 border-blue-500 outline-none text-center min-w-[200px] bg-transparent" value={quote} onChange={(e) => setQuote(e.target.value)} onBlur={() => setIsQuoteEditing(false)} onKeyDown={(e) => e.key === 'Enter' && setIsQuoteEditing(false)} />) : (<div className="flex items-center gap-1"><p className="text-slate-500 text-xs font-serif font-medium hover:text-blue-600 transition-colors text-center italic truncate max-w-[240px] md:max-w-md scale-90 origin-center" title="ç‚¹å‡»ç¼–è¾‘è¯­å½•">â€œ{quote}â€</p><button onClick={(e) => { e.stopPropagation(); refreshQuote(); }} className="text-gray-300 hover:text-blue-500 transition-colors shrink-0 p-0.5 rounded-full hover:bg-gray-100" title="éšæœºåˆ‡æ¢"><Shuffle className="w-2.5 h-2.5" /></button></div>)}
                                    </div>
                                </div>

                                <div className="hidden md:flex items-center gap-3 shrink-0">
                                    <div className="flex items-center gap-2">
                                        {/* æ–°å¢ï¼šæ¿å—ç®¡ç†æŒ‰é’®ç§»è‡³æ­¤å¤„ (Desktop) */}
                                        <button onClick={() => setIsSectionManagerOpen(true)} title="æ¿å—ç®¡ç†" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition"><Settings2 className="w-4 h-4"/></button>
                                        <button onClick={exportData} title="å¯¼å‡ºæ•°æ® (JSON)" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition"><Download className="w-4 h-4"/></button>
                                        <label title="å¯¼å…¥æ•°æ®" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition cursor-pointer"><Upload className="w-4 h-4"/><input type="file" className="hidden" accept=".json" onChange={importData}/></label>
                                    </div>
                                    <div className="h-4 w-px bg-gray-200"></div>
                                    
                                    {!firebaseConfig ? (
                                        <button onClick={() => setIsConfigModalOpen(true)} className="text-[10px] bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full border border-gray-200 flex items-center gap-1 hover:bg-gray-200 transition"><Cloud className="w-3 h-3"/> è¿æ¥äº‘ç«¯</button>
                                    ) : !user ? (
                                        <button onClick={() => setIsAuthModalOpen(true)} className="text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full border border-blue-200 flex items-center gap-1 hover:bg-blue-100 transition"><LogIn className="w-3 h-3"/> ç™»å½•åŒæ­¥</button>
                                    ) : (
                                        <button onClick={handleLogout} className="text-[10px] bg-green-50 text-green-600 px-3 py-1.5 rounded-full border border-green-200 flex items-center gap-1 hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition group"><User className="w-3 h-3"/> {user.email.split('@')[0]} <LogOut className="w-3 h-3 hidden group-hover:block ml-1"/></button>
                                    )}
                                    
                                    <button onClick={(e) => { e.stopPropagation(); openReviewCenter('daily'); }} className="bg-[#1E293B] text-white px-5 py-2 rounded-full text-xs font-bold flex items-center gap-2 hover:bg-slate-700 transition active:scale-95 shadow-lg shadow-slate-200 whitespace-nowrap"><LayoutGrid className="w-4 h-4" /> å¤ç›˜/ç›®æ ‡</button>
                                </div>
                            </div>
                        </header>
                        
                        {/* Calendar Strip - é«˜åº¦å‹ç¼©è‡³ h-10, å­—ä½“åŠ å¤§ */}
                        <div className="pb-1 px-1">
                            <div className="flex justify-between items-center px-0.5">
                                <button onClick={() => handleDateSelect(new Date(currentDate.setDate(currentDate.getDate() - 1)))} className="p-1 text-gray-300 hover:text-gray-600"><ChevronLeft className="w-4 h-4" /></button>
                                <div className="flex-1 flex justify-between px-1 overflow-x-auto overflow-y-hidden scrollbar-hide">
                                    {calendarDates.map((d, i) => { const isActive = d.fullDate === selectedDateStr; return (<div key={i} onClick={() => handleDateSelect(d.obj)} className={`flex flex-col items-center justify-center min-w-[36px] h-10 rounded-lg cursor-pointer transition-all mx-0.5 ${isActive ? 'bg-blue-600 text-white shadow-lg shadow-blue-200 scale-105' : 'text-gray-400 hover:bg-gray-50'}`}><span className="text-[10px] mb-0 opacity-90 font-medium">{d.dayName}</span><span className="text-lg font-black leading-none">{d.dateNum}</span></div>); })}
                                </div>
                                <button onClick={() => handleDateSelect(new Date(currentDate.setDate(currentDate.getDate() + 1)))} className="p-1 text-gray-300 hover:text-gray-600"><ChevronRight className="w-4 h-4" /></button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto px-4 md:px-6">
                        <div className="bg-white rounded-xl p-3 shadow-sm mb-3 flex justify-between items-center relative z-10">
                            <div className="flex gap-4 md:gap-16 overflow-x-auto scrollbar-hide w-full md:w-auto">
                                <CircularProgress onClick={() => openStats('daily')} percentage={dailyProgress} label="ä»Šæ—¥" subLabel="å·²å®Œæˆ" colorClass="text-blue-400" trackClass="text-blue-50" />
                                <CircularProgress onClick={() => openStats('weekly')} percentage={50} label="æœ¬å‘¨" subLabel="æ•°æ®ä¸­" colorClass="text-indigo-400" trackClass="text-indigo-50" />
                                <CircularProgress onClick={() => openStats('monthly')} percentage={30} label="æœ¬æœˆ" subLabel="è¿›è¡Œä¸­" colorClass="text-orange-400" trackClass="text-orange-50" />
                                <CircularProgress onClick={() => openStats('yearly')} percentage={10} label="å¹´åº¦" subLabel="ç§¯ç´¯ä¸­" colorClass="text-red-400" trackClass="text-red-50" />
                            </div>
                            <div className="flex flex-col items-center cursor-pointer group ml-4 shrink-0" onClick={() => setIsTimerOpen(true)}>
                                <button className={`bg-slate-100 rounded-full p-2 mb-1 relative transition-all group-hover:bg-slate-200 ${timerActive ? 'ring-2 ring-red-300 animate-pulse' : ''}`}><div className="text-xs font-bold text-slate-700 min-w-[32px] text-center">{timerActive ? formatTime(timerTime) : `${initialTime}:00`}</div><span className="absolute -top-1 -right-1 text-lg">ğŸ…</span></button><div className="text-[10px] text-gray-400 group-hover:text-red-500">ä¸“æ³¨</div>
                            </div>
                        </div>
                        
                        {/* ç»Ÿè®¡å¡ç‰‡ï¼šæåº¦æ‰å¹³åŒ– + ç´§å‡‘ç½‘æ ¼ */}
                        <div className="grid grid-cols-4 gap-1.5 mb-2">
                            <StatCard number={stats.impUrg} title="é‡è¦ç´§æ€¥" subText={`${Math.round(stats.impUrg/stats.total*100) || 0}%`} colorTheme="red" />
                            <StatCard number={stats.impNotUrg} title="é‡è¦ä¸æ€¥" subText={`${Math.round(stats.impNotUrg/stats.total*100) || 0}%`} colorTheme="orange" />
                            <StatCard number={stats.urgNotImp} title="ç´§æ€¥ä¸é‡" subText={`${Math.round(stats.urgNotImp/stats.total*100) || 0}%`} colorTheme="blue" />
                            <StatCard number={stats.notUrgNotImp} title="ä¸æ€¥ä¸é‡" subText={`${Math.round(stats.notUrgNotImp/stats.total*100) || 0}%`} colorTheme="green" />
                        </div>
                        
                        {/* ä»»åŠ¡çœ‹æ¿åŒºåŸŸ - åˆ é™¤äº†æ ‡é¢˜è¡Œï¼Œç›´æ¥å±•ç¤ºå†…å®¹ */}
                        <div className="grid grid-cols-1 gap-3 mb-6">
                            {sections.map(section => (
                                <div key={section.id}>
                                    <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2"><React.Fragment>{React.createElement(ICON_MAP[section.icon] || Circle, { className: `w-5 h-5 ${COLOR_THEMES[section.color]?.icon || 'text-gray-400'} fill-current` })}</React.Fragment><h2 className={`font-bold text-lg ${COLOR_THEMES[section.color]?.text || 'text-gray-700'}`}>{section.title}</h2></div><button onClick={() => downloadICS(tasks[section.id], selectedDateStr, section.title)} className={`text-xs px-3 py-1.5 rounded-full flex items-center gap-1 transition-colors ${COLOR_THEMES[section.color]?.bg || 'bg-gray-100'} ${COLOR_THEMES[section.color]?.text || 'text-gray-600'} ${COLOR_THEMES[section.color]?.buttonBg || 'hover:bg-gray-200'}`}><Bell className="w-3 h-3" /> æé†’</button></div>
                                    <div className={`space-y-3 min-h-[50px] p-2.5 rounded-xl border border-dashed ${COLOR_THEMES[section.color]?.border || 'border-gray-200'} ${COLOR_THEMES[section.color]?.bg || 'bg-gray-50'} bg-opacity-30`}>{tasks[section.id]?.length === 0 && <div className="text-center py-4 text-gray-400 text-xs">æœ¬æ—¥æš‚æ— å®‰æ’</div>}{tasks[section.id]?.map(task => (<TaskCard key={task.id} task={task} onToggle={handleToggleTask} onEdit={(t) => handleEditTask(t, section.id)} onDelete={(id) => handleDeleteTaskDirectly(id, section.id)} onNote={handleOpenNote} onRemind={handleTaskRemind} cardStyle={globalTheme.cardStyle} sectionColor={section.color} />))}</div>
                                    <button onClick={() => handleAddTask(section.id)} className={`w-full py-3 mt-3 rounded-xl border-2 border-dashed ${COLOR_THEMES[section.color]?.border || 'border-gray-300'} ${COLOR_THEMES[section.color]?.text || 'text-gray-500'} flex items-center justify-center hover:${COLOR_THEMES[section.color]?.bg || 'bg-gray-100'} transition-colors group`}><Plus className="w-5 h-5 group-hover:scale-110 transition-transform" /></button>
                                </div>
                            ))}
                        </div>

                        <div className="bg-white rounded-xl p-4 shadow-sm mb-8">
                            <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-3"><span className="bg-yellow-100 text-yellow-600 text-xs font-bold px-2 py-1 rounded">TODO</span><span className="font-bold text-slate-700">ç¢ç‰‡æ¸…å•</span></div><button onClick={() => handleAddTask('fragmentary')} className="px-3 py-1.5 bg-blue-50 text-blue-600 text-xs rounded hover:bg-blue-100 transition flex items-center gap-1"><Plus className="w-3 h-3" /> æ·»åŠ </button></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">{tasks.fragmentary?.map(task => (<div key={task.id} onClick={() => handleToggleTask(task.id)} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition group"><div className="flex items-center gap-3"><button onClick={(e) => { e.stopPropagation(); handleToggleTask(task.id); }} className="text-gray-300 hover:text-indigo-500 flex-shrink-0">{task.completed ? <CheckCircle2 className="w-5 h-5 text-indigo-500" /> : <Circle className="w-5 h-5" />}</button><span className={`text-sm text-gray-700 ${task.completed ? 'line-through text-gray-400' : ''}`}>{task.title}</span></div><div className="flex items-center gap-1"><button onClick={(e) => { e.stopPropagation(); handleEditTask(task, 'fragmentary'); }} className="p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded transition"><Edit3 className="w-3.5 h-3.5" /></button><button onClick={(e) => { e.stopPropagation(); handleDeleteTaskDirectly(task.id, 'fragmentary'); }} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition"><Trash2 className="w-3.5 h-3.5" /></button></div></div>))}</div>
                        </div>
                    </div>

                    {/* Modals */}
                    <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title={currentTask ? "ç¼–è¾‘ä»»åŠ¡" : "æ·»åŠ æ–°ä»»åŠ¡"}>
                        <form onSubmit={saveTask} className="flex flex-col gap-5 p-1">
                            <div><label className="block text-xs font-bold text-gray-500 mb-1.5">ä»»åŠ¡åç§°</label><input name="title" defaultValue={currentTask?.title} placeholder="ä¾‹å¦‚ï¼šé˜…è¯»30åˆ†é’Ÿ" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" required autoFocus /></div>
                            <div className="flex items-end gap-4"><div className="flex-1"><label className="block text-xs font-bold text-gray-500 mb-1.5">æ—¶é—´æ®µ</label><TimeRangePicker value={inputTime} onChange={setInputTime} key={currentTask?.id || 'new'} /></div><div className="w-24 shrink-0"><label className="block text-xs font-bold text-gray-500 mb-1.5">æ ‡ç­¾</label><input list="tag-suggestions" name="tag" defaultValue={currentTask?.tag} placeholder="å¦‚: å·¥ä½œ" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-2 py-2.5 text-xs text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" /><datalist id="tag-suggestions"><option value="å·¥ä½œ" /><option value="å­¦ä¹ " /><option value="ç”Ÿæ´»" /><option value="è¿åŠ¨" /></datalist></div></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-2">é‡è¦/ç´§æ€¥ç¨‹åº¦</label><div className="flex justify-around bg-gray-50 p-3.5 rounded-xl border border-gray-200"><button type="button" onClick={() => setEditingPriority({ important: true, urgent: true })} className={`flex flex-col items-center gap-1.5 transition-all ${editingPriority.important && editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-indigo-500 ${editingPriority.important && editingPriority.urgent ? 'ring-2 ring-offset-2 ring-indigo-300' : ''}`}></div><span className="text-[10px] font-bold text-indigo-700">é‡è¦ç´§æ€¥</span></button><button type="button" onClick={() => setEditingPriority({ important: true, urgent: false })} className={`flex flex-col items-center gap-1.5 transition-all ${editingPriority.important && !editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-blue-500 ${editingPriority.important && !editingPriority.urgent ? 'ring-2 ring-offset-2 ring-blue-300' : ''}`}></div><span className="text-[10px] font-bold text-blue-700">é‡è¦ä¸æ€¥</span></button><button type="button" onClick={() => setEditingPriority({ important: false, urgent: true })} className={`flex flex-col items-center gap-1.5 transition-all ${!editingPriority.important && editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-red-500 ${!editingPriority.important && editingPriority.urgent ? 'ring-2 ring-offset-2 ring-red-300' : ''}`}></div><span className="text-[10px] font-bold text-red-700">ç´§æ€¥ä¸é‡</span></button><button type="button" onClick={() => setEditingPriority({ important: false, urgent: false })} className={`flex flex-col items-center gap-1.5 transition-all ${!editingPriority.important && !editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-emerald-500 ${!editingPriority.important && !editingPriority.urgent ? 'ring-2 ring-offset-2 ring-emerald-300' : ''}`}></div><span className="text-[10px] font-bold text-emerald-700">ä¸æ€¥ä¸é‡</span></button></div></div>
                            <div className="bg-blue-50/50 p-3.5 rounded-xl border border-blue-100 flex flex-col gap-3"><div className="flex items-center justify-between"><div className="flex items-center gap-1.5"><Repeat className="w-4 h-4 text-blue-500" /><label className="text-xs font-bold text-blue-700">åŒæ­¥/é‡å¤(æœªæ¥30å¤©)</label></div><div className="flex gap-3 text-xs font-medium text-blue-800"><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="none" checked={recurrenceType === 'none'} onChange={() => setRecurrenceType('none')} className="accent-blue-600" />å•æ¬¡</label><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="daily" checked={recurrenceType === 'daily'} onChange={() => setRecurrenceType('daily')} className="accent-blue-600" />æ¯å¤©</label><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="custom" checked={recurrenceType === 'custom'} onChange={() => setRecurrenceType('custom')} className="accent-blue-600" />è‡ªå®šä¹‰</label></div></div>{recurrenceType === 'custom' && (<div className="flex justify-between mt-1 px-2">{['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map((d, i) => (<label key={i} className="flex flex-col items-center cursor-pointer group"><input type="checkbox" name="customDays" value={i} className="peer sr-only" /><div className="w-7 h-7 rounded-full bg-white border border-blue-200 flex items-center justify-center text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all group-hover:border-blue-400">{d}</div></label>))}</div>)}</div>
                            <div className="flex gap-3 mt-2"><button type="button" onClick={() => setIsTaskModalOpen(false)} className="px-5 py-2.5 text-gray-500 text-sm bg-gray-100 hover:bg-gray-200 rounded-xl transition font-bold">å–æ¶ˆ</button><button type="submit" className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-md shadow-blue-200"><Save className="w-4 h-4" /> ä¿å­˜</button></div>
                        </form>
                    </Modal>
                    
                    <Modal isOpen={isNoteModalOpen} onClose={() => setIsNoteModalOpen(false)} title="æ·»åŠ /ç¼–è¾‘å¤‡æ³¨">
                        <form onSubmit={saveNote} className="flex flex-col gap-4">
                            <div className="bg-yellow-50 p-3 rounded-lg mb-2"><h4 className="text-sm font-bold text-gray-800 mb-1">{currentTask?.title}</h4><p className="text-xs text-gray-500">åœ¨è¿™ä¸ªä»»åŠ¡ä¸­è®°å½•æƒ³æ³•æˆ–ç»†èŠ‚...</p></div>
                            <textarea name="note" defaultValue={currentTask?.note} placeholder="ä¾‹å¦‚ï¼šä¼šè®®çºªè¦ã€é˜…è¯»ç¬”è®°ã€è´­ç‰©æ¸…å•..." className="w-full h-32 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" autoFocus />
                            <div className="flex justify-end gap-3 mt-2"><button type="button" onClick={() => setIsNoteModalOpen(false)} className="px-4 py-2 text-gray-500 text-sm hover:bg-gray-100 rounded-lg transition">å–æ¶ˆ</button><button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition flex items-center gap-2"><Save className="w-4 h-4" /> ä¿å­˜å¤‡æ³¨</button></div>
                        </form>
                    </Modal>

                    <Modal isOpen={isSectionManagerOpen} onClose={() => {setIsSectionManagerOpen(false); setIsEditSectionMode(false); setSettingsTab('sections')}} title="è‡ªå®šä¹‰æ¿å—ç®¡ç†">
                        <div className="flex flex-col h-full"><div className="flex border-b border-gray-100 mb-4"><button onClick={() => setSettingsTab('sections')} className={`flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'sections' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400'}`}>æ¿å—ç®¡ç†</button><button onClick={() => setSettingsTab('appearance')} className={`flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'appearance' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400'}`}>å¤–è§‚è®¾ç½®</button></div>{settingsTab === 'sections' && (<div className="space-y-4">{!isEditSectionMode ? (<><button onClick={() => setIsEditSectionMode({ isNew: true })} className="w-full py-2 bg-blue-50 text-blue-600 rounded-lg mb-2 font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition"><Plus className="w-4 h-4"/> æ–°å¢æ¿å—</button>{sections.map(s => <div key={s.id} className="flex justify-between p-3 border border-gray-100 rounded-xl items-center bg-gray-50 hover:bg-white hover:shadow-sm transition"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-lg flex items-center justify-center ${COLOR_THEMES[s.color]?.bg || 'bg-gray-200'} ${COLOR_THEMES[s.color]?.text || 'text-gray-700'}`}>{React.createElement(ICON_MAP[s.icon] || Circle, { className: "w-5 h-5" })}</div><span className="font-bold text-slate-700">{s.title}</span></div><div className="flex gap-2"><button onClick={() => setIsEditSectionMode(s)} className="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition"><Edit3 className="w-4 h-4" /></button><button onClick={() => handleDeleteSection(s.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"><Trash2 className="w-4 h-4" /></button></div></div>)}</>) : (<form onSubmit={handleSaveSection} className="flex flex-col gap-5"><input type="hidden" name="id" value={isEditSectionMode.id || ''} /><input type="hidden" name="isNew" value={isEditSectionMode.isNew ? 'true' : 'false'} /><div><label className="block text-xs font-bold text-gray-500 mb-2">æ¿å—åç§°</label><input name="title" defaultValue={isEditSectionMode.title} placeholder="ä¾‹å¦‚: æ™¨é—´é˜…è¯»" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div><div><label className="block text-xs font-bold text-gray-500 mb-2">é€‰æ‹©å›¾æ ‡</label><div className="grid grid-cols-4 gap-2">{Object.keys(ICON_MAP).map(k=><label key={k} className="cursor-pointer"><input type="radio" name="icon" value={k} defaultChecked={isEditSectionMode.icon===k} className="peer sr-only"/><div className="w-full h-12 rounded-xl bg-gray-50 border border-gray-100 flex items-center justify-center text-gray-400 peer-checked:bg-blue-50 peer-checked:border-blue-200 peer-checked:text-blue-600 hover:bg-gray-100 transition">{React.createElement(ICON_MAP[k], { className: "w-5 h-5" })}</div></label>)}</div></div><div><label className="block text-xs font-bold text-gray-500 mb-3">ä¸»é¢˜è‰²ç³»</label><div className="grid grid-cols-4 gap-3">{Object.keys(COLOR_THEMES).map(k=>(<label key={k} className="cursor-pointer flex flex-col items-center gap-1 group"><input type="radio" name="color" value={k} defaultChecked={isEditSectionMode.color===k} className="peer sr-only"/><div className={`w-10 h-10 rounded-full shadow-sm border-2 border-white transition-all peer-checked:scale-110 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-300 ${COLOR_THEMES[k].preview} group-hover:scale-105`}></div><span className="text-[10px] text-gray-400 peer-checked:text-gray-800 font-medium">{COLOR_THEMES[k].label}</span></label>))}</div></div><div className="flex gap-3 pt-2"><button type="button" onClick={() => setIsEditSectionMode(false)} className="flex-1 py-3 text-gray-500 text-sm font-bold hover:bg-gray-100 rounded-xl transition">å–æ¶ˆ</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200">ä¿å­˜æ¿å—</button></div></form>)}</div>)}{settingsTab === 'appearance' && (<div className="space-y-6 pb-4"><div><label className="block text-xs font-bold text-gray-500 mb-3 flex items-center gap-1"><Layout className="w-4 h-4"/> é¡µé¢å¤§èƒŒæ™¯</label><div className="grid grid-cols-3 sm:grid-cols-4 gap-3">{Object.keys(PALETTE).map(key => (<button key={key} onClick={() => setGlobalTheme(prev => ({ ...prev, headerBg: key }))} className={`h-10 rounded-xl border-2 transition-all flex items-center justify-center text-[10px] font-bold ${PALETTE[key].bg} ${PALETTE[key].text} ${globalTheme.headerBg === key ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-200 hover:border-gray-300'}`}>{PALETTE[key].label}</button>))}</div></div><div><label className="block text-xs font-bold text-gray-500 mb-3 flex items-center gap-1"><ListTodo className="w-4 h-4"/> ä»»åŠ¡å¡ç‰‡é£æ ¼</label><div className="flex gap-4"><button onClick={() => setGlobalTheme(prev => ({ ...prev, cardStyle: 'default' }))} className={`flex-1 p-3 rounded-xl border-2 transition-all ${globalTheme.cardStyle === 'default' ? 'border-blue-500 ring-2 ring-blue-200 bg-blue-50' : 'border-gray-200 bg-white hover:bg-gray-50'}`}><div className="bg-white border border-gray-200 rounded-lg p-3 mb-2 shadow-sm"><div className="flex items-center gap-2 mb-2"><div className="w-3 h-3 rounded-full border-2 border-gray-300"></div><div className="w-16 h-2 bg-gray-200 rounded"></div></div><div className="w-24 h-2 bg-gray-100 rounded ml-5"></div></div><div className={`text-sm font-bold text-center ${globalTheme.cardStyle === 'default' ? 'text-blue-700' : 'text-gray-600'}`}>ç®€çº¦ç™½</div></button><button onClick={() => setGlobalTheme(prev => ({ ...prev, cardStyle: 'colored' }))} className={`flex-1 p-3 rounded-xl border-2 transition-all ${globalTheme.cardStyle === 'colored' ? 'border-blue-500 ring-2 ring-blue-200 bg-blue-50' : 'border-gray-200 bg-white hover:bg-gray-50'}`}><div className="bg-orange-50 border border-orange-100 rounded-lg p-3 mb-2 shadow-sm"><div className="flex items-center gap-2 mb-2"><div className="w-3 h-3 rounded-full border-2 border-orange-300"></div><div className="w-16 h-2 bg-orange-300 rounded"></div></div><div className="w-24 h-2 bg-orange-200 rounded ml-5"></div></div><div className={`text-sm font-bold text-center ${globalTheme.cardStyle === 'colored' ? 'text-blue-700' : 'text-gray-600'}`}>è·Ÿéšè‰²ç³»</div></button></div></div></div>)}</div>
                    </Modal>

                    <Modal isOpen={isReviewCenterOpen} onClose={() => setIsReviewCenterOpen(false)} title="å¤ç›˜ä¸ç›®æ ‡ä¸­å¿ƒ" fullScreen>
                        <div className="flex flex-col h-full bg-[#f8fafc]"><div className="flex px-4 pt-4 border-b border-gray-100 bg-white flex-shrink-0 gap-4 overflow-x-auto scrollbar-hide">{['daily', 'weekly', 'monthly', 'yearly'].map(t => (<button key={t} onClick={() => setReviewTab(t)} className={`pb-3 px-1 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${reviewTab === t ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400 hover:text-gray-600'}`}>{t === 'daily' ? 'æ¯æ—¥å¤ç›˜' : t === 'weekly' ? 'å‘¨å¤ç›˜' : t === 'monthly' ? 'æœˆåº¦æ€»ç»“' : 'å¹´åº¦å›é¡¾'}</button>))}</div><div className="bg-white px-4 py-2 border-b border-gray-100 flex items-center justify-between flex-shrink-0 shadow-sm z-10"><button onClick={() => handleReviewDateChange(-1)} className="p-1 hover:bg-gray-100 rounded"><ChevronLeft className="w-5 h-5 text-gray-400"/></button><span className="text-sm font-bold text-slate-700">{getPeriodLabel(reviewTab, reviewDate)}</span><button onClick={() => handleReviewDateChange(1)} className="p-1 hover:bg-gray-100 rounded"><ChevronRight className="w-5 h-5 text-gray-400"/></button></div><div className="flex-1 overflow-y-auto custom-scrollbar">{reviewTab === 'daily' ? (<DailyReviewContent reviewDate={reviewDate} reviews={reviews} setReviews={setReviews} />) : (<PeriodReviewContent period={reviewTab} reviewDate={reviewDate} reviews={reviews} setReviews={setReviews} tasksByDate={tasksByDate} sections={sections} />)}</div></div>
                    </Modal>

                    <Modal isOpen={isStatsModalOpen} onClose={() => setIsStatsModalOpen(false)} title={`${statsPeriod === 'daily' ? 'ä»Šæ—¥' : statsPeriod === 'weekly' ? 'æœ¬å‘¨' : statsPeriod === 'monthly' ? 'æœ¬æœˆ' : 'å¹´åº¦'}ä¸“æ³¨ç»Ÿè®¡`}>
                        <div className="p-4 bg-white min-h-[400px]">{statsData.data.length > 0 ? (<div className="flex flex-col items-center"><AdvancedPieChart data={statsData.data} totalMins={statsData.totalMins} /><div className="mt-8 text-center w-full pt-4 border-t border-gray-100"><p className="text-gray-800 font-bold text-lg mb-1">æ€»è®¡ {Math.floor(statsData.totalMins / 60)} å°æ—¶ {statsData.totalMins % 60} åˆ†é’Ÿ{statsPeriod !== 'daily' && ` æ—¥å‡ ${statsData.avgMins} åˆ†é’Ÿ`}</p><p className="text-gray-400 text-xs mt-2">åŸºäº {statsData.activeDays} å¤©çš„æ‰“å¡æ•°æ®è®¡ç®—</p></div></div>) : (<div className="flex flex-col items-center justify-center h-64 text-center"><div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4"><PieChart className="w-8 h-8 text-gray-300" /></div><p className="text-gray-500 font-medium">å½“å‰æ—¶é—´æ®µè¿˜æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡å“¦~</p><p className="text-xs text-gray-400 mt-2">å¿«å»å‹¾é€‰å®Œæˆä»»åŠ¡æ¥ç”Ÿæˆæ—¶é—´ç»Ÿè®¡å›¾å§ï¼</p></div>)}</div>
                    </Modal>

                    <Modal isOpen={isTimerOpen} onClose={() => setIsTimerOpen(false)} title="ä¸“æ³¨ç•ªèŒ„é’Ÿ">
                        <div className="flex flex-col items-center justify-center p-4"><div className="relative w-48 h-48 mb-6"><svg className="w-full h-full transform -rotate-90"><circle cx="96" cy="96" r="88" stroke="#f1f5f9" strokeWidth="12" fill="transparent" /><circle cx="96" cy="96" r="88" stroke="#f87171" strokeWidth="12" fill="transparent" strokeDasharray={2 * Math.PI * 88} strokeDashoffset={(2 * Math.PI * 88) * (1 - timerTime / (initialTime * 60))} strokeLinecap="round" className="transition-all duration-1000 ease-linear" /></svg><div className="absolute inset-0 flex items-center justify-center text-4xl font-bold text-slate-700">{formatTime(timerTime)}</div></div><div className="flex gap-4 items-center mb-6"><button onClick={toggleTimer} className={`p-4 rounded-full text-white shadow-lg transition-transform active:scale-95 ${timerActive ? 'bg-orange-400' : 'bg-green-500'}`}>{timerActive ? <Pause className="w-8 h-8 fill-current" /> : <Play className="w-8 h-8 fill-current ml-1" />}</button><button onClick={resetTimer} className="p-4 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors" title="é‡ç½®"><RotateCcw className="w-6 h-6" /></button></div><div className="w-full bg-gray-50 p-4 rounded-xl border border-gray-100"><label className="block text-xs font-bold text-gray-500 mb-2 flex items-center gap-1"><Timer className="w-3 h-3" /> è®¾ç½®æ—¶é•¿ (åˆ†é’Ÿ)</label><div className="flex gap-2">{[25, 30, 45, 60].map(mins => (<button key={mins} onClick={() => { setInitialTime(mins); setTimerTime(mins * 60); setTimerActive(false); }} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-colors ${initialTime === mins ? 'bg-white text-blue-600 shadow-sm border border-blue-100' : 'text-gray-400 hover:text-gray-600'}`}>{mins}</button>))}</div><input type="range" min="1" max="120" value={initialTime} onChange={handleTimeChange} className="w-full mt-4 accent-red-400" /></div></div>
                    </Modal>

                    <Modal isOpen={showCelebration} onClose={() => setShowCelebration(false)} title="ğŸ‰ æ¯æ—¥ç›®æ ‡è¾¾æˆï¼">
                        <div className="p-6 flex flex-col items-center justify-center text-center"><WateringAnimation /><h3 className="text-xl font-bold text-slate-800 mt-6 mb-3">ä½ çœŸæ£’ï¼</h3><p className="text-slate-600 text-sm leading-relaxed max-w-xs mx-auto italic">"{celebrationQuote}"</p><button onClick={() => setShowCelebration(false)} className="mt-8 px-6 py-2 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-full font-bold shadow-lg shadow-pink-200 hover:scale-105 transition-transform">ç»§ç»­ä¿æŒ ğŸ’ª</button></div>
                    </Modal>

                    {/* New Modals for Cloud Sync */}
                    <ConfigModal isOpen={isConfigModalOpen} onClose={() => setIsConfigModalOpen(false)} onSave={handleSaveConfig} />
                    <AuthModal isOpen={isAuthModalOpen} onClose={() => setIsAuthModalOpen(false)} auth={firebaseAuth} />

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
