<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS - 混合云同步版</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: 加载 React 和 Firebase -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <style>
        /* 全局样式修正 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* 动画关键帧 */
        @keyframes grow { from { stroke-dasharray: 0 100; } to { stroke-dasharray: 100 0; } }
        @keyframes drop { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(60px); opacity: 0; } }
        /* 移动端优化 */
        input, textarea { font-size: 16px !important; } /* 防止iOS缩放 */
    </style>
</head>
<body class="bg-[#F5F7FA]">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "firebase/firestore";
        import { 
            ChevronLeft, ChevronRight, Bell, PenLine, LayoutGrid, CheckCircle2, Circle,
            Plus, RefreshCcw, Zap, Coffee, Moon, X, Trash2, Save, Sun, Briefcase,
            BookOpen, Dumbbell, Music, Settings2, Edit3, Clock, Repeat, RotateCcw,
            StickyNote, Play, Pause, Timer, PieChart, BarChart3, Calendar as CalendarIcon,
            Target, Heart, TrendingUp, ListTodo, Sparkles, Check, Download, Palette,
            Layout, PanelTop, Shuffle, Cloud, Loader2, LogIn, LogOut, User, Lock, Mail, AlertCircle, HardDrive, Upload
        } from 'lucide-react';

        // --- 2. Utilities ---
        const generateDateString = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getDayName = (dayIndex) => ['日', '一', '二', '三', '四', '五', '六'][dayIndex];

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };

        const getWeekRange = (date) => {
            const day = date.getDay(); 
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const start = new Date(date);
            start.setDate(diff);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            return { start, end };
        };

        const getReviewId = (period, date) => {
            if (period === 'daily') return generateDateString(date);
            if (period === 'weekly') {
                const { start } = getWeekRange(date);
                return `W_${start.getFullYear()}_${getWeekNumber(start)}`;
            }
            if (period === 'monthly') return `M_${date.getFullYear()}_${date.getMonth() + 1}`;
            if (period === 'yearly') return `Y_${date.getFullYear()}`;
            return '';
        };

        const getPeriodLabel = (period, date) => {
            if (period === 'daily') return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
            if (period === 'weekly') {
                const { start, end } = getWeekRange(date);
                return `${start.getFullYear()}年 第${getWeekNumber(start)}周 (${start.getMonth()+1}.${start.getDate()}-${end.getMonth()+1}.${end.getDate()})`;
            }
            if (period === 'monthly') return `${date.getFullYear()}年 ${date.getMonth()+1}月`;
            if (period === 'yearly') return `${date.getFullYear()}年`;
            return '';
        };

        const generateCalendarDates = (baseDate = new Date()) => {
            const { start } = getWeekRange(baseDate);
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                dates.push({
                    fullDate: generateDateString(d),
                    dayName: getDayName(d.getDay()),
                    dateNum: d.getDate(),
                    obj: d
                });
            }
            return dates;
        };

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };

        const parseDurationFromTimeStr = (timeStr) => {
            if (!timeStr || typeof timeStr !== 'string') return 30; 
            const matches = timeStr.match(/(\d{1,2})[:：](\d{2})/g);
            if (matches && matches.length >= 2) {
                const [h1, m1] = matches[0].split(/[:：]/).map(Number);
                const [h2, m2] = matches[1].split(/[:：]/).map(Number);
                let startMins = h1 * 60 + m1;
                let endMins = h2 * 60 + m2;
                if (endMins < startMins) endMins += 24 * 60; 
                return Math.max(15, endMins - startMins); 
            }
            return 30; 
        };

        const downloadICS = (tasks, dateStr, title) => {
            if (!tasks || tasks.length === 0) {
                alert("没有可导出的任务");
                return;
            }
            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//LifeOS//Task Manager//CN\n";
            tasks.forEach(task => {
                if (!task.time) return; 
                const matches = task.time.match(/(\d{1,2})[:：](\d{2})/g);
                if (!matches || matches.length < 2) return;
                const [sH, sM] = matches[0].split(/[:：]/).map(s => s.padStart(2, '0'));
                const [eH, eM] = matches[1].split(/[:：]/).map(s => s.padStart(2, '0'));
                const dateClean = dateStr.replace(/-/g, '');
                icsContent += "BEGIN:VEVENT\n";
                icsContent += `SUMMARY:${task.title}\n`;
                icsContent += `DTSTART:${dateClean}T${sH}${sM}00\n`;
                icsContent += `DTEND:${dateClean}T${eH}${eM}00\n`;
                icsContent += `DESCRIPTION:${task.note || ''}\n`;
                icsContent += "END:VEVENT\n";
            });
            icsContent += "END:VCALENDAR";
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', `${title}_${dateStr}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- 3. Constants & Data ---
        const DEFAULT_QUOTE = "星光不问赶路人，时光不负有心人。";
        const GROWTH_QUOTES = [
            "每一次相遇，都可以用5天时间慢慢认识对方。", 
            "星光不问赶路人，时光不负有心人。",
            "不是‘我不行’，而是‘我暂时还不行’。",
            "拥抱挑战，那是成长的信号。",
            "天赋决定下限，努力决定上限。",
            "允许自己休息，但别忘了重新出发。",
            "今天比昨天进步一点点，就是胜利。",
            "把困难当作打怪升级，经验值正在疯涨。",
            "专注当下，未来自会呈现。"
        ];

        const INITIAL_SECTIONS = [{ id: 'morning', title: 'Morning', icon: 'Sun', color: 'butter' }, { id: 'afternoon', title: 'Afternoon', icon: 'Coffee', color: 'latte' }, { id: 'evening', title: 'Evening', icon: 'Moon', color: 'morandi' }];
        const TODAY_STR = generateDateString(new Date());
        const INITIAL_TASKS_BY_DATE = {
            [TODAY_STR]: {
                morning: [{ id: 1, time: '08:00-08:30', title: '晨间习惯 (喝水/拉伸)', completed: false, important: true, urgent: true, tag: '生活', note: '' }],
                afternoon: [{ id: 3, time: '14:00-16:00', title: '核心任务处理', completed: false, important: true, urgent: false, tag: '工作', note: '' }],
                evening: [{ id: 5, time: '20:00-21:00', title: '复盘与明日计划', completed: false, important: true, urgent: true, tag: '生活', note: '' }],
                fragmentary: []
            }
        };
        const ICON_MAP = { Sun, Coffee, Moon, Zap, Briefcase, BookOpen, Dumbbell, Music };
        const PALETTE = {
            white: { label: '纯净白', bg: 'bg-white', text: 'text-slate-800' },
            gray: { label: '极简灰', bg: 'bg-slate-50', text: 'text-slate-800' },
            rose: { label: '玫瑰', bg: 'bg-rose-50', text: 'text-rose-900' },
            butter: { label: '黄油', bg: 'bg-amber-50', text: 'text-amber-900' },
            latte: { label: '拿铁', bg: 'bg-stone-50', text: 'text-stone-800' },
            elf: { label: '精灵', bg: 'bg-lime-50', text: 'text-lime-900' },
            ocean: { label: '海盐', bg: 'bg-sky-50', text: 'text-sky-900' },
            taro: { label: '香芋', bg: 'bg-purple-50', text: 'text-purple-900' },
            morandi: { label: '莫兰迪', bg: 'bg-slate-100', text: 'text-slate-800' },
            wheat: { label: '小麦', bg: 'bg-yellow-50', text: 'text-yellow-900' },
            mint: { label: '薄荷', bg: 'bg-green-50', text: 'text-green-900' },
        };
        const COLOR_THEMES = {
            orange: { label: '活力橙', bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-200', icon: 'text-orange-500', preview: 'bg-orange-400', cardBg: 'bg-orange-50' },
            yellow: { label: '明亮黄', bg: 'bg-yellow-50', text: 'text-yellow-600', border: 'border-yellow-200', icon: 'text-yellow-500', preview: 'bg-yellow-400', cardBg: 'bg-yellow-50' },
            indigo: { label: '深邃靛', bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-200', icon: 'text-indigo-500', preview: 'bg-indigo-400', cardBg: 'bg-indigo-50' },
            blue: { label: '天空蓝', bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-200', icon: 'text-blue-500', preview: 'bg-blue-400', cardBg: 'bg-blue-50' },
            green: { label: '自然绿', bg: 'bg-green-50', text: 'text-green-600', border: 'border-green-200', icon: 'text-green-500', preview: 'bg-green-400', cardBg: 'bg-green-50' },
            purple: { label: '神秘紫', bg: 'bg-purple-50', text: 'text-purple-600', border: 'border-purple-200', icon: 'text-purple-500', preview: 'bg-purple-400', cardBg: 'bg-purple-50' },
            red: { label: '热情红', bg: 'bg-red-50', text: 'text-red-600', border: 'border-red-200', icon: 'text-red-500', preview: 'bg-red-400', cardBg: 'bg-red-50' },
            rose: { label: '玫瑰', bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-200', icon: 'text-rose-500', preview: 'bg-rose-400', cardBg: 'bg-rose-50' },
            butter: { label: '黄油', bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-200', icon: 'text-amber-500', preview: 'bg-amber-400', cardBg: 'bg-amber-50' },
            latte: { label: '拿铁', bg: 'bg-stone-50', text: 'text-stone-600', border: 'border-stone-200', icon: 'text-stone-500', preview: 'bg-stone-400', cardBg: 'bg-stone-50' },
            elf: { label: '精灵', bg: 'bg-lime-50', text: 'text-lime-600', border: 'border-lime-200', icon: 'text-lime-500', preview: 'bg-lime-400', cardBg: 'bg-lime-50' },
            ocean: { label: '海盐', bg: 'bg-sky-50', text: 'text-sky-600', border: 'border-sky-200', icon: 'text-sky-500', preview: 'bg-sky-400', cardBg: 'bg-sky-50' },
            taro: { label: '香芋', bg: 'bg-fuchsia-50', text: 'text-fuchsia-600', border: 'border-fuchsia-200', icon: 'text-fuchsia-500', preview: 'bg-fuchsia-400', cardBg: 'bg-fuchsia-50' },
            morandi: { label: '莫兰迪', bg: 'bg-slate-100', text: 'text-slate-600', border: 'border-slate-300', icon: 'text-slate-500', preview: 'bg-slate-400', cardBg: 'bg-slate-100' },
        };

        // --- 4. Sub-Components ---
        const Modal = ({ isOpen, onClose, title, children, fullScreen = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] flex items-center justify-center p-4" onClick={(e) => e.stopPropagation()}>
                    <div className={`bg-white rounded-2xl shadow-xl w-full ${fullScreen ? 'max-w-2xl h-[85vh]' : 'max-w-md max-h-[85vh]'} overflow-hidden animate-in fade-in zoom-in duration-200 flex flex-col`}>
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 flex-shrink-0">
                            <h3 className="font-bold text-gray-800 flex items-center gap-2">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full transition"><X className="w-5 h-5 text-gray-500" /></button>
                        </div>
                        <div className={`p-0 overflow-y-auto custom-scrollbar flex-1 bg-[#F9FAFB]`}>{children}</div>
                    </div>
                </div>
            );
        };

        const TimeRangePicker = ({ value, onChange }) => {
            const parseInitial = useMemo(() => {
                const matches = (value || '').match(/(\d{1,2})[:：](\d{2})/g);
                let sH = '09', sM = '00', eH = '10', eM = '00';
                if (matches && matches.length > 0) {
                    [sH, sM] = matches[0].split(/[:：]/).map(s => s.padStart(2,'0'));
                    if (matches.length > 1) { [eH, eM] = matches[1].split(/[:：]/).map(s => s.padStart(2,'0')); } 
                    else { let h = parseInt(sH), m = parseInt(sM) + 30; if (m >= 60) { h = (h + 1) % 24; m -= 60; } eH = String(h).padStart(2,'0'); eM = String(m).padStart(2,'0'); }
                }
                return { start: `${sH}:${sM}`, end: `${eH}:${eM}` };
            }, [value]); 
            const [times, setTimes] = useState(parseInitial);
            useEffect(() => { const newVal = `${times.start}-${times.end}`; if (newVal !== value) onChange(newVal); }, [times]);
            return (<div className="flex items-center gap-2"><div className="flex-1 bg-white border border-gray-200 rounded-xl px-2 py-2 shadow-sm focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all"><input type="time" value={times.start} onChange={(e) => setTimes(p => ({ ...p, start: e.target.value || p.start }))} className="w-full bg-transparent text-center font-bold text-gray-700 outline-none text-sm" required /></div><span className="text-gray-400 font-bold">-</span><div className="flex-1 bg-white border border-gray-200 rounded-xl px-2 py-2 shadow-sm focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all"><input type="time" value={times.end} onChange={(e) => setTimes(p => ({ ...p, end: e.target.value || p.end }))} className="w-full bg-transparent text-center font-bold text-gray-700 outline-none text-sm" required /></div></div>);
        };

        const WateringAnimation = () => (<div className="relative w-full h-64 flex items-center justify-center bg-white/50 rounded-xl"><svg viewBox="0 0 300 200" className="w-full h-full max-w-sm"><path d="M40 160 L260 160" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><g transform="translate(180, 115)"><path d="M10 45 L15 15 L45 15 L50 45 Q30 50 10 45 Z" fill="none" stroke="#334155" strokeWidth="2" strokeLinejoin="round" /><path d="M15 15 Q30 10 45 15" fill="none" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><g className="origin-bottom animate-[grow_2s_ease-out_forwards]" style={{transformBox: 'fill-box', transformOrigin: 'bottom center'}}><path d="M30 15 Q30 5 30 -5" stroke="#a3e635" strokeWidth="3" strokeLinecap="round" /><path d="M30 -5 Q20 -15 15 -5 Q25 5 30 -5" fill="#a3e635" /><path d="M30 -5 Q40 -15 45 -5 Q35 5 30 -5" fill="#a3e635" /></g></g><g transform="translate(60, 50) rotate(-10)"><path d="M20 40 C-10 30 -10 90 20 80" fill="none" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M80 50 L130 40 L135 60 L80 80" fill="#fca5a5" stroke="none" /><path d="M80 50 L130 40" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M80 80 L135 60" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><path d="M20 30 L80 30 L85 100 L15 100 Q10 65 20 30 Z" fill="#fca5a5" stroke="#334155" strokeWidth="2" strokeLinejoin="round" /><path d="M30 40 Q40 30 50 50 T70 60 T40 80" fill="none" stroke="#f472b6" strokeWidth="2" opacity="0.6" /><path d="M35 60 Q50 70 65 50" fill="none" stroke="#f472b6" strokeWidth="2" opacity="0.6" /><g transform="translate(135, 50)"><line x1="5" y1="0" x2="20" y2="-5" stroke="#334155" strokeWidth="2" strokeLinecap="round" /><line x1="5" y1="10" x2="20" y2="15" stroke="#334155" strokeWidth="2" strokeLinecap="round" /></g></g><g><circle cx="200" cy="90" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite]" /><circle cx="210" cy="100" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite_0.3s]" /><circle cx="190" cy="105" r="2" fill="#60a5fa" className="animate-[drop_0.8s_linear_infinite_0.6s]" /></g></svg></div>);
        const CircularProgress = ({ percentage, label, subLabel, colorClass, trackClass, onClick }) => {const radius = 18; const circumference = 2 * Math.PI * radius; const strokeDashoffset = circumference - (percentage / 100) * circumference; return (<div className="flex flex-col items-center justify-center group cursor-pointer relative z-10" onClick={onClick} style={{ pointerEvents: 'auto' }}><div className="relative w-12 h-12 flex items-center justify-center transition-transform group-hover:scale-105"><svg className="w-full h-full transform -rotate-90"><circle cx="24" cy="24" r={radius} stroke="currentColor" strokeWidth="4" fill="transparent" className={trackClass} /><circle cx="24" cy="24" r={radius} stroke="currentColor" strokeWidth="4" fill="transparent" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round" className={colorClass} /></svg><span className="absolute text-[10px] font-bold text-gray-600">{percentage}%</span></div><div className="mt-1 text-center"><div className="text-[10px] text-gray-400 group-hover:text-blue-500 transition-colors">{label}</div><div className="text-xs font-bold text-gray-800">{subLabel}</div></div></div>);};
        const AdvancedPieChart = ({ data, totalMins }) => {if (!data || data.length === 0) return null; let cumulativePercent = 0; const getCoordinates = (percent, radius = 1) => { const rad = 2 * Math.PI * (percent - 0.25); const x = Math.cos(rad) * radius; const y = Math.sin(rad) * radius; return [x, y]; }; const formatDuration = (mins) => { const h = Math.floor(mins / 60); const m = mins % 60; if (h > 0 && m > 0) return `${h}小时${m}分`; if (h > 0) return `${h}小时`; return `${m}分`; }; return (<div className="relative w-full aspect-square max-w-sm mx-auto my-4"><svg viewBox="-2 -2 4 4" className="w-full h-full overflow-visible">{data.map((item, index) => { const percent = item.value / totalMins; const [startX, startY] = getCoordinates(cumulativePercent); const midPercent = cumulativePercent + percent / 2; cumulativePercent += percent; const [endX, endY] = getCoordinates(cumulativePercent); const largeArcFlag = percent > 0.5 ? 1 : 0; const pathData = `M 0 0 L ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} Z`; const [midX, midY] = getCoordinates(midPercent); const isRight = midX > 0; const elbowX = midX * 1.15; const elbowY = midY * 1.15; const textStartX = isRight ? elbowX + 0.2 : elbowX - 0.2; return (<g key={index}><path d={pathData} fill={item.color} stroke="white" strokeWidth="0.02" className="hover:opacity-90 transition-opacity cursor-pointer" />{percent > 0.03 && (<React.Fragment><polyline points={`${midX},${midY} ${elbowX},${elbowY} ${textStartX},${elbowY}`} fill="none" stroke="#9ca3af" strokeWidth="0.015" /><text x={isRight ? textStartX + 0.05 : textStartX - 0.05} y={elbowY - 0.06} fill="#4b5563" fontSize="0.16" textAnchor={isRight ? 'start' : 'end'} alignmentBaseline="baseline" className="font-bold">{item.tag}</text><text x={isRight ? textStartX + 0.05 : textStartX - 0.05} y={elbowY + 0.14} fill="#6b7280" fontSize="0.12" textAnchor={isRight ? 'start' : 'end'} alignmentBaseline="baseline">{formatDuration(item.value)}</text></React.Fragment>)}</g>);})}</svg></div>);};
        
        // 优化后的统计卡片：紧凑型，适合一行排列
        const StatCard = ({ number, title, subText, colorTheme }) => {
            const themes = {
                red: { bg: 'bg-red-50', text: 'text-red-600', sub: 'bg-red-100 text-red-700', border: 'border-red-100' },
                orange: { bg: 'bg-orange-50', text: 'text-orange-600', sub: 'bg-orange-100 text-orange-700', border: 'border-orange-100' },
                blue: { bg: 'bg-blue-50', text: 'text-blue-600', sub: 'bg-blue-100 text-blue-700', border: 'border-blue-100' },
                green: { bg: 'bg-emerald-50', text: 'text-emerald-600', sub: 'bg-emerald-100 text-emerald-700', border: 'border-emerald-100' },
            };
            const theme = themes[colorTheme] || themes.blue;
            
            return (
                <div className={`${theme.bg} rounded-xl p-2 flex flex-col items-center justify-center border ${theme.border} shadow-sm h-full`}>
                    <span className="text-[10px] font-bold text-gray-500 mb-0.5 whitespace-nowrap scale-90 origin-bottom">{title}</span>
                    <span className={`text-xl font-black ${theme.text} leading-none mb-1`}>{number}</span>
                    <div className={`px-1.5 py-0.5 rounded-md text-[9px] font-bold ${theme.sub} scale-90`}>{subText}</div>
                </div>
            );
        };

        const TaskCard = ({ task, onToggle, onEdit, onDelete, onNote, onRemind, cardStyle, sectionColor }) => {
            const getMatrixTag = () => {
                if (task.important && task.urgent) return { text: '重要紧急', color: 'indigo' };
                if (task.important && !task.urgent) return { text: '重要不急', color: 'blue' };
                if (!task.important && task.urgent) return { text: '紧急不重', color: 'red' };
                return { text: '不急不重', color: 'green' };
            };
            const matrixTag = getMatrixTag();
            const tagColors = { indigo: 'bg-indigo-100 text-indigo-700', blue: 'bg-blue-100 text-blue-700', red: 'bg-red-100 text-red-700', green: 'bg-emerald-100 text-emerald-700', gray: 'bg-gray-100 text-gray-600' };
            const userTag = typeof task.tag === 'string' ? task.tag : '';
            const theme = sectionColor && COLOR_THEMES[sectionColor] ? COLOR_THEMES[sectionColor] : COLOR_THEMES.butter; 
            const bgClass = task.completed ? 'bg-white border-gray-100' : cardStyle === 'colored' && theme ? `${theme.cardBg} border-transparent` : 'bg-white border-gray-100 hover:shadow-md'; 
            
            return (
                <div className={`p-4 rounded-xl shadow-sm border transition-all duration-300 group mb-3 relative cursor-pointer flex items-center justify-between gap-4 ${bgClass}`} onClick={() => onToggle(task.id)}>
                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-20 bg-white/90 backdrop-blur-sm p-1 rounded-lg shadow-sm border border-gray-100">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(task); }} className="p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-md transition" title="编辑任务"><Edit3 className="w-3.5 h-3.5" /></button>
                        <div className="w-px bg-gray-200 my-1"></div>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(task.id); }} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-md transition" title="删除任务"><Trash2 className="w-3.5 h-3.5" /></button>
                    </div>
                    <div className={`flex-1 transition-opacity duration-300 ${task.completed ? 'opacity-40' : 'opacity-100'}`}>
                        <div className="flex items-center gap-3 mb-2">
                            {/* 时间字体放大，颜色加深，增加对比度 */}
                            {task.time && (<div className={`text-sm px-2 py-0.5 rounded font-mono font-black flex items-center gap-1.5 transition-colors ${task.completed ? 'bg-gray-100 text-gray-400' : 'bg-gray-100 text-slate-700 group-hover:bg-blue-50 group-hover:text-blue-700'}`}><Clock className="w-3.5 h-3.5" />{task.time}</div>)}
                            {!task.time && <div className="text-xs text-gray-400 italic">设置时间...</div>}
                        </div>
                        <div className="flex flex-wrap gap-1.5 mb-2">
                            {userTag && <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${task.completed ? 'bg-gray-100 text-gray-400' : 'bg-gray-100 text-gray-600'}`}>{String(userTag)}</span>}
                            <span className={`text-[10px] px-1.5 py-0.5 rounded font-medium ${task.completed ? 'bg-gray-100 text-gray-400' : tagColors[matrixTag.color]}`}>{matrixTag.text}</span>
                        </div>
                        <h3 className={`font-bold text-base transition-colors duration-300 ${task.completed ? 'line-through text-gray-300 decoration-gray-300' : 'text-gray-800'}`}>
                            {String(task.title)}
                            {task.recurring && <RotateCcw className="inline-block w-3 h-3 ml-2 text-blue-400" />}
                        </h3>
                        {task.note && (<div className={`mt-2 px-2 py-1.5 rounded-lg text-xs flex gap-2 items-start border transition-colors ${task.completed ? 'bg-gray-50 border-gray-100 text-gray-300' : 'bg-yellow-50 border-yellow-100/50 text-gray-600'}`}><StickyNote className={`w-3 h-3 mt-0.5 flex-shrink-0 ${task.completed ? 'text-gray-300' : 'text-yellow-400'}`} /><span className="line-clamp-1">{String(task.note)}</span></div>)}
                        <div className={`mt-3 flex items-center gap-2 text-xs font-medium ${task.completed ? 'hidden' : 'text-gray-500'}`}>
                            <button className="flex items-center gap-1 px-2 py-1 rounded hover:bg-pink-50 hover:text-pink-600 bg-pink-50/30 transition-all" onClick={(e) => { e.stopPropagation(); onNote(task); }}><PenLine className="w-3.5 h-3.5" /><span>备注</span></button>
                            <button className="flex items-center gap-1 px-2 py-1 rounded hover:bg-yellow-50 hover:text-yellow-600 bg-yellow-50/30 transition-all" onClick={(e) => { e.stopPropagation(); onRemind(task); }}><Bell className="w-3.5 h-3.5" /><span>提醒</span></button>
                        </div>
                    </div>
                    <div className="flex-shrink-0 ml-2">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 ${task.completed ? 'bg-green-400 shadow-sm scale-110' : 'border-2 border-gray-200 hover:border-indigo-300 bg-white'}`}>
                            {task.completed && <Check className="w-5 h-5 text-white stroke-[3]" />}
                        </div>
                    </div>
                </div>
            );
        };

        const DailyReviewContent = ({ reviewDate, reviews, setReviews }) => {
            const reviewId = getReviewId('daily', reviewDate);
            const data = reviews[reviewId] || { gratitude: '', facts: '', insight: '', adjustment: '' };
            const [gratitudeSaved, setGratitudeSaved] = useState(false);
            const [threeLineSaved, setThreeLineSaved] = useState(false);
            
            const gratitudeRef = useRef(null);
            const factsRef = useRef(null);
            const insightRef = useRef(null);
            const adjustmentRef = useRef(null);

            // 自动调整高度 (通用函数)
            const adjustHeight = (ref) => {
                if (ref.current) {
                    ref.current.style.height = 'auto';
                    ref.current.style.height = ref.current.scrollHeight + 'px';
                }
            };

            // 监听感恩笔记变化
            useEffect(() => { adjustHeight(gratitudeRef); }, [data.gratitude]);
            
            // 监听3行复盘变化
            useEffect(() => { 
                adjustHeight(factsRef);
                adjustHeight(insightRef);
                adjustHeight(adjustmentRef);
            }, [data.facts, data.insight, data.adjustment]);

            const updateReview = (field, value) => {
                setReviews(prev => ({ ...prev, [reviewId]: { ...(prev[reviewId] || {}), [field]: value } }));
                if (field === 'gratitude') setGratitudeSaved(false);
                else setThreeLineSaved(false);
            };

            const handleSaveGratitude = () => {
                setGratitudeSaved(true);
                setTimeout(() => setGratitudeSaved(false), 2000);
            };

            const handleSaveThreeLine = () => {
                setThreeLineSaved(true);
                setTimeout(() => setThreeLineSaved(false), 2000);
            };

            return (
                <div className="space-y-6 p-4">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-pink-50">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2"><Heart className="w-5 h-5 text-pink-400 fill-pink-400" /><h4 className="font-bold text-gray-800">感恩笔记</h4></div>
                            <button onClick={handleSaveGratitude} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${gratitudeSaved ? 'bg-green-100 text-green-600' : 'bg-pink-50 text-pink-600 hover:bg-pink-100'}`}>
                                {gratitudeSaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> 已保存</span> : '保存'}
                            </button>
                        </div>
                        <textarea 
                            ref={gratitudeRef}
                            className="w-full min-h-[96px] bg-pink-50/30 rounded-lg p-3 text-sm focus:outline-none focus:ring-1 focus:ring-pink-200 resize-none placeholder:text-gray-300 overflow-hidden transition-all" 
                            placeholder="记录今天值得感激的小确幸..." 
                            value={String(data.gratitude || '')} 
                            onChange={(e) => updateReview('gratitude', e.target.value)} 
                        />
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-blue-50">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2"><Sparkles className="w-5 h-5 text-orange-400 fill-orange-400" /><h4 className="font-bold text-gray-800">3行极简复盘</h4></div>
                            <button onClick={handleSaveThreeLine} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${threeLineSaved ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>
                                {threeLineSaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> 已保存</span> : '保存'}
                            </button>
                        </div>
                        <div className="space-y-3">
                            <div>
                                <label className="text-xs font-bold text-blue-500 mb-1 block flex items-center gap-1"><LayoutGrid className="w-3 h-3"/> 事实</label>
                                <textarea 
                                    ref={factsRef}
                                    rows={1}
                                    className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-blue-200 transition-all resize-none overflow-hidden" 
                                    placeholder="完成..." 
                                    value={String(data.facts || '')} 
                                    onChange={(e) => updateReview('facts', e.target.value)} 
                                />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-pink-500 mb-1 block flex items-center gap-1"><Zap className="w-3 h-3"/> 洞察</label>
                                <textarea 
                                    ref={insightRef}
                                    rows={1}
                                    className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-pink-200 transition-all resize-none overflow-hidden" 
                                    placeholder="心得..." 
                                    value={String(data.insight || '')} 
                                    onChange={(e) => updateReview('insight', e.target.value)} 
                                />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-green-500 mb-1 block flex items-center gap-1"><CheckCircle2 className="w-3 h-3"/> 调整</label>
                                <textarea 
                                    ref={adjustmentRef}
                                    rows={1}
                                    className="w-full bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none border-0 focus:ring-1 focus:ring-green-200 transition-all resize-none overflow-hidden" 
                                    placeholder="下一步..." 
                                    value={String(data.adjustment || '')} 
                                    onChange={(e) => updateReview('adjustment', e.target.value)} 
                                />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PeriodReviewContent = ({ period, reviewDate, reviews, setReviews, tasksByDate, sections }) => {
            const reviewId = getReviewId(period, reviewDate);
            const data = reviews[reviewId] || {};
            const goals = Array.isArray(data.goals) ? data.goals : [];
            const [summarySaved, setSummarySaved] = useState(false);
            const summaryRef = useRef(null);

            // 自动调整高度
            useEffect(() => {
                if (summaryRef.current) {
                    summaryRef.current.style.height = 'auto';
                    summaryRef.current.style.height = summaryRef.current.scrollHeight + 'px';
                }
            }, [data.summary]);
            
            // 自动计算该周期的所有数据统计
            const statsData = useMemo(() => {
                let targetDates = [];
                const y = reviewDate.getFullYear();
                const m = reviewDate.getMonth();

                if (period === 'weekly') {
                    const { start } = getWeekRange(reviewDate);
                    for(let i=0; i<7; i++) {
                        const temp = new Date(start);
                        temp.setDate(start.getDate() + i);
                        targetDates.push(generateDateString(temp));
                    }
                } else if (period === 'monthly') {
                    Object.keys(tasksByDate).forEach(dateStr => {
                        const [dy, dm] = dateStr.split('-').map(Number);
                        if (dy === y && dm === m + 1) targetDates.push(dateStr);
                    });
                } else if (period === 'yearly') {
                    Object.keys(tasksByDate).forEach(dateStr => {
                        const [dy] = dateStr.split('-').map(Number);
                        if (dy === y) targetDates.push(dateStr);
                    });
                }

                let tagMap = {};
                let totalMins = 0;
                let activeDays = new Set();
                let completedCount = 0;

                targetDates.forEach(dateStr => {
                    const dayTasks = tasksByDate[dateStr];
                    if (!dayTasks) return;
                    
                    let hasCompleted = false;
                    [...sections.map(s => s.id), 'fragmentary'].forEach(sec => {
                        (dayTasks[sec] || []).forEach(task => {
                            if (task.completed) {
                                hasCompleted = true;
                                completedCount++;
                                const tag = task.tag || '未分类';
                                const mins = task.time ? parseDurationFromTimeStr(task.time) : 30; // 默认30分钟
                                tagMap[tag] = (tagMap[tag] || 0) + mins;
                                totalMins += mins;
                            }
                        });
                    });
                    if (hasCompleted) activeDays.add(dateStr);
                });

                const colors = ['#fca5a5', '#93c5fd', '#6ee7b7', '#fcd34d', '#c4b5fd', '#f9a8d4', '#818cf8', '#34d399', '#fbbf24', '#f87171'];
                const chartData = Object.keys(tagMap).map((k, i) => ({
                    tag: k,
                    value: tagMap[k],
                    color: colors[i % colors.length]
                })).sort((a,b) => b.value - a.value);

                return { data: chartData, totalMins, completedCount, activeDays: activeDays.size };
            }, [period, reviewDate, tasksByDate, sections]);

            const [newGoal, setNewGoal] = useState('');
            const updateReview = (field, value) => {
                setReviews(prev => ({ ...prev, [reviewId]: { ...(prev[reviewId] || {}), [field]: value } }));
                if (field === 'summary') setSummarySaved(false);
            };
            const addGoal = () => { if (!newGoal.trim()) return; const newGoalObj = { id: Date.now(), text: newGoal, completed: false }; updateReview('goals', [...goals, newGoalObj]); setNewGoal(''); };
            const toggleGoal = (goalId) => { const newGoals = goals.map(g => g.id === goalId ? { ...g, completed: !g.completed } : g); updateReview('goals', newGoals); };
            const handleSaveSummary = () => {
                setSummarySaved(true);
                setTimeout(() => setSummarySaved(false), 2000);
            };

            return (
                <div className="space-y-4 p-4">
                    {/* 数据回顾统计区 */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex items-center gap-2 mb-2"><PieChart className="w-5 h-5 text-indigo-500" /><h4 className="font-bold text-gray-800 text-sm">时间分配与数据回顾</h4></div>
                        {statsData.data.length > 0 ? (
                            <div className="flex flex-col items-center">
                                <AdvancedPieChart data={statsData.data} totalMins={statsData.totalMins} />
                                <div className="mt-4 text-center w-full pt-4 border-t border-gray-100">
                                    <p className="text-gray-800 font-bold text-sm mb-1">总计 {Math.floor(statsData.totalMins / 60)} 小时 {statsData.totalMins % 60} 分钟</p>
                                    <p className="text-gray-400 text-xs mt-1">打卡完成 {statsData.completedCount} 个任务 · 周期内活跃 {statsData.activeDays} 天</p>
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-6 text-gray-400 text-xs">该周期暂无已完成的任务数据</div>
                        )}
                    </div>

                    {/* 目标区 */}
                     <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex items-center gap-2 mb-3"><Target className="w-5 h-5 text-red-500" /><h4 className="font-bold text-gray-800 text-sm">核心目标</h4></div>
                        <div className="space-y-2 mb-3">
                            {goals.map(goal => (
                                <div key={goal.id} className="flex items-center gap-2 group p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                    <button onClick={() => toggleGoal(goal.id)} className={`flex-shrink-0 transition-colors ${goal.completed ? 'text-green-500' : 'text-gray-300 hover:text-gray-400'}`}>{goal.completed ? <CheckCircle2 className="w-5 h-5" /> : <Circle className="w-5 h-5" />}</button>
                                    <span className={`flex-1 text-sm ${goal.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{String(goal.text)}</span>
                                </div>
                            ))}
                        </div>
                        <div className="flex gap-2 w-full mt-2"><input className="flex-1 bg-white border border-gray-200 rounded px-3 py-1.5 text-sm outline-none" placeholder="添加新目标..." value={newGoal} onChange={(e) => setNewGoal(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addGoal()} /><button onClick={addGoal} className="bg-[#1E293B] text-white px-4 py-1.5 rounded text-xs font-bold">添加</button></div>
                    </div>

                    {/* 周期总结区 */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2"><PenLine className="w-5 h-5 text-emerald-500" /><h4 className="font-bold text-gray-800 text-sm">周期心得总结</h4></div>
                            <button onClick={handleSaveSummary} className={`text-xs px-3 py-1.5 rounded-full transition-all font-bold ${summarySaved ? 'bg-green-100 text-green-600' : 'bg-emerald-50 text-emerald-600 hover:bg-emerald-100'}`}>
                                {summarySaved ? <span className="flex items-center gap-1"><Check className="w-3 h-3"/> 已保存</span> : '保存'}
                            </button>
                        </div>
                        <textarea 
                            ref={summaryRef}
                            className="w-full min-h-[96px] bg-gray-50 rounded-lg p-3 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-200 resize-none placeholder:text-gray-400 overflow-hidden transition-all" 
                            placeholder={`写下这${period === 'weekly' ? '一周' : period === 'monthly' ? '一月' : '一年'}的心得体会或下一步计划...`} 
                            value={String(data.summary || '')} 
                            onChange={(e) => updateReview('summary', e.target.value)} 
                        />
                    </div>
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, onSave }) => {
            if (!isOpen) return null;
            const [configStr, setConfigStr] = useState('');
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="云端同步设置">
                    <div className="p-6">
                        <div className="bg-blue-50 p-4 rounded-xl mb-4 text-sm text-blue-800">
                            <p className="font-bold mb-2 flex items-center gap-2"><Cloud className="w-4 h-4"/> 开启多设备同步</p>
                            <p className="mb-2">1. 访问 <a href="https://console.firebase.google.com/" target="_blank" className="underline font-bold">Firebase Console</a> 创建项目。</p>
                            <p className="mb-2">2. 创建 Web 应用，复制 <code>firebaseConfig</code> 对象 (包含 apiKey, authDomain 等)。</p>
                            <p>3. 粘贴到下方框中，开启 Auth (Email/Pass) 和 Firestore 数据库。</p>
                        </div>
                        <textarea 
                            className="w-full h-40 bg-gray-100 p-3 rounded-xl text-xs font-mono mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder='{ "apiKey": "AIzaSy...", "authDomain": "...", ... }'
                            value={configStr}
                            onChange={(e) => setConfigStr(e.target.value)}
                        />
                        <button onClick={() => onSave(configStr)} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">保存配置并重启</button>
                    </div>
                </Modal>
            );
        };

        const AuthModal = ({ isOpen, onClose, auth }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                try {
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                    onClose();
                } catch (err) {
                    setError(err.code === 'auth/invalid-email' ? "邮箱格式不正确" : err.code === 'auth/wrong-password' ? "密码错误" : "操作失败，请检查网络或配置");
                } finally { setLoading(false); }
            };

            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={isRegister ? "注册云端账户" : "登录云端账户"}>
                    <div className="p-6">
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">邮箱</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 focus:border-blue-500 outline-none" required /></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">密码</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 focus:border-blue-500 outline-none" required /></div>
                            {error && <div className="text-xs text-red-500 bg-red-50 p-2 rounded">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition flex justify-center">{loading ? <Loader2 className="animate-spin"/> : (isRegister ? "注册" : "登录")}</button>
                        </form>
                        <div className="mt-4 text-center"><button onClick={() => setIsRegister(!isRegister)} className="text-xs text-gray-400 underline">{isRegister ? "已有账号？去登录" : "去注册"}</button></div>
                    </div>
                </Modal>
            );
        };

        // --- Main App Component ---
        function App() {
            const [currentDate, setCurrentDate] = useState(new Date()); 
            const [selectedDateStr, setSelectedDateStr] = useState(generateDateString(new Date())); 
            
            // Initial Config & Firebase
            const [firebaseConfig, setFirebaseConfig] = useState(() => JSON.parse(localStorage.getItem('lifeos_fb_config') || 'null'));
            const [firebaseApp, setFirebaseApp] = useState(null);
            const [firebaseAuth, setFirebaseAuth] = useState(null);
            const [firebaseDb, setFirebaseDb] = useState(null);
            const [user, setUser] = useState(null);
            const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            const isRemoteUpdate = useRef(false);

            // Initialize Firebase if config exists
            useEffect(() => {
                if (firebaseConfig) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        setFirebaseApp(app);
                        setFirebaseAuth(getAuth(app));
                        setFirebaseDb(getFirestore(app));
                    } catch (e) {
                        console.error("Firebase init failed", e);
                        alert("Firebase 配置无效，已重置。请重新输入。");
                        setFirebaseConfig(null);
                        localStorage.removeItem('lifeos_fb_config');
                    }
                }
            }, [firebaseConfig]);

            // Auth Listener
            useEffect(() => {
                if (firebaseAuth) {
                    const unsub = onAuthStateChanged(firebaseAuth, (u) => {
                        setUser(u);
                        if (u) {
                            // On Login: Initial fetch or merge could happen here. 
                            // For simplicity, we just let the snapshot listener take over.
                        }
                    });
                    return unsub;
                }
            }, [firebaseAuth]);

            // State Initialization (Local First)
            const [sections, setSections] = useState(() => JSON.parse(localStorage.getItem('lifeos_sections')) || INITIAL_SECTIONS);
            const [tasksByDate, setTasksByDate] = useState(() => JSON.parse(localStorage.getItem('lifeos_tasks')) || INITIAL_TASKS_BY_DATE);
            const [reviews, setReviews] = useState(() => JSON.parse(localStorage.getItem('lifeos_reviews')) || {});
            const [globalTheme, setGlobalTheme] = useState(() => JSON.parse(localStorage.getItem('lifeos_theme')) || { pageBg: 'gray', headerBg: 'white', cardStyle: 'default' });

            // Firestore Listener (Cloud Load)
            useEffect(() => {
                if (user && firebaseDb) {
                    const docRef = doc(firebaseDb, 'users', user.uid, 'data', 'main');
                    const unsub = onSnapshot(docRef, (snap) => {
                        if (snap.exists()) {
                            const data = snap.data();
                            isRemoteUpdate.current = true; // Mark as remote update to prevent loop
                            if (data.sections) setSections(data.sections);
                            if (data.tasksByDate) setTasksByDate(data.tasksByDate);
                            if (data.reviews) setReviews(data.reviews);
                            if (data.globalTheme) setGlobalTheme(data.globalTheme);
                            setTimeout(() => { isRemoteUpdate.current = false; }, 100);
                        } else {
                            // First time login with no data: Upload local data
                            setDoc(docRef, { sections, tasksByDate, reviews, globalTheme });
                        }
                    });
                    return unsub;
                }
            }, [user, firebaseDb]);

            // Local Persist & Cloud Save
            const saveData = (key, val) => {
                // Always save locally
                localStorage.setItem(key, JSON.stringify(val));
                
                // If logged in and not a remote update, save to cloud
                if (user && firebaseDb && !isRemoteUpdate.current) {
                    const docRef = doc(firebaseDb, 'users', user.uid, 'data', 'main');
                    // We use merge: true to update fields individually if needed, 
                    // but here we are mapping state keys directly.
                    // To avoid overwriting everything with stale data, we construct the update object.
                    let updateObj = {};
                    if (key === 'lifeos_sections') updateObj.sections = val;
                    if (key === 'lifeos_tasks') updateObj.tasksByDate = val;
                    if (key === 'lifeos_reviews') updateObj.reviews = val;
                    if (key === 'lifeos_theme') updateObj.globalTheme = val;
                    setDoc(docRef, updateObj, { merge: true }).catch(e => console.error("Save failed", e));
                }
            };

            // Wrapped Setters
            useEffect(() => saveData('lifeos_sections', sections), [sections]);
            useEffect(() => saveData('lifeos_tasks', tasksByDate), [tasksByDate]);
            useEffect(() => saveData('lifeos_reviews', reviews), [reviews]);
            useEffect(() => saveData('lifeos_theme', globalTheme), [globalTheme]);

            const handleSaveConfig = (jsonStr) => {
                try {
                    const config = JSON.parse(jsonStr);
                    localStorage.setItem('lifeos_fb_config', JSON.stringify(config));
                    setFirebaseConfig(config);
                    setIsConfigModalOpen(false);
                } catch (e) { alert("配置格式错误 (必须是 JSON)"); }
            };

            const handleLogout = async () => {
                if (confirm("确定要退出登录吗？数据将保留在本地。")) {
                    await signOut(firebaseAuth);
                }
            };

            const exportData = () => {
                const dataStr = JSON.stringify({ sections, tasksByDate, reviews, globalTheme }, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `lifeos_backup_${generateDateString(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm("这将覆盖当前数据，确定导入吗？")) {
                            if (data.sections) setSections(data.sections);
                            if (data.tasksByDate) setTasksByDate(data.tasksByDate);
                            if (data.reviews) setReviews(data.reviews);
                            if (data.globalTheme) setGlobalTheme(data.globalTheme);
                            alert("导入成功！");
                        }
                    } catch (e) { alert("文件格式错误"); }
                };
                reader.readAsText(file);
            };

            // --- Regular App State ---
            const [quote, setQuote] = useState(() => GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]);
            const [reviewDate, setReviewDate] = useState(new Date()); 
            
            // UI State
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [isNoteModalOpen, setIsNoteModalOpen] = useState(false); 
            const [currentTask, setCurrentTask] = useState(null); 
            const [targetSection, setTargetSection] = useState(null); 
            const [editingPriority, setEditingPriority] = useState({ important: false, urgent: false });
            const [isSectionManagerOpen, setIsSectionManagerOpen] = useState(false);
            const [isEditSectionMode, setIsEditSectionMode] = useState(false); 
            const [isQuoteEditing, setIsQuoteEditing] = useState(false);
            const [recurrenceType, setRecurrenceType] = useState('none');
            const [settingsTab, setSettingsTab] = useState('sections'); 
            const [isStatsModalOpen, setIsStatsModalOpen] = useState(false);
            const [statsPeriod, setStatsPeriod] = useState(null); 
            const [isReviewCenterOpen, setIsReviewCenterOpen] = useState(false);
            const [reviewTab, setReviewTab] = useState('daily'); 
            const [inputTime, setInputTime] = useState(''); 

            const [isTimerOpen, setIsTimerOpen] = useState(false);
            const [timerActive, setTimerActive] = useState(false);
            const [timerTime, setTimerTime] = useState(25 * 60); 
            const [initialTime, setInitialTime] = useState(25); 
            const [showCelebration, setShowCelebration] = useState(false);
            const [celebrationQuote, setCelebrationQuote] = useState('');

            const calendarDates = useMemo(() => generateCalendarDates(currentDate), [currentDate]);

            // Timer Logic
            useEffect(() => {
                let interval = null;
                if (timerActive && timerTime > 0) {
                    interval = setInterval(() => { setTimerTime((prev) => prev - 1); }, 1000);
                } else if (timerTime === 0 && timerActive) {
                    setTimerActive(false);
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-fairy-message-chime-2022.mp3');
                    audio.play().catch(e => console.log('Audio play failed', e));
                }
                return () => clearInterval(interval);
            }, [timerActive, timerTime]);

            const toggleTimer = () => setTimerActive(!timerActive);
            const resetTimer = () => { setTimerActive(false); setTimerTime(initialTime * 60); };
            const handleTimeChange = (e) => { const m = parseInt(e.target.value) || 0; setInitialTime(m); if (!timerActive) setTimerTime(m * 60); };
            const tasks = useMemo(() => tasksByDate[selectedDateStr] || {}, [tasksByDate, selectedDateStr]);
            
            const handleReviewDateChange = (direction) => { 
                const newDate = new Date(reviewDate); 
                if (reviewTab === 'daily') newDate.setDate(newDate.getDate() + direction);
                else if (reviewTab === 'weekly') newDate.setDate(newDate.getDate() + direction * 7);
                else if (reviewTab === 'monthly') newDate.setMonth(newDate.getMonth() + direction);
                else if (reviewTab === 'yearly') newDate.setFullYear(newDate.getFullYear() + direction);
                setReviewDate(newDate); 
            };

            const statsData = useMemo(() => {
                if (!statsPeriod) return { data: [], totalMins: 0, avgMins: 0, activeDays: 0 };
                let targetDates = []; const y = currentDate.getFullYear(); const m = currentDate.getMonth();
                if (statsPeriod === 'daily') targetDates.push(generateDateString(currentDate));
                else if (statsPeriod === 'weekly') { const { start } = getWeekRange(currentDate); for(let i=0; i<7; i++) { const temp = new Date(start); temp.setDate(start.getDate() + i); targetDates.push(generateDateString(temp)); } }
                else if (statsPeriod === 'monthly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy, dm] = dateStr.split('-').map(Number); if (dy === y && dm === m + 1) targetDates.push(dateStr); }); }
                else if (statsPeriod === 'yearly') { Object.keys(tasksByDate).forEach(dateStr => { const [dy] = dateStr.split('-').map(Number); if (dy === y) targetDates.push(dateStr); }); }
                let tagMap = {}; let totalMins = 0; let activeDays = new Set();
                targetDates.forEach(dateStr => { const dayTasks = tasksByDate[dateStr]; if (!dayTasks) return; let hasCompleted = false; [...sections.map(s => s.id), 'fragmentary'].forEach(sec => { (dayTasks[sec] || []).forEach(task => { if (task.completed) { hasCompleted = true; const tag = task.tag || '未分类'; const mins = task.time ? parseDurationFromTimeStr(task.time) : 30; tagMap[tag] = (tagMap[tag] || 0) + mins; totalMins += mins; } }); }); if (hasCompleted) activeDays.add(dateStr); });
                const colors = ['#fca5a5', '#93c5fd', '#6ee7b7', '#fcd34d', '#c4b5fd', '#f9a8d4', '#818cf8', '#34d399', '#fbbf24', '#f87171'];
                const data = Object.keys(tagMap).map((k, i) => ({ tag: k, value: tagMap[k], color: colors[i % colors.length] })).sort((a,b) => b.value - a.value);
                const avgMins = activeDays.size > 0 ? Math.round(totalMins / activeDays.size) : 0;
                return { data, totalMins, avgMins, activeDays: activeDays.size };
            }, [statsPeriod, currentDate, tasksByDate, sections]);

            const stats = useMemo(() => {
                let impUrg = 0, impNotUrg = 0, urgNotImp = 0, notUrgNotImp = 0; 
                const allSectionTasks = sections.flatMap(sec => tasks[sec.id] || []);
                const fragTasks = tasks.fragmentary || [];
                [...allSectionTasks, ...fragTasks].forEach(t => { if (t.important && t.urgent) impUrg++; else if (t.important) impNotUrg++; else if (t.urgent) urgNotImp++; else notUrgNotImp++; });
                return { impUrg, impNotUrg, urgNotImp, notUrgNotImp, total: allSectionTasks.length + fragTasks.length };
            }, [tasks, sections]);

            const dailyProgress = useMemo(() => {
                const allSectionTasks = sections.flatMap(sec => tasks[sec.id] || []);
                if (allSectionTasks.length === 0) return 0;
                return Math.round((allSectionTasks.filter(t => t.completed).length / allSectionTasks.length) * 100);
            }, [tasks, sections]);

            const handleDateSelect = (dateObj) => { setCurrentDate(dateObj); setSelectedDateStr(generateDateString(dateObj)); };
            const handleDatePickerChange = (e) => { if (e.target.value) { const [y, m, d] = e.target.value.split('-').map(Number); handleDateSelect(new Date(y, m - 1, d)); } };
            const handleBackToToday = () => { const today = new Date(); setCurrentDate(today); setSelectedDateStr(generateDateString(today)); };
            
            const handleToggleTask = (id) => { 
                setTasksByDate(prev => { 
                    const d = { ...(prev[selectedDateStr] || {}) }; 
                    let s = null; 
                    for (const k of [...sections.map(x => x.id), 'fragmentary']) { if (d[k]?.some(t => t.id === id)) { s = k; break; } } 
                    if (s) { 
                        const newTasks = d[s].map(t => t.id === id ? { ...t, completed: !t.completed } : t); d[s] = newTasks;
                        const allDayTasks = []; [...sections.map(sec => sec.id), 'fragmentary'].forEach(secId => { allDayTasks.push(...(secId === s ? newTasks : (d[secId] || []))); });
                        const total = allDayTasks.length; const completed = allDayTasks.filter(t => t.completed).length;
                        if (total > 0 && completed === total) { setCelebrationQuote(GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]); setShowCelebration(true); }
                    } return { ...prev, [selectedDateStr]: d }; 
                }); 
            };
            
            const handleEditTask = (task, sectionId) => { setCurrentTask({ ...task, sectionId }); setTargetSection(sectionId); setEditingPriority({ important: task.important, urgent: task.urgent }); setInputTime(task.time || ''); setRecurrenceType('none'); setIsTaskModalOpen(true); };
            const handleAddTask = (sectionId) => { setCurrentTask(null); setTargetSection(sectionId); setEditingPriority({ important: false, urgent: false }); setInputTime(''); setRecurrenceType('none'); setIsTaskModalOpen(true); };
            const handleOpenNote = (task) => { let s = null; const d = tasksByDate[selectedDateStr] || {}; for (const k of [...sections.map(x => x.id), 'fragmentary']) { if (d[k]?.some(t => t.id === task.id)) { s = k; break; } } setCurrentTask({ ...task, sectionId: s }); setIsNoteModalOpen(true); };
            const saveNote = (e) => { e.preventDefault(); const n = new FormData(e.target).get('note'); setTasksByDate(p => { const ns = { ...p }; const s = currentTask.sectionId; if (ns[selectedDateStr]?.[s]) { ns[selectedDateStr][s] = ns[selectedDateStr][s].map(t => t.id === currentTask.id ? { ...t, note: n } : t); } return ns; }); setIsNoteModalOpen(false); };
            const saveTask = (e) => { 
                e.preventDefault(); const f = new FormData(e.target); const isNew = !currentTask; const id = currentTask ? currentTask.id : Date.now(); const recurrence = f.get('recurrence'); 
                const baseTask = { title: f.get('title'), time: inputTime, tag: f.get('tag'), note: currentTask?.note || '', important: editingPriority.important, urgent: editingPriority.urgent, completed: currentTask?.completed || false, recurring: recurrence !== 'none' };
                setTasksByDate(prev => { 
                    const newMap = { ...prev };
                    const addToDate = (dateStr, taskToAdd, isFutureSync = false) => { 
                        if (!newMap[dateStr]) newMap[dateStr] = {}; const dateTasks = { ...newMap[dateStr] }; const sectionTasks = [...(dateTasks[targetSection] || [])]; 
                        if (isNew && !isFutureSync) { sectionTasks.push({ ...taskToAdd, id: Date.now() + Math.random() }); } else { 
                            const idx = sectionTasks.findIndex(t => t.id === id); 
                            if (idx > -1 && !isFutureSync) { sectionTasks[idx] = { ...taskToAdd, id }; } 
                            else if (isFutureSync) { const dupIdx = sectionTasks.findIndex(t => t.title === taskToAdd.title && t.time === taskToAdd.time); if (dupIdx > -1) { sectionTasks[dupIdx] = { ...taskToAdd, id: sectionTasks[dupIdx].id }; } else { sectionTasks.push({ ...taskToAdd, id: Date.now() + Math.random() }); } }
                        } 
                        dateTasks[targetSection] = sectionTasks; newMap[dateStr] = dateTasks; 
                    };
                    addToDate(selectedDateStr, baseTask, false);
                    if (recurrence !== 'none') { const startDate = new Date(currentDate); const customDays = f.getAll('customDays').map(Number); for (let i = 1; i <= 30; i++) { const nextDate = new Date(startDate); nextDate.setDate(startDate.getDate() + i); let shouldAdd = false; if (recurrence === 'daily') shouldAdd = true; else if (recurrence === 'custom') { if (customDays.includes(nextDate.getDay())) shouldAdd = true; } if (shouldAdd) { addToDate(generateDateString(nextDate), { ...baseTask, completed: false }, true); } } }
                    return newMap; 
                }); setIsTaskModalOpen(false); 
            };
            const handleDeleteTaskDirectly = (id, s) => { setTasksByDate(prev => { const newDateMap = { ...prev }; const dateData = { ...(newDateMap[selectedDateStr] || {}) }; if (dateData[s]) { dateData[s] = dateData[s].filter(t => t.id !== id); newDateMap[selectedDateStr] = dateData; } return newDateMap; }); };
            const handleSaveSection = (e) => { e.preventDefault(); const f = new FormData(e.target); const s = { id: f.get('id') || `sec_${Date.now()}`, title: f.get('title'), icon: f.get('icon'), color: f.get('color') }; if (f.get('isNew') === 'true') setSections([...sections, s]); else setSections(sections.map(x => x.id === s.id ? s : x)); setIsEditSectionMode(false); };
            const handleDeleteSection = (id) => { if (confirm('确认删除?')) { setSections(sections.filter(s => s.id !== id)); setIsEditSectionMode(false); } };
            const handleTaskRemind = (task) => { downloadICS([task], selectedDateStr, "Task"); };
            const refreshQuote = () => { setQuote(GROWTH_QUOTES[Math.floor(Math.random() * GROWTH_QUOTES.length)]); };
            const openStats = (period) => { setStatsPeriod(period); setIsStatsModalOpen(true); };
            const openReviewCenter = (tab) => { setReviewTab(tab); setReviewDate(currentDate); setIsReviewCenterOpen(true); };

            return (
                <div className={`min-h-screen font-sans text-slate-800 pb-20 selection:bg-blue-100 ${PALETTE[globalTheme.pageBg]?.bg || 'bg-[#F5F7FA]'}`}>
                    
                    {/* Header */}
                    <div className={`sticky top-0 z-50 shadow-md rounded-b-3xl mb-6 transition-all ${PALETTE[globalTheme.headerBg]?.bg || 'bg-white'}`}>
                        <header className="px-6 pt-6 pb-2">
                            <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                <div className="flex items-center gap-3 shrink-0 w-full md:w-auto justify-between md:justify-start">
                                    <div className="flex items-center gap-2">
                                        <div className="relative group">
                                            <div className="flex items-center gap-1 text-2xl font-bold text-slate-800 cursor-pointer hover:text-blue-600 transition-colors" title="选择日期">{currentDate.getFullYear()}.{currentDate.getMonth() + 1}</div>
                                            <input type="date" className="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10" onChange={handleDatePickerChange} />
                                        </div>
                                        {selectedDateStr !== generateDateString(new Date()) && (<button onClick={handleBackToToday} className="px-3 py-1.5 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg hover:bg-blue-100 flex items-center gap-1 shadow-sm transition-all z-20 active:scale-95"><RotateCcw className="w-3.5 h-3.5" />回到今天</button>)}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => { if (!user) setIsConfigModalOpen(true); else setIsAuthModalOpen(true); }} className="md:hidden flex items-center gap-1 text-[10px] px-2 py-1.5 rounded-full bg-blue-50 border border-blue-100 text-blue-600"><Cloud className="w-3 h-3" /></button>
                                        <button onClick={(e) => { e.stopPropagation(); openReviewCenter('daily'); }} className="md:hidden bg-[#1E293B] text-white px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1 hover:bg-slate-700 transition active:scale-95 shadow-lg shadow-slate-200 whitespace-nowrap"><LayoutGrid className="w-3 h-3" /> 复盘</button>
                                    </div>
                                </div>

                                <div className="flex-1 flex justify-center w-full md:w-auto order-last md:order-none">
                                    <div className="flex items-center gap-2 group cursor-pointer transition-all hover:scale-105 px-4 py-1 rounded-xl hover:bg-gray-50/50" onClick={() => !isQuoteEditing && setIsQuoteEditing(true)}>
                                        <span className="hidden lg:flex bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-0.5 rounded-full items-center gap-1 shrink-0 shadow-sm border border-orange-200">🔥 3 天</span>
                                        {isQuoteEditing ? (<input autoFocus className="text-sm font-serif font-medium text-gray-700 border-b-2 border-blue-500 outline-none text-center min-w-[200px] bg-transparent" value={quote} onChange={(e) => setQuote(e.target.value)} onBlur={() => setIsQuoteEditing(false)} onKeyDown={(e) => e.key === 'Enter' && setIsQuoteEditing(false)} />) : (<div className="flex items-center gap-2"><p className="text-slate-600 text-sm md:text-base font-serif font-medium hover:text-blue-600 transition-colors text-center italic truncate max-w-[240px] md:max-w-md" title="点击编辑语录">“{quote}”</p><button onClick={(e) => { e.stopPropagation(); refreshQuote(); }} className="text-gray-300 hover:text-blue-500 transition-colors shrink-0 p-1 rounded-full hover:bg-gray-100" title="随机切换"><Shuffle className="w-3 h-3" /></button></div>)}
                                    </div>
                                </div>

                                <div className="hidden md:flex items-center gap-3 shrink-0">
                                    <div className="flex items-center gap-2">
                                        <button onClick={exportData} title="导出数据 (JSON)" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition"><Download className="w-4 h-4"/></button>
                                        <label title="导入数据" className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition cursor-pointer"><Upload className="w-4 h-4"/><input type="file" className="hidden" accept=".json" onChange={importData}/></label>
                                    </div>
                                    <div className="h-4 w-px bg-gray-200"></div>
                                    
                                    {!firebaseConfig ? (
                                        <button onClick={() => setIsConfigModalOpen(true)} className="text-[10px] bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full border border-gray-200 flex items-center gap-1 hover:bg-gray-200 transition"><Cloud className="w-3 h-3"/> 连接云端</button>
                                    ) : !user ? (
                                        <button onClick={() => setIsAuthModalOpen(true)} className="text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full border border-blue-200 flex items-center gap-1 hover:bg-blue-100 transition"><LogIn className="w-3 h-3"/> 登录同步</button>
                                    ) : (
                                        <button onClick={handleLogout} className="text-[10px] bg-green-50 text-green-600 px-3 py-1.5 rounded-full border border-green-200 flex items-center gap-1 hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition group"><User className="w-3 h-3"/> {user.email.split('@')[0]} <LogOut className="w-3 h-3 hidden group-hover:block ml-1"/></button>
                                    )}
                                    
                                    <button onClick={(e) => { e.stopPropagation(); openReviewCenter('daily'); }} className="bg-[#1E293B] text-white px-5 py-2 rounded-full text-xs font-bold flex items-center gap-2 hover:bg-slate-700 transition active:scale-95 shadow-lg shadow-slate-200 whitespace-nowrap"><LayoutGrid className="w-4 h-4" /> 复盘/目标</button>
                                </div>
                            </div>
                        </header>
                        
                        <div className="pb-4 px-2">
                            <div className="flex justify-between items-center px-2">
                                <button onClick={() => handleDateSelect(new Date(currentDate.setDate(currentDate.getDate() - 1)))} className="p-2 text-gray-300 hover:text-gray-600"><ChevronLeft className="w-4 h-4" /></button>
                                <div className="flex-1 flex justify-between px-2 overflow-x-auto overflow-y-hidden scrollbar-hide">
                                    {calendarDates.map((d, i) => { const isActive = d.fullDate === selectedDateStr; return (<div key={i} onClick={() => handleDateSelect(d.obj)} className={`flex flex-col items-center justify-center min-w-[40px] h-14 rounded-xl cursor-pointer transition-all mx-1 ${isActive ? 'bg-blue-600 text-white shadow-lg shadow-blue-200 scale-105' : 'text-gray-400 hover:bg-gray-50'}`}><span className="text-[10px] mb-1 opacity-80">{d.dayName}</span><span className="text-lg font-bold">{d.dateNum}</span></div>); })}
                                </div>
                                <button onClick={() => handleDateSelect(new Date(currentDate.setDate(currentDate.getDate() + 1)))} className="p-2 text-gray-300 hover:text-gray-600"><ChevronRight className="w-4 h-4" /></button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto px-4 md:px-6">
                        <div className="bg-white rounded-xl p-4 shadow-sm mb-6 flex justify-between items-center relative z-10">
                            <div className="flex gap-4 md:gap-16 overflow-x-auto scrollbar-hide w-full md:w-auto">
                                <CircularProgress onClick={() => openStats('daily')} percentage={dailyProgress} label="今日" subLabel="已完成" colorClass="text-blue-400" trackClass="text-blue-50" />
                                <CircularProgress onClick={() => openStats('weekly')} percentage={50} label="本周" subLabel="数据中" colorClass="text-indigo-400" trackClass="text-indigo-50" />
                                <CircularProgress onClick={() => openStats('monthly')} percentage={30} label="本月" subLabel="进行中" colorClass="text-orange-400" trackClass="text-orange-50" />
                                <CircularProgress onClick={() => openStats('yearly')} percentage={10} label="年度" subLabel="积累中" colorClass="text-red-400" trackClass="text-red-50" />
                            </div>
                            <div className="flex flex-col items-center cursor-pointer group ml-4 shrink-0" onClick={() => setIsTimerOpen(true)}>
                                <button className={`bg-slate-100 rounded-full p-2 mb-1 relative transition-all group-hover:bg-slate-200 ${timerActive ? 'ring-2 ring-red-300 animate-pulse' : ''}`}><div className="text-xs font-bold text-slate-700 min-w-[32px] text-center">{timerActive ? formatTime(timerTime) : `${initialTime}:00`}</div><span className="absolute -top-1 -right-1 text-lg">🍅</span></button><div className="text-[10px] text-gray-400 group-hover:text-red-500">专注</div>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-4 gap-2 mb-6">
                            <StatCard number={stats.impUrg} title="重要紧急" subText={`${Math.round(stats.impUrg/stats.total*100) || 0}%`} colorTheme="red" />
                            <StatCard number={stats.impNotUrg} title="重要不急" subText={`${Math.round(stats.impNotUrg/stats.total*100) || 0}%`} colorTheme="orange" />
                            <StatCard number={stats.urgNotImp} title="紧急不重" subText={`${Math.round(stats.urgNotImp/stats.total*100) || 0}%`} colorTheme="blue" />
                            <StatCard number={stats.notUrgNotImp} title="不急不重" subText={`${Math.round(stats.notUrgNotImp/stats.total*100) || 0}%`} colorTheme="green" />
                        </div>

                        <div className="flex justify-between items-center mb-4 px-1 mt-2">
                            <div className="flex items-center gap-2"><div className="w-1.5 h-6 bg-blue-600 rounded-full"></div><h3 className="font-extrabold text-slate-800 text-2xl tracking-tight">我的任务看板</h3></div>
                            <button onClick={() => setIsSectionManagerOpen(true)} className="text-xs flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-gray-200 bg-white text-gray-600 hover:border-blue-300 hover:bg-blue-50 hover:text-blue-600 transition-all shadow-sm active:scale-95" title="管理任务板块与外观"><Settings2 className="w-3.5 h-3.5" /><span className="font-bold">板块管理</span></button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            {sections.map(section => (
                                <div key={section.id}>
                                    <div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2"><React.Fragment>{React.createElement(ICON_MAP[section.icon] || Circle, { className: `w-5 h-5 ${COLOR_THEMES[section.color]?.icon || 'text-gray-400'} fill-current` })}</React.Fragment><h2 className={`font-bold text-lg ${COLOR_THEMES[section.color]?.text || 'text-gray-700'}`}>{section.title}</h2></div><button onClick={() => downloadICS(tasks[section.id], selectedDateStr, section.title)} className={`text-xs px-3 py-1.5 rounded-full flex items-center gap-1 transition-colors ${COLOR_THEMES[section.color]?.bg || 'bg-gray-100'} ${COLOR_THEMES[section.color]?.text || 'text-gray-600'} ${COLOR_THEMES[section.color]?.buttonBg || 'hover:bg-gray-200'}`}><Bell className="w-3 h-3" /> 提醒</button></div>
                                    <div className={`space-y-3 min-h-[50px] p-3 rounded-xl border border-dashed ${COLOR_THEMES[section.color]?.border || 'border-gray-200'} ${COLOR_THEMES[section.color]?.bg || 'bg-gray-50'} bg-opacity-30`}>{tasks[section.id]?.length === 0 && <div className="text-center py-4 text-gray-400 text-xs">本日暂无安排</div>}{tasks[section.id]?.map(task => (<TaskCard key={task.id} task={task} onToggle={handleToggleTask} onEdit={(t) => handleEditTask(t, section.id)} onDelete={(id) => handleDeleteTaskDirectly(id, section.id)} onNote={handleOpenNote} onRemind={handleTaskRemind} cardStyle={globalTheme.cardStyle} sectionColor={section.color} />))}</div>
                                    <button onClick={() => handleAddTask(section.id)} className={`w-full py-3 mt-3 rounded-xl border-2 border-dashed ${COLOR_THEMES[section.color]?.border || 'border-gray-300'} ${COLOR_THEMES[section.color]?.text || 'text-gray-500'} flex items-center justify-center hover:${COLOR_THEMES[section.color]?.bg || 'bg-gray-100'} transition-colors group`}><Plus className="w-5 h-5 group-hover:scale-110 transition-transform" /></button>
                                </div>
                            ))}
                        </div>

                        <div className="bg-white rounded-xl p-4 shadow-sm mb-8">
                            <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-3"><span className="bg-yellow-100 text-yellow-600 text-xs font-bold px-2 py-1 rounded">TODO</span><span className="font-bold text-slate-700">碎片清单</span></div><button onClick={() => handleAddTask('fragmentary')} className="px-3 py-1.5 bg-blue-50 text-blue-600 text-xs rounded hover:bg-blue-100 transition flex items-center gap-1"><Plus className="w-3 h-3" /> 添加</button></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">{tasks.fragmentary?.map(task => (<div key={task.id} onClick={() => handleToggleTask(task.id)} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition group"><div className="flex items-center gap-3"><button onClick={(e) => { e.stopPropagation(); handleToggleTask(task.id); }} className="text-gray-300 hover:text-indigo-500 flex-shrink-0">{task.completed ? <CheckCircle2 className="w-5 h-5 text-indigo-500" /> : <Circle className="w-5 h-5" />}</button><span className={`text-sm text-gray-700 ${task.completed ? 'line-through text-gray-400' : ''}`}>{task.title}</span></div><div className="flex items-center gap-1"><button onClick={(e) => { e.stopPropagation(); handleEditTask(task, 'fragmentary'); }} className="p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded transition"><Edit3 className="w-3.5 h-3.5" /></button><button onClick={(e) => { e.stopPropagation(); handleDeleteTaskDirectly(task.id, 'fragmentary'); }} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition"><Trash2 className="w-3.5 h-3.5" /></button></div></div>))}</div>
                        </div>
                    </div>

                    {/* Modals */}
                    <Modal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} title={currentTask ? "编辑任务" : "添加新任务"}>
                        <form onSubmit={saveTask} className="flex flex-col gap-5 p-1">
                            <div><label className="block text-xs font-bold text-gray-500 mb-1.5">任务名称</label><input name="title" defaultValue={currentTask?.title} placeholder="例如：阅读30分钟" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" required autoFocus /></div>
                            <div className="flex items-end gap-4"><div className="flex-1"><label className="block text-xs font-bold text-gray-500 mb-1.5">时间段</label><TimeRangePicker value={inputTime} onChange={setInputTime} key={currentTask?.id || 'new'} /></div><div className="w-24 shrink-0"><label className="block text-xs font-bold text-gray-500 mb-1.5">标签</label><input list="tag-suggestions" name="tag" defaultValue={currentTask?.tag} placeholder="如: 工作" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-2 py-2.5 text-xs text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" /><datalist id="tag-suggestions"><option value="工作" /><option value="学习" /><option value="生活" /><option value="运动" /></datalist></div></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-2">重要/紧急程度</label><div className="flex justify-around bg-gray-50 p-3.5 rounded-xl border border-gray-200"><button type="button" onClick={() => setEditingPriority({ important: true, urgent: true })} className={`flex flex-col items-center gap-1.5 transition-all ${editingPriority.important && editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-indigo-500 ${editingPriority.important && editingPriority.urgent ? 'ring-2 ring-offset-2 ring-indigo-300' : ''}`}></div><span className="text-[10px] font-bold text-indigo-700">重要紧急</span></button><button type="button" onClick={() => setEditingPriority({ important: true, urgent: false })} className={`flex flex-col items-center gap-1.5 transition-all ${editingPriority.important && !editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-blue-500 ${editingPriority.important && !editingPriority.urgent ? 'ring-2 ring-offset-2 ring-blue-300' : ''}`}></div><span className="text-[10px] font-bold text-blue-700">重要不急</span></button><button type="button" onClick={() => setEditingPriority({ important: false, urgent: true })} className={`flex flex-col items-center gap-1.5 transition-all ${!editingPriority.important && editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-red-500 ${!editingPriority.important && editingPriority.urgent ? 'ring-2 ring-offset-2 ring-red-300' : ''}`}></div><span className="text-[10px] font-bold text-red-700">紧急不重</span></button><button type="button" onClick={() => setEditingPriority({ important: false, urgent: false })} className={`flex flex-col items-center gap-1.5 transition-all ${!editingPriority.important && !editingPriority.urgent ? 'scale-110 opacity-100' : 'opacity-50 hover:opacity-100'}`}><div className={`w-5 h-5 rounded-full bg-emerald-500 ${!editingPriority.important && !editingPriority.urgent ? 'ring-2 ring-offset-2 ring-emerald-300' : ''}`}></div><span className="text-[10px] font-bold text-emerald-700">不急不重</span></button></div></div>
                            <div className="bg-blue-50/50 p-3.5 rounded-xl border border-blue-100 flex flex-col gap-3"><div className="flex items-center justify-between"><div className="flex items-center gap-1.5"><Repeat className="w-4 h-4 text-blue-500" /><label className="text-xs font-bold text-blue-700">同步/重复(未来30天)</label></div><div className="flex gap-3 text-xs font-medium text-blue-800"><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="none" checked={recurrenceType === 'none'} onChange={() => setRecurrenceType('none')} className="accent-blue-600" />单次</label><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="daily" checked={recurrenceType === 'daily'} onChange={() => setRecurrenceType('daily')} className="accent-blue-600" />每天</label><label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="recurrence" value="custom" checked={recurrenceType === 'custom'} onChange={() => setRecurrenceType('custom')} className="accent-blue-600" />自定义</label></div></div>{recurrenceType === 'custom' && (<div className="flex justify-between mt-1 px-2">{['日', '一', '二', '三', '四', '五', '六'].map((d, i) => (<label key={i} className="flex flex-col items-center cursor-pointer group"><input type="checkbox" name="customDays" value={i} className="peer sr-only" /><div className="w-7 h-7 rounded-full bg-white border border-blue-200 flex items-center justify-center text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all group-hover:border-blue-400">{d}</div></label>))}</div>)}</div>
                            <div className="flex gap-3 mt-2"><button type="button" onClick={() => setIsTaskModalOpen(false)} className="px-5 py-2.5 text-gray-500 text-sm bg-gray-100 hover:bg-gray-200 rounded-xl transition font-bold">取消</button><button type="submit" className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-md shadow-blue-200"><Save className="w-4 h-4" /> 保存</button></div>
                        </form>
                    </Modal>
                    
                    <Modal isOpen={isNoteModalOpen} onClose={() => setIsNoteModalOpen(false)} title="添加/编辑备注">
                        <form onSubmit={saveNote} className="flex flex-col gap-4">
                            <div className="bg-yellow-50 p-3 rounded-lg mb-2"><h4 className="text-sm font-bold text-gray-800 mb-1">{currentTask?.title}</h4><p className="text-xs text-gray-500">在这个任务中记录想法或细节...</p></div>
                            <textarea name="note" defaultValue={currentTask?.note} placeholder="例如：会议纪要、阅读笔记、购物清单..." className="w-full h-32 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" autoFocus />
                            <div className="flex justify-end gap-3 mt-2"><button type="button" onClick={() => setIsNoteModalOpen(false)} className="px-4 py-2 text-gray-500 text-sm hover:bg-gray-100 rounded-lg transition">取消</button><button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition flex items-center gap-2"><Save className="w-4 h-4" /> 保存备注</button></div>
                        </form>
                    </Modal>

                    <Modal isOpen={isSectionManagerOpen} onClose={() => {setIsSectionManagerOpen(false); setIsEditSectionMode(false); setSettingsTab('sections')}} title="自定义板块管理">
                        <div className="flex flex-col h-full"><div className="flex border-b border-gray-100 mb-4"><button onClick={() => setSettingsTab('sections')} className={`flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'sections' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400'}`}>板块管理</button><button onClick={() => setSettingsTab('appearance')} className={`flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${settingsTab === 'appearance' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400'}`}>外观设置</button></div>{settingsTab === 'sections' && (<div className="space-y-4">{!isEditSectionMode ? (<><button onClick={() => setIsEditSectionMode({ isNew: true })} className="w-full py-2 bg-blue-50 text-blue-600 rounded-lg mb-2 font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition"><Plus className="w-4 h-4"/> 新增板块</button>{sections.map(s => <div key={s.id} className="flex justify-between p-3 border border-gray-100 rounded-xl items-center bg-gray-50 hover:bg-white hover:shadow-sm transition"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-lg flex items-center justify-center ${COLOR_THEMES[s.color]?.bg || 'bg-gray-200'} ${COLOR_THEMES[s.color]?.text || 'text-gray-700'}`}>{React.createElement(ICON_MAP[s.icon] || Circle, { className: "w-5 h-5" })}</div><span className="font-bold text-slate-700">{s.title}</span></div><div className="flex gap-2"><button onClick={() => setIsEditSectionMode(s)} className="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition"><Edit3 className="w-4 h-4" /></button><button onClick={() => handleDeleteSection(s.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"><Trash2 className="w-4 h-4" /></button></div></div>)}</>) : (<form onSubmit={handleSaveSection} className="flex flex-col gap-5"><input type="hidden" name="id" value={isEditSectionMode.id || ''} /><input type="hidden" name="isNew" value={isEditSectionMode.isNew ? 'true' : 'false'} /><div><label className="block text-xs font-bold text-gray-500 mb-2">板块名称</label><input name="title" defaultValue={isEditSectionMode.title} placeholder="例如: 晨间阅读" className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div><div><label className="block text-xs font-bold text-gray-500 mb-2">选择图标</label><div className="grid grid-cols-4 gap-2">{Object.keys(ICON_MAP).map(k=><label key={k} className="cursor-pointer"><input type="radio" name="icon" value={k} defaultChecked={isEditSectionMode.icon===k} className="peer sr-only"/><div className="w-full h-12 rounded-xl bg-gray-50 border border-gray-100 flex items-center justify-center text-gray-400 peer-checked:bg-blue-50 peer-checked:border-blue-200 peer-checked:text-blue-600 hover:bg-gray-100 transition">{React.createElement(ICON_MAP[k], { className: "w-5 h-5" })}</div></label>)}</div></div><div><label className="block text-xs font-bold text-gray-500 mb-3">主题色系</label><div className="grid grid-cols-4 gap-3">{Object.keys(COLOR_THEMES).map(k=>(<label key={k} className="cursor-pointer flex flex-col items-center gap-1 group"><input type="radio" name="color" value={k} defaultChecked={isEditSectionMode.color===k} className="peer sr-only"/><div className={`w-10 h-10 rounded-full shadow-sm border-2 border-white transition-all peer-checked:scale-110 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-gray-300 ${COLOR_THEMES[k].preview} group-hover:scale-105`}></div><span className="text-[10px] text-gray-400 peer-checked:text-gray-800 font-medium">{COLOR_THEMES[k].label}</span></label>))}</div></div><div className="flex gap-3 pt-2"><button type="button" onClick={() => setIsEditSectionMode(false)} className="flex-1 py-3 text-gray-500 text-sm font-bold hover:bg-gray-100 rounded-xl transition">取消</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200">保存板块</button></div></form>)}</div>)}{settingsTab === 'appearance' && (<div className="space-y-6 pb-4"><div><label className="block text-xs font-bold text-gray-500 mb-3 flex items-center gap-1"><Layout className="w-4 h-4"/> 页面大背景</label><div className="grid grid-cols-3 sm:grid-cols-4 gap-3">{Object.keys(PALETTE).map(key => (<button key={key} onClick={() => setGlobalTheme(prev => ({ ...prev, headerBg: key }))} className={`h-10 rounded-xl border-2 transition-all flex items-center justify-center text-[10px] font-bold ${PALETTE[key].bg} ${PALETTE[key].text} ${globalTheme.headerBg === key ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-200 hover:border-gray-300'}`}>{PALETTE[key].label}</button>))}</div></div><div><label className="block text-xs font-bold text-gray-500 mb-3 flex items-center gap-1"><ListTodo className="w-4 h-4"/> 任务卡片风格</label><div className="flex gap-4"><button onClick={() => setGlobalTheme(prev => ({ ...prev, cardStyle: 'default' }))} className={`flex-1 p-3 rounded-xl border-2 transition-all ${globalTheme.cardStyle === 'default' ? 'border-blue-500 ring-2 ring-blue-200 bg-blue-50' : 'border-gray-200 bg-white hover:bg-gray-50'}`}><div className="bg-white border border-gray-200 rounded-lg p-3 mb-2 shadow-sm"><div className="flex items-center gap-2 mb-2"><div className="w-3 h-3 rounded-full border-2 border-gray-300"></div><div className="w-16 h-2 bg-gray-200 rounded"></div></div><div className="w-24 h-2 bg-gray-100 rounded ml-5"></div></div><div className={`text-sm font-bold text-center ${globalTheme.cardStyle === 'default' ? 'text-blue-700' : 'text-gray-600'}`}>简约白</div></button><button onClick={() => setGlobalTheme(prev => ({ ...prev, cardStyle: 'colored' }))} className={`flex-1 p-3 rounded-xl border-2 transition-all ${globalTheme.cardStyle === 'colored' ? 'border-blue-500 ring-2 ring-blue-200 bg-blue-50' : 'border-gray-200 bg-white hover:bg-gray-50'}`}><div className="bg-orange-50 border border-orange-100 rounded-lg p-3 mb-2 shadow-sm"><div className="flex items-center gap-2 mb-2"><div className="w-3 h-3 rounded-full border-2 border-orange-300"></div><div className="w-16 h-2 bg-orange-300 rounded"></div></div><div className="w-24 h-2 bg-orange-200 rounded ml-5"></div></div><div className={`text-sm font-bold text-center ${globalTheme.cardStyle === 'colored' ? 'text-blue-700' : 'text-gray-600'}`}>跟随色系</div></button></div></div></div>)}</div>
                    </Modal>

                    <Modal isOpen={isReviewCenterOpen} onClose={() => setIsReviewCenterOpen(false)} title="复盘与目标中心" fullScreen>
                        <div className="flex flex-col h-full bg-[#f8fafc]"><div className="flex px-4 pt-4 border-b border-gray-100 bg-white flex-shrink-0 gap-4 overflow-x-auto scrollbar-hide">{['daily', 'weekly', 'monthly', 'yearly'].map(t => (<button key={t} onClick={() => setReviewTab(t)} className={`pb-3 px-1 text-sm font-bold border-b-2 transition-colors whitespace-nowrap ${reviewTab === t ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-400 hover:text-gray-600'}`}>{t === 'daily' ? '每日复盘' : t === 'weekly' ? '周复盘' : t === 'monthly' ? '月度总结' : '年度回顾'}</button>))}</div><div className="bg-white px-4 py-2 border-b border-gray-100 flex items-center justify-between flex-shrink-0 shadow-sm z-10"><button onClick={() => handleReviewDateChange(-1)} className="p-1 hover:bg-gray-100 rounded"><ChevronLeft className="w-5 h-5 text-gray-400"/></button><span className="text-sm font-bold text-slate-700">{getPeriodLabel(reviewTab, reviewDate)}</span><button onClick={() => handleReviewDateChange(1)} className="p-1 hover:bg-gray-100 rounded"><ChevronRight className="w-5 h-5 text-gray-400"/></button></div><div className="flex-1 overflow-y-auto custom-scrollbar">{reviewTab === 'daily' ? (<DailyReviewContent reviewDate={reviewDate} reviews={reviews} setReviews={setReviews} />) : (<PeriodReviewContent period={reviewTab} reviewDate={reviewDate} reviews={reviews} setReviews={setReviews} tasksByDate={tasksByDate} sections={sections} />)}</div></div>
                    </Modal>

                    <Modal isOpen={isStatsModalOpen} onClose={() => setIsStatsModalOpen(false)} title={`${statsPeriod === 'daily' ? '今日' : statsPeriod === 'weekly' ? '本周' : statsPeriod === 'monthly' ? '本月' : '年度'}专注统计`}>
                        <div className="p-4 bg-white min-h-[400px]">{statsData.data.length > 0 ? (<div className="flex flex-col items-center"><AdvancedPieChart data={statsData.data} totalMins={statsData.totalMins} /><div className="mt-8 text-center w-full pt-4 border-t border-gray-100"><p className="text-gray-800 font-bold text-lg mb-1">总计 {Math.floor(statsData.totalMins / 60)} 小时 {statsData.totalMins % 60} 分钟{statsPeriod !== 'daily' && ` 日均 ${statsData.avgMins} 分钟`}</p><p className="text-gray-400 text-xs mt-2">基于 {statsData.activeDays} 天的打卡数据计算</p></div></div>) : (<div className="flex flex-col items-center justify-center h-64 text-center"><div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4"><PieChart className="w-8 h-8 text-gray-300" /></div><p className="text-gray-500 font-medium">当前时间段还没有完成的任务哦~</p><p className="text-xs text-gray-400 mt-2">快去勾选完成任务来生成时间统计图吧！</p></div>)}</div>
                    </Modal>

                    <Modal isOpen={isTimerOpen} onClose={() => setIsTimerOpen(false)} title="专注番茄钟">
                        <div className="flex flex-col items-center justify-center p-4"><div className="relative w-48 h-48 mb-6"><svg className="w-full h-full transform -rotate-90"><circle cx="96" cy="96" r="88" stroke="#f1f5f9" strokeWidth="12" fill="transparent" /><circle cx="96" cy="96" r="88" stroke="#f87171" strokeWidth="12" fill="transparent" strokeDasharray={2 * Math.PI * 88} strokeDashoffset={(2 * Math.PI * 88) * (1 - timerTime / (initialTime * 60))} strokeLinecap="round" className="transition-all duration-1000 ease-linear" /></svg><div className="absolute inset-0 flex items-center justify-center text-4xl font-bold text-slate-700">{formatTime(timerTime)}</div></div><div className="flex gap-4 items-center mb-6"><button onClick={toggleTimer} className={`p-4 rounded-full text-white shadow-lg transition-transform active:scale-95 ${timerActive ? 'bg-orange-400' : 'bg-green-500'}`}>{timerActive ? <Pause className="w-8 h-8 fill-current" /> : <Play className="w-8 h-8 fill-current ml-1" />}</button><button onClick={resetTimer} className="p-4 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors" title="重置"><RotateCcw className="w-6 h-6" /></button></div><div className="w-full bg-gray-50 p-4 rounded-xl border border-gray-100"><label className="block text-xs font-bold text-gray-500 mb-2 flex items-center gap-1"><Timer className="w-3 h-3" /> 设置时长 (分钟)</label><div className="flex gap-2">{[25, 30, 45, 60].map(mins => (<button key={mins} onClick={() => { setInitialTime(mins); setTimerTime(mins * 60); setTimerActive(false); }} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-colors ${initialTime === mins ? 'bg-white text-blue-600 shadow-sm border border-blue-100' : 'text-gray-400 hover:text-gray-600'}`}>{mins}</button>))}</div><input type="range" min="1" max="120" value={initialTime} onChange={handleTimeChange} className="w-full mt-4 accent-red-400" /></div></div>
                    </Modal>

                    <Modal isOpen={showCelebration} onClose={() => setShowCelebration(false)} title="🎉 每日目标达成！">
                        <div className="p-6 flex flex-col items-center justify-center text-center"><WateringAnimation /><h3 className="text-xl font-bold text-slate-800 mt-6 mb-3">你真棒！</h3><p className="text-slate-600 text-sm leading-relaxed max-w-xs mx-auto italic">"{celebrationQuote}"</p><button onClick={() => setShowCelebration(false)} className="mt-8 px-6 py-2 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-full font-bold shadow-lg shadow-pink-200 hover:scale-105 transition-transform">继续保持 💪</button></div>
                    </Modal>

                    {/* New Modals for Cloud Sync */}
                    <ConfigModal isOpen={isConfigModalOpen} onClose={() => setIsConfigModalOpen(false)} onSave={handleSaveConfig} />
                    <AuthModal isOpen={isAuthModalOpen} onClose={() => setIsAuthModalOpen(false)} auth={firebaseAuth} />

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
